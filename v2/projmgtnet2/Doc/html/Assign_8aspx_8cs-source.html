<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>PMT: Assign.aspx.cs Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.1 -->
<h1>Assign.aspx.cs</h1><div class="fragment"><pre>00001 <span class="keyword">using</span> System;
00002 <span class="keyword">using</span> System.Collections;
00003 <span class="keyword">using</span> System.ComponentModel;
00004 <span class="keyword">using</span> System.Data;
00005 <span class="keyword">using</span> System.Drawing;
00006 <span class="keyword">using</span> System.Web;
00007 <span class="keyword">using</span> System.Web.SessionState;
00008 <span class="keyword">using</span> System.Web.UI;
00009 <span class="keyword">using</span> System.Web.UI.WebControls;
00010 <span class="keyword">using</span> System.Web.UI.HtmlControls;
00011 <span class="keyword">using</span> PMTComponents;
00012 <span class="keyword">using</span> PMTDataProvider;
00013 
00014 <span class="keyword">namespace </span>PMT.PM
00015 {
<a name="l00019"></a><a class="code" href="classPMT_1_1PM_1_1Assign.html">00019</a>     <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="classPMT_1_1PM_1_1Assign.html">Assign</a> : Page
00020     {
00021         <span class="keyword">protected</span> Label AvailDevLabel;
00022         <span class="keyword">protected</span> Panel AvailableDevPanel;
00023         <span class="keyword">protected</span> Panel AssignmentsPanel;
00024         <span class="keyword">protected</span> Button UpdateButton;
00025         <span class="keyword">protected</span> Button CommitButton;
00026         <span class="keyword">protected</span> Button CancelButton;
00027         <span class="keyword">protected</span> Label ErrorLabel;
00028         <span class="keyword">protected</span> TextBox ThresholdTextBox;
00029         <span class="keyword">protected</span> DataGrid dgAvailableDevs;
00030         <span class="keyword">protected</span> DataGrid dgAssignments;
00031         <span class="keyword">protected</span> RegularExpressionValidator ThreshholdTextBoxRegularExpressionValidator;
00032 
00033     
00034         <span class="keyword">private</span> <span class="keywordtype">void</span> Page_Load(object sender, System.EventArgs e)
00035         {
00036             <span class="keywordflow">if</span> (TaskID != -1)
00037                 AvailDevLabel.Text = <span class="stringliteral">"Choose Developer to be assigned to Task "</span> + TaskID;
00038 
00039             <span class="keywordflow">if</span> (!IsPostBack)
00040                 BindData();
00041 
00042             <span class="comment">// fill available developers data grid</span>
00043             <span class="comment">//TODO: FINISH THIS</span>
00044 
00045             <span class="comment">//          int Threshold = Convert.ToInt32(ThresholdTextBox.Text);</span>
00046 
00047             <span class="comment">/*</span>
00048 <span class="comment">            DBDriver myDB = new DBDriver();</span>
00049 <span class="comment">            string s = "select p.ID as ID, p.lastName as lastName, p.firstName as firstName,\n"</span>
00050 <span class="comment">                + "u.username as username, c.competence as competence, count(a.devID) as taskCount\n"</span>
00051 <span class="comment">                + "from person p, compLevels c, assignments a, users u\n"</span>
00052 <span class="comment">                + "where p.ID = u.ID\n"</span>
00053 <span class="comment">                + "and u.security = 'Developer'\n"</span>
00054 <span class="comment">                + "and p.ID = a.devID\n"</span>
00055 <span class="comment">                + "and p.ID = c.ID\n"</span>
00056 <span class="comment">                + "group by p.ID, p.lastName, p.firstName, u.userName, c.competence\n"</span>
00057 <span class="comment">                + "having count(a.devID) &lt; 10"  // set to 10 for testing</span>
00058 <span class="comment">                + "order by p.lastName;";</span>
00059 <span class="comment">                </span>
00060 <span class="comment"></span>
00061 <span class="comment"></span>
00062 <span class="comment">            //              if(Threshold != -1 )</span>
00063 <span class="comment">            //                  s +="having count(a.devID) &lt; @Threshold";</span>
00064 <span class="comment">            //</span>
00065 <span class="comment">            //                    s += "order by p.lastName;";</span>
00066 <span class="comment"></span>
00067 <span class="comment">            myDB.Query = s;</span>
00068 <span class="comment">            //          if( Threshold != -1 )</span>
00069 <span class="comment">            //              myDB.addParam( "@Threshold", Threshold );</span>
00070 <span class="comment"></span>
00071 <span class="comment">            </span>
00072 <span class="comment">            DataSet ds = new DataSet();</span>
00073 <span class="comment">            myDB.createAdapter().Fill(ds);</span>
00074 <span class="comment">            DataGrid1.DataSource = ds;</span>
00075 <span class="comment">            DataGrid1.DataBind();</span>
00076 <span class="comment"></span>
00077 <span class="comment">            // fill assignments data grid</span>
00078 <span class="comment">            DBDriver myDB2 = new DBDriver();</span>
00079 <span class="comment">            s = "select assignments.taskID as taskID, users.ID as devID, users.username as username, tasks.name as taskName, \n"</span>
00080 <span class="comment">                + "modules.name as moduleName, projects.name as projectName, assignments.dateAss as date, tasks.complete as complete\n"</span>
00081 <span class="comment">                + "from assignments, users, tasks, modules, projects\n"</span>
00082 <span class="comment">                + "where users.ID = assignments.devID\n"</span>
00083 <span class="comment">                + "and users.security = 'Developer'\n"</span>
00084 <span class="comment">                + "and assignments.taskID = tasks.ID\n"</span>
00085 <span class="comment">                + "and tasks.moduleID = modules.ID\n"</span>
00086 <span class="comment">                + "and modules.projectID = projects.ID\n"</span>
00087 <span class="comment">                + "and projects.managerID = @mgrID \n"</span>
00088 <span class="comment">                + "order by projects.name, modules.name, tasks.name, users.username;";</span>
00089 <span class="comment"></span>
00090 <span class="comment">            myDB2.Query = s;</span>
00091 <span class="comment">            myDB2.addParam("@mgrID", Request.Cookies["user"]["id"]);</span>
00092 <span class="comment">            DataSet ads = new DataSet();</span>
00093 <span class="comment">            myDB2.createAdapter().Fill(ads);</span>
00094 <span class="comment">            DataGrid2.DataSource = ads;</span>
00095 <span class="comment">            if( !Page.IsPostBack )</span>
00096 <span class="comment">                DataGrid2.DataBind();</span>
00097 <span class="comment">                */</span>
00098 
00099         }
00100 
00101         <span class="keyword">private</span> <span class="keywordtype">void</span> BindData()
00102         {
00103             IDataProvider data = DataProvider.CreateInstance();
00104             
00105             dgAssignments.DataSource = data.GetDeveloperAssignments();
00106             dgAssignments.DataBind();
00107 
00108             <span class="comment">//dgAvailableDevs.DataSource = data.GetAvailableDevelopers(numTasks);</span>
00109             <span class="comment">//dgAvailableDevs.DataBind();</span>
00110         }
00111 
00112 <span class="preprocessor">        #region Web Form Designer generated code</span>
00113 <span class="preprocessor"></span>        override <span class="keyword">protected</span> <span class="keywordtype">void</span> OnInit(EventArgs e)
00114         {
00115             <span class="comment">//</span>
00116             <span class="comment">// CODEGEN: This call is required by the ASP.NET Web Form Designer.</span>
00117             <span class="comment">//</span>
00118             InitializeComponent();
00119             base.OnInit(e);
00120         }
00121         
<a name="l00126"></a><a class="code" href="classPMT_1_1PM_1_1Assign.html#PMT_1_1PM_1_1Assignd2">00126</a>         <span class="keyword">private</span> <span class="keywordtype">void</span> InitializeComponent()
00127         {    
00128             <span class="keyword">this</span>.dgAvailableDevs.ItemCommand += <span class="keyword">new</span> System.Web.UI.WebControls.DataGridCommandEventHandler(<span class="keyword">this</span>.Username_Click);
00129             <span class="keyword">this</span>.UpdateButton.Click += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.UpdateButton_Click);
00130             <span class="keyword">this</span>.CommitButton.Click += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.CommitButton_Click);
00131             <span class="keyword">this</span>.CancelButton.Click += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.CancelButton_Click);
00132             <span class="keyword">this</span>.Load += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.Page_Load);
00133 
00134         }
00135 <span class="preprocessor">        #endregion</span>
00136 <span class="preprocessor"></span>
00137 
00138         <span class="keyword">private</span> <span class="keywordtype">void</span> Username_Click(object source, DataGridCommandEventArgs e)
00139         {
00140             <span class="comment">/*</span>
00141 <span class="comment">            IDataProvider data = DataProvider.CreateInstance();</span>
00142 <span class="comment">                // get the developer ID</span>
00143 <span class="comment">                //string devID = DataGrid1.Items[e.Item.ItemIndex].Cells[0].Text;</span>
00144 <span class="comment"></span>
00145 <span class="comment">            // if the taskID is not defined, goto Dev Profile</span>
00146 <span class="comment">            if (TaskID == -1)</span>
00147 <span class="comment">            {</span>
00148 <span class="comment">                //Response.Redirect("ViewDevProfile.aspx?devID="+devID);</span>
00149 <span class="comment">                return;</span>
00150 <span class="comment">            }</span>
00151 <span class="comment"></span>
00152 <span class="comment">            // assign the developer to the selected task</span>
00153 <span class="comment">            Task task = data.GetTask(TaskID);</span>
00154 <span class="comment">            //if ( task.DeveloperID == null )</span>
00155 <span class="comment">            {</span>
00156 <span class="comment">                data.AssignDeveloper(devID, TaskID, new TransactionFailedHandler(this.TransactionFailed));</span>
00157 <span class="comment">            }</span>
00158 <span class="comment">//            else</span>
00159 <span class="comment">//            {</span>
00160 <span class="comment">//                ErrorLabel.Text = "'" + task.Name + "' has already been assigned.";</span>
00161 <span class="comment">//                //Response.Redirect(Request.Url.AbsolutePath+"?error="+error);</span>
00162 <span class="comment">//            }</span>
00163 <span class="comment">            */</span>
00164         }
00165 
00166         <span class="keyword">private</span> <span class="keywordtype">void</span> UpdateButton_Click(object sender, System.EventArgs e)
00167         {
00168             <span class="comment">// show the complete column</span>
00169             UpdateButton.Enabled = <span class="keyword">false</span>;
00170             CommitButton.Enabled = <span class="keyword">true</span>;
00171             CancelButton.Enabled = <span class="keyword">true</span>;
00172             dgAssignments.Columns[8].Visible = <span class="keyword">true</span>;
00173 
00174             <span class="comment">// set check boxes to checked, not checked or checked and disabled</span>
00175             foreach (DataGridItem item in dgAssignments.Items)
00176             {
00177                 CheckBox cb = (CheckBox)item.FindControl(<span class="stringliteral">"ApproveCheckBox"</span>);
00178                 <span class="keywordflow">if</span> (item.Cells[7].Text.Equals(TaskStatus.Approved))
00179                 {
00180                     cb.Checked = <span class="keyword">true</span>;
00181                     cb.Enabled = <span class="keyword">true</span>;
00182                 }
00183                 <span class="keywordflow">if</span> (item.Cells[7].Text.Equals(TaskStatus.Complete))
00184                 {
00185                     cb.Checked = <span class="keyword">false</span>;
00186                     cb.Enabled = <span class="keyword">true</span>;
00187                 }
00188                 <span class="keywordflow">if</span> (item.Cells[7].Text.Equals(TaskStatus.InProgress) )
00189                 {
00190                     cb.Checked = <span class="keyword">false</span>;
00191                     cb.Enabled = <span class="keyword">false</span>;
00192                 }
00193             }
00194         }
00195 
00196         <span class="keyword">private</span> <span class="keywordtype">void</span> CancelButton_Click(object sender, System.EventArgs e)
00197         {
00198             dgAssignments.Columns[8].Visible = <span class="keyword">false</span>;
00199             UpdateButton.Enabled = <span class="keyword">true</span>;
00200             CommitButton.Enabled = <span class="keyword">false</span>;
00201             CancelButton.Enabled = <span class="keyword">false</span>;
00202         }
00203 
00204         <span class="keyword">private</span> <span class="keywordtype">void</span> CommitButton_Click(object sender, System.EventArgs e)
00205         {
00206             DBDriver db = <span class="keyword">new</span> DBDriver();
00207 
00208             foreach (DataGridItem item in dgAssignments.Items)
00209             {
00210                 CheckBox cb = (CheckBox)item.FindControl(<span class="stringliteral">"ApproveCheckBox"</span>);
00211                 <span class="keywordflow">if</span>(cb.Enabled)
00212                 {
00213                     IDataProvider data = DataProvider.CreateInstance();
00214                     data.ApproveTask(Convert.ToInt32(item.Cells[1].Text), <span class="keyword">new</span> TransactionFailedHandler(<span class="keyword">this</span>.TransactionFailed));
00215                 }
00216             }
00217             <span class="keyword">this</span>.BindData();
00218         }
00219 
00220         <span class="keyword">private</span> <span class="keywordtype">void</span> TransactionFailed(Exception ex)
00221         {
00222             ErrorLabel.Text = ex.Message;
00223         }
00224 
00225 <span class="preprocessor">        #region Properties</span>
00226 <span class="preprocessor"></span>        <span class="keyword">public</span> <span class="keywordtype">int</span> TaskID
00227         {
00228             get 
00229             {
00230                 <span class="keywordflow">try</span>
00231                 {
00232                     <span class="keywordflow">return</span> Convert.ToInt32(Request[<span class="stringliteral">"taskID"</span>]);  
00233                 }
00234                 <span class="keywordflow">catch</span>
00235                 {
00236                     <span class="keywordflow">return</span> -1;
00237                 }
00238             }
00239         }
00240 <span class="preprocessor">        #endregion</span>
00241 <span class="preprocessor"></span>    }
00242 }
</pre></div><hr><address style="align: right;"><small>
Generated on Sun Aug 6 23:06:02 2006 for PMT by <a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 width=110 height=53>
</a> 1.3.1 using KingsTools</small></address>
</body>
</html>
