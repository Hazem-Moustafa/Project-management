<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>PMT: D:/My Documents/Visual Studio Projects/projmgtnet2/PM/NewItem.aspx.cs Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.1 -->
<h1>D:/My Documents/Visual Studio Projects/projmgtnet2/PM/NewItem.aspx.cs</h1><div class="fragment"><pre>00001 <span class="keyword">using</span> System;
00002 <span class="keyword">using</span> System.Collections;
00003 <span class="keyword">using</span> System.ComponentModel;
00004 <span class="keyword">using</span> System.Data;
00005 <span class="keyword">using</span> System.Data.SqlClient;
00006 <span class="keyword">using</span> System.Drawing;
00007 <span class="keyword">using</span> System.Web;
00008 <span class="keyword">using</span> System.Web.SessionState;
00009 <span class="keyword">using</span> System.Web.UI;
00010 <span class="keyword">using</span> System.Web.UI.WebControls;
00011 <span class="keyword">using</span> System.Web.UI.HtmlControls;
00012 <span class="keyword">using</span> PMT.Controls;
00013 <span class="keyword">using</span> PMTComponents;
00014 
00015 <span class="keyword">namespace </span>PMT.PM
00016 {
<a name="l00020"></a><a class="code" href="classPMT_1_1PM_1_1NewItem.html">00020</a>     <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="classPMT_1_1PM_1_1NewItem.html">NewItem</a> : System.Web.UI.Page
00021     {
00022         <span class="keyword">protected</span> System.Web.UI.WebControls.Button SubmitButton;
00023         <span class="keyword">protected</span> System.Web.UI.WebControls.TextBox StartTextBox;
00024         <span class="keyword">protected</span> System.Web.UI.WebControls.RegularExpressionValidator StartRegularExpressionValidator;
00025         <span class="keyword">protected</span> System.Web.UI.WebControls.RequiredFieldValidator NameRequiredFieldValidator;
00026         <span class="keyword">protected</span> System.Web.UI.WebControls.RequiredFieldValidator StartRequiredFieldValidator;
00027         <span class="keyword">protected</span> System.Web.UI.WebControls.Label statusLabel;
00028         <span class="keyword">protected</span> System.Web.UI.HtmlControls.HtmlTextArea descriptionTextArea;
00029         <span class="keyword">protected</span> System.Web.UI.WebControls.TextBox NameTextBox;
00030         <span class="keyword">protected</span> System.Web.UI.WebControls.Panel ChooseItemPanel;
00031         <span class="keyword">protected</span> System.Web.UI.WebControls.Panel CreateItemPanel;
00032         <span class="keyword">protected</span> PageNameControl pageNameControl;
00033         <span class="keyword">protected</span> System.Web.UI.WebControls.HyperLink CreateProjectLink;
00034         <span class="keyword">protected</span> System.Web.UI.WebControls.HyperLink CreateModuleLink;
00035         <span class="keyword">protected</span> System.Web.UI.WebControls.HyperLink CreateTaskLink;
00036         <span class="keyword">protected</span> System.Web.UI.WebControls.Panel creationSuccessPanel;
00037         <span class="keyword">protected</span> System.Web.UI.WebControls.HyperLink addAnotherItemLink;
00038         <span class="keyword">protected</span> System.Web.UI.WebControls.DropDownList ModuleDropDownList;
00039         <span class="keyword">protected</span> System.Web.UI.WebControls.DropDownList ProjectDropDownList;
00040         <span class="keyword">protected</span> System.Web.UI.WebControls.Label InProjectLabel;
00041         <span class="keyword">protected</span> System.Web.UI.WebControls.Label InModuleLabel;
00042         <span class="keyword">protected</span> System.Web.UI.WebControls.CustomValidator DescriptionCustomValidator;
00043         <span class="keyword">protected</span> System.Web.UI.WebControls.CustomValidator ProjectDropDownValidator;
00044         <span class="keyword">protected</span> System.Web.UI.WebControls.RequiredFieldValidator ProjectDropDownListRequiredFieldValidator;
00045         <span class="keyword">protected</span> System.Web.UI.WebControls.RequiredFieldValidator ModuleDropDownListRequiredFieldValidator;
00046         <span class="comment">// the id of the parent item</span>
00047         <span class="keyword">protected</span> string parentID;
00048         <span class="keyword">protected</span> string itemType;
00049         <span class="keyword">protected</span> Project parentProject;
00050         <span class="keyword">protected</span> System.Web.UI.WebControls.CustomValidator StartDateCustomValidator;
00051         <span class="keyword">protected</span> System.Web.UI.WebControls.Label ParentDateLabel;
00052         <span class="keyword">protected</span> System.Web.UI.WebControls.DropDownList ComplexityDropDownList;
00053         <span class="keyword">protected</span> System.Web.UI.WebControls.Label ComplexityLabel;
00054         <span class="keyword">protected</span> System.Web.UI.WebControls.RequiredFieldValidator ComplexityDropDownListRequiredFieldValidator;
00055         <span class="keyword">protected</span> System.Web.UI.WebControls.HyperLink AddItemToParentHyperLink;
00056         <span class="keyword">protected</span> Module parentModule;
00057     
00058         <span class="keyword">private</span> <span class="keywordtype">void</span> Page_Load(object sender, System.EventArgs e)
00059         {
00060             <span class="comment">// get the item to create from the GET query string</span>
00061             itemType = <span class="keyword">this</span>.Request[<span class="stringliteral">"item"</span>];
00062 
00063             <span class="comment">// get parent item id, this will be useful when you would click</span>
00064             <span class="comment">//  a link like PMNewItem.aspx?item=task&amp;parentID=5.  This will avoid</span>
00065             <span class="comment">//  using the drop down lists</span>
00066             parentID = <span class="keyword">this</span>.Request[<span class="stringliteral">"parentID"</span>];
00067 
00068             <span class="comment">// initialize parent item(s)</span>
00069             <span class="keywordflow">if</span> (parentID != null) 
00070             {
00071                 <span class="keywordflow">if</span> (itemType.Equals(ProjectItem.ItemType.MODULE))
00072                 {
00073                     parentProject = <span class="keyword">new</span> Project(parentID);
00074                 }
00075                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (itemType.Equals(ProjectItem.ItemType.TASK))
00076                 {
00077                     parentModule = <span class="keyword">new</span> Module(parentID);
00078                     parentProject = <span class="keyword">new</span> Project(parentModule.ProjectID);
00079                 }
00080             }
00081 
00082             <span class="comment">// set the page title</span>
00083             <span class="keywordflow">if</span> (!itemType.Equals(String.Empty))
00084             {
00085                 pageNameControl.PageTitle = <span class="stringliteral">"New "</span> + itemType;
00086             }
00087             
00088 
00089             <span class="comment">// if there is no request item, or is not a valid option, </span>
00090             <span class="comment">//  ask what to create</span>
00091             <span class="keywordflow">if</span> (itemType == null || 
00092                 !(itemType.Equals(ProjectItem.ItemType.PROJECT) || 
00093                 itemType.Equals(ProjectItem.ItemType.MODULE) || 
00094                 itemType.Equals(ProjectItem.ItemType.TASK)))
00095             {
00096                 pageNameControl.PageTitle = <span class="stringliteral">"What do you want to create?"</span>;
00097                 ChooseItemPanel.Visible = <span class="keyword">true</span>;
00098             }
00099                 <span class="comment">// show create selected item panel</span>
00100             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!Page.IsPostBack)
00101             {
00102                 
00103 
00104                 <span class="comment">// show the create item panel</span>
00105                 CreateItemPanel.Visible = <span class="keyword">true</span>;
00106 
00107                 <span class="comment">// hide project or module drop down if not needed</span>
00108                 <span class="keywordflow">if</span> (itemType.Equals(ProjectItem.ItemType.PROJECT))
00109                 {
00110                     ProjectDropDownList.Visible = <span class="keyword">false</span>;
00111                     InProjectLabel.Visible = <span class="keyword">false</span>;
00112                     ProjectDropDownListRequiredFieldValidator.Enabled = <span class="keyword">false</span>;
00113                     ModuleDropDownList.Visible = <span class="keyword">false</span>;
00114                     InModuleLabel.Visible = <span class="keyword">false</span>;
00115                     ModuleDropDownListRequiredFieldValidator.Enabled = <span class="keyword">false</span>;
00116                     ComplexityLabel.Visible = <span class="keyword">false</span>;
00117                     ComplexityDropDownList.Visible = <span class="keyword">false</span>;
00118                     ComplexityDropDownListRequiredFieldValidator.Enabled = <span class="keyword">false</span>;
00119                 }
00120                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (itemType.Equals(ProjectItem.ItemType.MODULE))
00121                 {
00122                     ModuleDropDownList.Visible = <span class="keyword">false</span>;
00123                     InModuleLabel.Visible = <span class="keyword">false</span>;
00124                     ModuleDropDownListRequiredFieldValidator.Enabled = <span class="keyword">false</span>;
00125                     ComplexityLabel.Visible = <span class="keyword">false</span>;
00126                     ComplexityDropDownList.Visible = <span class="keyword">false</span>;
00127                     ComplexityDropDownListRequiredFieldValidator.Enabled = <span class="keyword">false</span>;
00128 
00129                     fillProjectDropDownList();
00130                 }
00131                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (itemType.Equals(ProjectItem.ItemType.TASK))
00132                 {
00133                     <span class="comment">// set auto post back to true for the project drop down list</span>
00134                     <span class="comment">// so that when it changes, it will update the module drop down</span>
00135                     ProjectDropDownList.AutoPostBack = <span class="keyword">true</span>;
00136                     ComplexityLabel.Visible = <span class="keyword">true</span>;
00137                     ComplexityDropDownList.Visible = <span class="keyword">true</span>;
00138                     ComplexityDropDownListRequiredFieldValidator.Enabled = <span class="keyword">true</span>;
00139                     
00140                     ComplexityDropDownList.Items.Insert(0,<span class="stringliteral">""</span>);
00141                     ComplexityDropDownList.Items.Insert(1,<span class="stringliteral">"Low"</span>);
00142                     ComplexityDropDownList.Items[1].Value= <span class="stringliteral">"Low"</span>;
00143                     ComplexityDropDownList.Items.Insert(2,<span class="stringliteral">"Medium"</span>);
00144                     ComplexityDropDownList.Items[2].Value= <span class="stringliteral">"Medium"</span>;
00145                     ComplexityDropDownList.Items.Insert(3,<span class="stringliteral">"High"</span>);
00146                     ComplexityDropDownList.Items[3].Value= <span class="stringliteral">"High"</span>;
00147 
00148 
00149                     fillProjectDropDownList();
00150                 }
00151             }
00152             
00153         }
00154 
00155 <span class="preprocessor">        #region Web Form Designer generated code</span>
00156 <span class="preprocessor"></span>        override <span class="keyword">protected</span> <span class="keywordtype">void</span> OnInit(EventArgs e)
00157         {
00158             <span class="comment">//</span>
00159             <span class="comment">// CODEGEN: This call is required by the ASP.NET Web Form Designer.</span>
00160             <span class="comment">//</span>
00161             InitializeComponent();
00162             base.OnInit(e);
00163         }
00164         
<a name="l00169"></a><a class="code" href="classPMT_1_1PM_1_1NewItem.html#PMT_1_1PM_1_1NewItemd1">00169</a>         <span class="keyword">private</span> <span class="keywordtype">void</span> InitializeComponent()
00170         {    
00171             <span class="keyword">this</span>.ProjectDropDownList.SelectedIndexChanged += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.ProjectDropDownList_SelectedIndexChanged);
00172             <span class="keyword">this</span>.StartDateCustomValidator.ServerValidate += <span class="keyword">new</span> System.Web.UI.WebControls.ServerValidateEventHandler(<span class="keyword">this</span>.ValidateStartDate);
00173             <span class="keyword">this</span>.ComplexityDropDownList.SelectedIndexChanged += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.ComplexityDropDownList_SelectedIndexChanged);
00174             <span class="keyword">this</span>.DescriptionCustomValidator.ServerValidate += <span class="keyword">new</span> System.Web.UI.WebControls.ServerValidateEventHandler(<span class="keyword">this</span>.ValidateDescription);
00175             <span class="keyword">this</span>.SubmitButton.Click += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.SubmitButton_Click);
00176             <span class="keyword">this</span>.Load += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.Page_Load);
00177 
00178         }
00179 <span class="preprocessor">        #endregion</span>
00180 <span class="preprocessor"></span>
00181         <span class="keyword">private</span> <span class="keywordtype">void</span> fillProjectDropDownList()
00182         {
00183             <span class="comment">// build project drop down list and</span>
00184             <span class="comment">// select list item that has value = id (if value != null)</span>
00185             DataSet ds=<span class="keyword">new</span> DataSet();
00186             ds = Project.getProjectsDataSet(Request.Cookies[<span class="stringliteral">"user"</span>][<span class="stringliteral">"id"</span>]);
00187             <span class="comment">//create a datatable to fill the dropdown list from</span>
00188             DataTable dt=ds.Tables[0];
00189             <span class="comment">//fill the dropdown list</span>
00190             ProjectDropDownList.DataSource=dt.DefaultView;
00191             ProjectDropDownList.DataTextField=<span class="stringliteral">"name"</span>;
00192             ProjectDropDownList.DataValueField=<span class="stringliteral">"id"</span>;
00193             ProjectDropDownList.DataBind();
00194             ProjectDropDownList.Items.Insert(0,<span class="stringliteral">""</span>);
00195 
00196             <span class="comment">// select parent Project</span>
00197             <span class="keywordflow">if</span> (parentID != null)
00198             {
00199                 ProjectDropDownList.SelectedIndex 
00200                     = ProjectDropDownList.Items.IndexOf(
00201                     ProjectDropDownList.Items.FindByValue(parentProject.ID));
00202                 ProjectDropDownList.Enabled = <span class="keyword">false</span>;
00203 
00204                 <span class="keywordflow">if</span> (itemType.Equals(ProjectItem.ItemType.TASK))
00205                     fillModuleDropDownList();
00206             }
00207         }
00208 
00209         <span class="keyword">private</span> <span class="keywordtype">void</span> fillModuleDropDownList()
00210         {
00211             <span class="comment">//build the module list</span>
00212             <span class="comment">//create a data set</span>
00213             DataSet ds=<span class="keyword">new</span> DataSet();
00214             <span class="comment">//ds = Module.getModulesDataSet(ProjectDropDownList.SelectedValue);</span>
00215             ds = parentProject.getModulesDataSet();
00216             <span class="comment">//create a datatable to fill the dropdown list from</span>
00217             DataTable dt=ds.Tables[0];
00218             <span class="comment">//fill the dropdown list</span>
00219             ModuleDropDownList.DataSource=dt.DefaultView;
00220             ModuleDropDownList.DataTextField=<span class="stringliteral">"name"</span>;
00221             ModuleDropDownList.DataValueField=<span class="stringliteral">"id"</span>;
00222             ModuleDropDownList.DataBind();
00223             ModuleDropDownList.Items.Insert(0, <span class="stringliteral">""</span>);
00224 
00225             <span class="comment">// select parent Module</span>
00226             <span class="keywordflow">if</span> (parentID != null)
00227             {
00228                 ModuleDropDownList.SelectedIndex 
00229                     = ModuleDropDownList.Items.IndexOf(
00230                     ModuleDropDownList.Items.FindByValue(parentModule.ID));
00231                 ModuleDropDownList.Enabled = <span class="keyword">false</span>;
00232             }
00233         }
00234 
00235         <span class="keyword">private</span> <span class="keywordtype">void</span> SubmitButton_Click(object sender, System.EventArgs e)
00236         {
00237             <span class="comment">// return if the form did not pass validation</span>
00238             <span class="keywordflow">if</span> (!Page.IsValid)
00239                 <span class="keywordflow">return</span>;
00240 
00241             ProjectItem item;
00242 
00243             <span class="keywordflow">if</span> (itemType.Equals(ProjectItem.ItemType.PROJECT))
00244             {
00245                 item = <span class="keyword">new</span> Project(
00246                             NameTextBox.Text,
00247                             Request.Cookies[<span class="stringliteral">"user"</span>][<span class="stringliteral">"id"</span>],
00248                             descriptionTextArea.InnerText,
00249                             StartTextBox.Text);
00250                 <span class="comment">// set the link for adding a child item</span>
00251                 addAnotherItemLink.NavigateUrl += <span class="stringliteral">"?item="</span>+ProjectItem.ItemType.MODULE+<span class="stringliteral">"&amp;parentID="</span>+item.ID;
00252                 addAnotherItemLink.Text = <span class="stringliteral">"Add a Module to "</span> + NameTextBox.Text;
00253                 <span class="comment">// set the link for adding another item to parent item</span>
00254                 AddItemToParentHyperLink.Text = <span class="stringliteral">"Create another Project"</span>;
00255                 AddItemToParentHyperLink.NavigateUrl += <span class="stringliteral">"?item="</span>+ProjectItem.ItemType.PROJECT;
00256             }
00257             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (itemType.Equals(ProjectItem.ItemType.MODULE))
00258             {
00259                 item = <span class="keyword">new</span> Module(
00260                             NameTextBox.Text, 
00261                             ProjectDropDownList.SelectedValue,
00262                             descriptionTextArea.InnerText,
00263                             StartTextBox.Text);
00264                 <span class="comment">// set the link for adding a child item</span>
00265                 addAnotherItemLink.NavigateUrl += <span class="stringliteral">"?item="</span>+ProjectItem.ItemType.TASK+<span class="stringliteral">"&amp;parentID="</span>+item.ID;
00266                 addAnotherItemLink.Text = <span class="stringliteral">"Add a Task to "</span> + NameTextBox.Text;
00267                 <span class="comment">// set the link for adding another item to parent item</span>
00268                 AddItemToParentHyperLink.Text = <span class="stringliteral">"Add another Module to "</span> + ProjectDropDownList.SelectedItem.Text;
00269                 AddItemToParentHyperLink.NavigateUrl += <span class="stringliteral">"?item="</span>+ProjectItem.ItemType.MODULE+<span class="stringliteral">"&amp;parentID="</span>+ProjectDropDownList.SelectedValue;
00270             }
00271             <span class="keywordflow">else</span> <span class="comment">//(itemType.Equals(ProjectItemType.TASK))</span>
00272             {
00273                 item = <span class="keyword">new</span> Task(
00274                             NameTextBox.Text, 
00275                             ModuleDropDownList.SelectedValue,
00276                             descriptionTextArea.InnerText,
00277                             StartTextBox.Text,
00278                             ComplexityDropDownList.SelectedValue);
00279                 <span class="comment">// hide the add child item link</span>
00280                 addAnotherItemLink.Visible = <span class="keyword">false</span>;
00281                 <span class="comment">// set the link for adding another item to parent item</span>
00282                 AddItemToParentHyperLink.Text = <span class="stringliteral">"Add another Task to "</span> + ModuleDropDownList.SelectedItem.Text;
00283                 AddItemToParentHyperLink.NavigateUrl += <span class="stringliteral">"?item="</span>+ProjectItem.ItemType.TASK+<span class="stringliteral">"&amp;parentID="</span>+ModuleDropDownList.SelectedValue;
00284             }
00285 
00286             statusLabel.Text = NameTextBox.Text + <span class="stringliteral">" created."</span>;
00287 
00288             CreateItemPanel.Visible = <span class="keyword">false</span>;
00289             creationSuccessPanel.Visible = <span class="keyword">true</span>;
00290         }
<a name="l00294"></a><a class="code" href="classPMT_1_1PM_1_1NewItem.html#PMT_1_1PM_1_1NewItemd5">00294</a>         <span class="keyword">private</span> <span class="keywordtype">void</span> ValidateStartDate(object sender, ServerValidateEventArgs args)
00295         {
00296             <span class="comment">// ignore error if start or end date is not in valid form</span>
00297             <span class="keywordflow">if</span> (!StartRegularExpressionValidator.IsValid)
00298             {
00299                 args.IsValid = <span class="keyword">true</span>;
00300                 <span class="keywordflow">return</span>;
00301             }
00302 
00303             <span class="comment">// initially set to true</span>
00304             args.IsValid = <span class="keyword">true</span>;
00305 
00306             DateTime start = Convert.ToDateTime(StartTextBox.Text);
00307             DateTime parentStart = <span class="keyword">new</span> DateTime();
00308 
00309             <span class="comment">// check parent's start date against start date if not a project</span>
00310             <span class="keywordflow">if</span> (!itemType.Equals(ProjectItem.ItemType.PROJECT))
00311             {
00312                 <span class="keywordflow">if</span> (itemType.Equals(ProjectItem.ItemType.MODULE))
00313                 {
00314                     <span class="keywordflow">if</span> (parentID == null)
00315                         parentProject = <span class="keyword">new</span> Project(ProjectDropDownList.SelectedValue);
00316                     parentStart = Convert.ToDateTime(parentProject.StartDate);
00317                 }
00318                 <span class="keywordflow">else</span> <span class="comment">//if (itemType.Equals(ProjectItemType.TASK))</span>
00319                 {
00320                     <span class="keywordflow">if</span> (parentID == null)
00321                         parentModule = <span class="keyword">new</span> Module(ModuleDropDownList.SelectedValue);
00322                     parentStart = Convert.ToDateTime(parentModule.StartDate);
00323                 }
00324 
00325                 <span class="keywordflow">if</span> (start &lt; parentStart)
00326                 {
00327                     args.IsValid = <span class="keyword">false</span>;
00328                     <span class="keyword">this</span>.StartDateCustomValidator.ErrorMessage
00329                         += <span class="stringliteral">" ("</span> + parentStart.ToShortDateString() + <span class="stringliteral">")"</span>;
00330                 }
00331             }
00332         }
00333 
00334 
<a name="l00338"></a><a class="code" href="classPMT_1_1PM_1_1NewItem.html#PMT_1_1PM_1_1NewItemd6">00338</a>         <span class="keyword">private</span> <span class="keywordtype">void</span> ValidateDescription(object sender, ServerValidateEventArgs args)
00339         {
00340             <span class="keywordflow">if</span> (descriptionTextArea.InnerText.Length &lt; 256)
00341                 args.IsValid = <span class="keyword">true</span>;
00342             <span class="keywordflow">else</span>
00343                 args.IsValid = <span class="keyword">false</span>;
00344         }
00345 
00346         <span class="keyword">private</span> <span class="keywordtype">void</span> ProjectDropDownList_SelectedIndexChanged(object sender, System.EventArgs e)
00347         {
00348             <span class="keywordflow">if</span> (itemType.Equals(ProjectItem.ItemType.TASK))
00349             {
00350                 fillModuleDropDownList();
00351             }
00352         }
00353 
00354         <span class="keyword">private</span> <span class="keywordtype">void</span> ComplexityDropDownList_SelectedIndexChanged(object sender, System.EventArgs e)
00355         {
00356         
00357         }
00358     }
00359 }
</pre></div><hr><address style="align: right;"><small>
Generated on Sat Aug 5 14:40:47 2006 for PMT by <a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 width=110 height=53>
</a> 1.3.1 using KingsTools</small></address>
</body>
</html>
