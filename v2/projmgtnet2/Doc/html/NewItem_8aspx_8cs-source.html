<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>PMT: NewItem.aspx.cs Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.1 -->
<h1>NewItem.aspx.cs</h1><div class="fragment"><pre>00001 <span class="keyword">using</span> System;
00002 <span class="keyword">using</span> System.Collections;
00003 <span class="keyword">using</span> System.ComponentModel;
00004 <span class="keyword">using</span> System.Data;
00005 <span class="keyword">using</span> System.Data.SqlClient;
00006 <span class="keyword">using</span> System.Drawing;
00007 <span class="keyword">using</span> System.Web;
00008 <span class="keyword">using</span> System.Web.SessionState;
00009 <span class="keyword">using</span> System.Web.UI;
00010 <span class="keyword">using</span> System.Web.UI.WebControls;
00011 <span class="keyword">using</span> System.Web.UI.HtmlControls;
00012 <span class="keyword">using</span> PMT.Controls;
00013 <span class="keyword">using</span> PMTComponents;
00014 <span class="keyword">using</span> PMTDataProvider;
00015 
00016 <span class="keyword">namespace </span>PMT.PM
00017 {
<a name="l00021"></a><a class="code" href="classPMT_1_1PM_1_1NewItem.html">00021</a>     <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="classPMT_1_1PM_1_1NewItem.html">NewItem</a> : Page
00022     {
00023         <span class="keyword">protected</span> Button SubmitButton;
00024         <span class="keyword">protected</span> TextBox StartTextBox;
00025         <span class="keyword">protected</span> RegularExpressionValidator StartRegularExpressionValidator;
00026         <span class="keyword">protected</span> RequiredFieldValidator NameRequiredFieldValidator;
00027         <span class="keyword">protected</span> RequiredFieldValidator StartRequiredFieldValidator;
00028         <span class="keyword">protected</span> Label statusLabel;
00029         <span class="keyword">protected</span> System.Web.UI.HtmlControls.HtmlTextArea descriptionTextArea;
00030         <span class="keyword">protected</span> TextBox NameTextBox;
00031         <span class="keyword">protected</span> Panel ChooseItemPanel;
00032         <span class="keyword">protected</span> Panel CreateItemPanel;
00033         <span class="keyword">protected</span> PageNameControl pageNameControl;
00034         <span class="keyword">protected</span> HyperLink CreateProjectLink;
00035         <span class="keyword">protected</span> HyperLink CreateModuleLink;
00036         <span class="keyword">protected</span> HyperLink CreateTaskLink;
00037         <span class="keyword">protected</span> Panel creationSuccessPanel;
00038         <span class="keyword">protected</span> HyperLink addAnotherItemLink;
00039         <span class="keyword">protected</span> DropDownList ModuleDropDownList;
00040         <span class="keyword">protected</span> DropDownList ProjectDropDownList;
00041         <span class="keyword">protected</span> Label InProjectLabel;
00042         <span class="keyword">protected</span> Label InModuleLabel;
00043         <span class="keyword">protected</span> CustomValidator DescriptionCustomValidator;
00044         <span class="keyword">protected</span> CustomValidator ProjectDropDownValidator;
00045         <span class="keyword">protected</span> RequiredFieldValidator ProjectDropDownListRequiredFieldValidator;
00046         <span class="keyword">protected</span> RequiredFieldValidator ModuleDropDownListRequiredFieldValidator;
00047         <span class="comment">// the id of the parent item</span>
00048         <span class="keyword">protected</span> Project parentProject;
00049         <span class="keyword">protected</span> CustomValidator StartDateCustomValidator;
00050         <span class="keyword">protected</span> Label ParentDateLabel;
00051         <span class="keyword">protected</span> DropDownList ComplexityDropDownList;
00052         <span class="keyword">protected</span> Label ComplexityLabel;
00053         <span class="keyword">protected</span> RequiredFieldValidator ComplexityDropDownListRequiredFieldValidator;
00054         <span class="keyword">protected</span> HyperLink AddItemToParentHyperLink;
00055         <span class="keyword">protected</span> Module parentModule;
00056     
00057         <span class="keyword">private</span> <span class="keywordtype">void</span> Page_Load(object sender, System.EventArgs e)
00058         {
00059             <span class="comment">// get parent item id, this will be useful when you would click</span>
00060             <span class="comment">//  a link like PMNewItem.aspx?item=task&amp;parentID=5.  This will avoid</span>
00061             <span class="comment">//  using the drop down lists</span>
00062 
00063             IDataProvider data = DataProvider.CreateInstance();
00064             <span class="comment">// initialize parent item(s)</span>
00065             <span class="keywordflow">if</span> (ParentID != -1) 
00066             {
00067                 <span class="keywordflow">if</span> (ItemType.Equals(ProjectItemType.Module))
00068                 {
00069                     parentProject = data.GetProject(ParentID);
00070                 }
00071                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ItemType.Equals(ProjectItemType.Task))
00072                 {
00073                     parentModule = data.GetModule(ParentID);
00074                     parentProject = data.GetProject(parentModule.ProjectID);
00075                 }
00076             }
00077 
00078             <span class="comment">// set the page title</span>
00079             <span class="comment">//if (!ItemType.Equals(String.Empty))</span>
00080             {
00081                 pageNameControl.PageTitle = <span class="stringliteral">"New "</span> + ItemType.ToString();
00082             }
00083             
00084 
00085             <span class="comment">// if there is no request item, or is not a valid option, </span>
00086             <span class="comment">//  ask what to create</span>
00087 <span class="comment">//            if (ItemType == -1 )</span>
00088 <span class="comment">//            {</span>
00089 <span class="comment">//                pageNameControl.PageTitle = "What do you want to create?";</span>
00090 <span class="comment">//                ChooseItemPanel.Visible = true;</span>
00091 <span class="comment">//            }</span>
00092                 <span class="comment">// show create selected item panel</span>
00093             <span class="comment">//else </span>
00094             <span class="keywordflow">if</span> (!IsPostBack)
00095             {
00096                 <span class="comment">// show the create item panel</span>
00097                 CreateItemPanel.Visible = <span class="keyword">true</span>;
00098 
00099                 <span class="comment">// hide project or module drop down if not needed</span>
00100                 <span class="keywordflow">if</span> (ItemType == ProjectItemType.Project)
00101                 {
00102                     ProjectDropDownList.Visible = <span class="keyword">false</span>;
00103                     InProjectLabel.Visible = <span class="keyword">false</span>;
00104                     ProjectDropDownListRequiredFieldValidator.Enabled = <span class="keyword">false</span>;
00105                     ModuleDropDownList.Visible = <span class="keyword">false</span>;
00106                     InModuleLabel.Visible = <span class="keyword">false</span>;
00107                     ModuleDropDownListRequiredFieldValidator.Enabled = <span class="keyword">false</span>;
00108                     ComplexityLabel.Visible = <span class="keyword">false</span>;
00109                     ComplexityDropDownList.Visible = <span class="keyword">false</span>;
00110                     ComplexityDropDownListRequiredFieldValidator.Enabled = <span class="keyword">false</span>;
00111                 }
00112                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ItemType == ProjectItemType.Module)
00113                 {
00114                     ModuleDropDownList.Visible = <span class="keyword">false</span>;
00115                     InModuleLabel.Visible = <span class="keyword">false</span>;
00116                     ModuleDropDownListRequiredFieldValidator.Enabled = <span class="keyword">false</span>;
00117                     ComplexityLabel.Visible = <span class="keyword">false</span>;
00118                     ComplexityDropDownList.Visible = <span class="keyword">false</span>;
00119                     ComplexityDropDownListRequiredFieldValidator.Enabled = <span class="keyword">false</span>;
00120 
00121                     fillProjectDropDownList();
00122                 }
00123                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ItemType == ProjectItemType.Task)
00124                 {
00125                     <span class="comment">// set auto post back to true for the project drop down list</span>
00126                     <span class="comment">// so that when it changes, it will update the module drop down</span>
00127                     ProjectDropDownList.AutoPostBack = <span class="keyword">true</span>;
00128                     ComplexityLabel.Visible = <span class="keyword">true</span>;
00129                     ComplexityDropDownList.Visible = <span class="keyword">true</span>;
00130                     ComplexityDropDownListRequiredFieldValidator.Enabled = <span class="keyword">true</span>;
00131                     ComplexityDropDownList.DataSource = Enum.GetNames(typeof(TaskComplexity));
00132 
00133                     fillProjectDropDownList();
00134                 }
00135             }
00136             
00137         }
00138 
00139 <span class="preprocessor">        #region Web Form Designer generated code</span>
00140 <span class="preprocessor"></span>        override <span class="keyword">protected</span> <span class="keywordtype">void</span> OnInit(EventArgs e)
00141         {
00142             <span class="comment">//</span>
00143             <span class="comment">// CODEGEN: This call is required by the ASP.NET Web Form Designer.</span>
00144             <span class="comment">//</span>
00145             InitializeComponent();
00146             base.OnInit(e);
00147         }
00148         
<a name="l00153"></a><a class="code" href="classPMT_1_1PM_1_1NewItem.html#PMT_1_1PM_1_1NewItemd1">00153</a>         <span class="keyword">private</span> <span class="keywordtype">void</span> InitializeComponent()
00154         {    
00155             <span class="keyword">this</span>.ProjectDropDownList.SelectedIndexChanged += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.ProjectDropDownList_SelectedIndexChanged);
00156             <span class="keyword">this</span>.StartDateCustomValidator.ServerValidate += <span class="keyword">new</span> System.Web.UI.WebControls.ServerValidateEventHandler(<span class="keyword">this</span>.ValidateStartDate);
00157             <span class="keyword">this</span>.ComplexityDropDownList.SelectedIndexChanged += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.ComplexityDropDownList_SelectedIndexChanged);
00158             <span class="keyword">this</span>.DescriptionCustomValidator.ServerValidate += <span class="keyword">new</span> System.Web.UI.WebControls.ServerValidateEventHandler(<span class="keyword">this</span>.ValidateDescription);
00159             <span class="keyword">this</span>.SubmitButton.Click += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.SubmitButton_Click);
00160             <span class="keyword">this</span>.Load += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.Page_Load);
00161 
00162         }
00163 <span class="preprocessor">        #endregion</span>
00164 <span class="preprocessor"></span>
00165         <span class="keyword">private</span> <span class="keywordtype">void</span> fillProjectDropDownList()
00166         {
00167             <span class="comment">// build project drop down list and</span>
00168             <span class="comment">// select list item that has value = id (if value != null)</span>
00169             IDataProvider data = DataProvider.CreateInstance();
00170             <span class="comment">//fill the dropdown list</span>
00171             ProjectDropDownList.DataSource = data.GetManagerProjects(UserID);
00172             ProjectDropDownList.DataTextField=<span class="stringliteral">"name"</span>;
00173             ProjectDropDownList.DataValueField=<span class="stringliteral">"id"</span>;
00174             ProjectDropDownList.DataBind();
00175             ProjectDropDownList.Items.Insert(0,<span class="stringliteral">""</span>);
00176 
00177             <span class="comment">// select parent Project</span>
00178             <span class="keywordflow">if</span> (ParentID != -1)
00179             {
00180                 ProjectDropDownList.SelectedIndex 
00181                     = ProjectDropDownList.Items.IndexOf(
00182                     ProjectDropDownList.Items.FindByValue(parentProject.ID.ToString()));
00183                 ProjectDropDownList.Enabled = <span class="keyword">false</span>;
00184 
00185                 <span class="keywordflow">if</span> (ItemType.Equals(ProjectItemType.Task))
00186                     fillModuleDropDownList();
00187             }
00188         }
00189 
00190         <span class="keyword">private</span> <span class="keywordtype">void</span> fillModuleDropDownList()
00191         {
00192             <span class="comment">//build the module list</span>
00193             IDataProvider data = DataProvider.CreateInstance();
00194             <span class="comment">//fill the dropdown list</span>
00195             ModuleDropDownList.DataSource = data.GetProjectModules(Convert.ToInt32(ProjectDropDownList.SelectedValue));
00196             ModuleDropDownList.DataTextField=<span class="stringliteral">"name"</span>;
00197             ModuleDropDownList.DataValueField=<span class="stringliteral">"id"</span>;
00198             ModuleDropDownList.DataBind();
00199             ModuleDropDownList.Items.Insert(0, <span class="stringliteral">""</span>);
00200 
00201             <span class="comment">// select parent Module</span>
00202             <span class="keywordflow">if</span> (ParentID != -1)
00203             {
00204                 ModuleDropDownList.SelectedIndex 
00205                     = ModuleDropDownList.Items.IndexOf(
00206                     ModuleDropDownList.Items.FindByValue(parentModule.ID.ToString()));
00207                 ModuleDropDownList.Enabled = <span class="keyword">false</span>;
00208             }
00209         }
00210 
00211         <span class="keyword">private</span> <span class="keywordtype">void</span> SubmitButton_Click(object sender, System.EventArgs e)
00212         {
00213             <span class="comment">// return if the form did not pass validation</span>
00214             <span class="keywordflow">if</span> (!Page.IsValid)
00215                 <span class="keywordflow">return</span>;
00216 
00217             IDataProvider data = DataProvider.CreateInstance();
00218             ProjectItem item;
00219 
00220             <span class="keywordflow">if</span> (ItemType.Equals(ProjectItemType.Project))
00221             {
00222                 item = <span class="keyword">new</span> Project(
00223                             UserID, 
00224                             NameTextBox.Text, 
00225                             descriptionTextArea.InnerText, 
00226                             Convert.ToDateTime(StartTextBox.Text));
00227                 <span class="keywordtype">int</span> id = data.InsertProject(item as Project, <span class="keyword">new</span> TransactionFailedHandler(<span class="keyword">this</span>.TransactionFailed));
00228                 <span class="comment">// set the link for adding a child item</span>
00229                 addAnotherItemLink.NavigateUrl += <span class="stringliteral">"?item="</span>+ProjectItemType.Module+<span class="stringliteral">"&amp;parentID="</span>+id;
00230                 addAnotherItemLink.Text = <span class="stringliteral">"Add a Module to "</span> + NameTextBox.Text;
00231                 <span class="comment">// set the link for adding another item to parent item</span>
00232                 AddItemToParentHyperLink.Text = <span class="stringliteral">"Create another Project"</span>;
00233                 AddItemToParentHyperLink.NavigateUrl += <span class="stringliteral">"?item="</span>+ProjectItemType.Project;
00234             }
00235             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ItemType.Equals(ProjectItemType.Module))
00236             {
00237                 item = <span class="keyword">new</span> Module(
00238                             Convert.ToInt32(ProjectDropDownList.SelectedValue),
00239                             NameTextBox.Text, 
00240                             descriptionTextArea.InnerText,
00241                             Convert.ToDateTime(StartTextBox.Text));
00242                 <span class="keywordtype">int</span> id = data.InsertModule(item as Module, <span class="keyword">new</span> TransactionFailedHandler(<span class="keyword">this</span>.TransactionFailed));
00243                 <span class="comment">// set the link for adding a child item</span>
00244                 addAnotherItemLink.NavigateUrl += <span class="stringliteral">"?item="</span>+ProjectItemType.Task+<span class="stringliteral">"&amp;parentID="</span>+id;
00245                 addAnotherItemLink.Text = <span class="stringliteral">"Add a Task to "</span> + NameTextBox.Text;
00246                 <span class="comment">// set the link for adding another item to parent item</span>
00247                 AddItemToParentHyperLink.Text = <span class="stringliteral">"Add another Module to "</span> + ProjectDropDownList.SelectedItem.Text;
00248                 AddItemToParentHyperLink.NavigateUrl += <span class="stringliteral">"?item="</span>+ProjectItemType.Module+<span class="stringliteral">"&amp;parentID="</span>+ProjectDropDownList.SelectedValue;
00249             }
00250             <span class="keywordflow">else</span> <span class="comment">//(itemType.Equals(ProjectItemType.TASK))</span>
00251             {
00252                 item = <span class="keyword">new</span> Task(
00253                             Convert.ToInt32(ModuleDropDownList.SelectedValue),
00254                             Convert.ToInt32(ProjectDropDownList.SelectedValue),
00255                             NameTextBox.Text, 
00256                             descriptionTextArea.InnerText,
00257                             (TaskComplexity)ComplexityDropDownList.SelectedIndex,
00258                             Convert.ToDateTime(StartTextBox.Text));
00259                 data.InsertTask(item as Task, <span class="keyword">new</span> TransactionFailedHandler(<span class="keyword">this</span>.TransactionFailed));
00260                 <span class="comment">// hide the add child item link</span>
00261                 addAnotherItemLink.Visible = <span class="keyword">false</span>;
00262                 <span class="comment">// set the link for adding another item to parent item</span>
00263                 AddItemToParentHyperLink.Text = <span class="stringliteral">"Add another Task to "</span> + ModuleDropDownList.SelectedItem.Text;
00264                 AddItemToParentHyperLink.NavigateUrl += <span class="stringliteral">"?item="</span>+ProjectItemType.Task+<span class="stringliteral">"&amp;parentID="</span>+ModuleDropDownList.SelectedValue;
00265             }
00266 
00267             statusLabel.Text = NameTextBox.Text + <span class="stringliteral">" created."</span>;
00268 
00269             CreateItemPanel.Visible = <span class="keyword">false</span>;
00270             creationSuccessPanel.Visible = <span class="keyword">true</span>;
00271         }
<a name="l00275"></a><a class="code" href="classPMT_1_1PM_1_1NewItem.html#PMT_1_1PM_1_1NewItemd5">00275</a>         <span class="keyword">private</span> <span class="keywordtype">void</span> ValidateStartDate(object sender, ServerValidateEventArgs args)
00276         {
00277             <span class="comment">// ignore error if start or end date is not in valid form</span>
00278             <span class="keywordflow">if</span> (!StartRegularExpressionValidator.IsValid)
00279             {
00280                 args.IsValid = <span class="keyword">true</span>;
00281                 <span class="keywordflow">return</span>;
00282             }
00283 
00284             <span class="comment">// initially set to true</span>
00285             args.IsValid = <span class="keyword">true</span>;
00286 
00287             DateTime start = Convert.ToDateTime(StartTextBox.Text);
00288             DateTime parentStart = <span class="keyword">new</span> DateTime();
00289 
00290             <span class="comment">// check parent's start date against start date if not a project</span>
00291             <span class="keywordflow">if</span> (!ItemType.Equals(ProjectItemType.Project))
00292             {
00293                 <span class="keywordflow">if</span> (ItemType.Equals(ProjectItemType.Module))
00294                 {
00295                     parentStart = parentProject.StartDate;
00296                 }
00297                 <span class="keywordflow">else</span> <span class="comment">//if (itemType.Equals(ProjectItemType.TASK))</span>
00298                 {
00299                     parentStart = parentModule.StartDate;
00300                 }
00301 
00302                 <span class="keywordflow">if</span> (start &lt; parentStart)
00303                 {
00304                     args.IsValid = <span class="keyword">false</span>;
00305                     <span class="keyword">this</span>.StartDateCustomValidator.ErrorMessage
00306                         += <span class="stringliteral">" ("</span> + parentStart.ToShortDateString() + <span class="stringliteral">")"</span>;
00307                 }
00308             }
00309         }
00310 
00311 
<a name="l00315"></a><a class="code" href="classPMT_1_1PM_1_1NewItem.html#PMT_1_1PM_1_1NewItemd6">00315</a>         <span class="keyword">private</span> <span class="keywordtype">void</span> ValidateDescription(object sender, ServerValidateEventArgs args)
00316         {
00317             <span class="keywordflow">if</span> (descriptionTextArea.InnerText.Length &lt; 256)
00318                 args.IsValid = <span class="keyword">true</span>;
00319             <span class="keywordflow">else</span>
00320                 args.IsValid = <span class="keyword">false</span>;
00321         }
00322 
00323         <span class="keyword">private</span> <span class="keywordtype">void</span> ProjectDropDownList_SelectedIndexChanged(object sender, System.EventArgs e)
00324         {
00325             <span class="keywordflow">if</span> (ItemType.Equals(ProjectItemType.Task))
00326             {
00327                 fillModuleDropDownList();
00328             }
00329         }
00330 
00331         <span class="keyword">private</span> <span class="keywordtype">void</span> ComplexityDropDownList_SelectedIndexChanged(object sender, System.EventArgs e)
00332         {
00333         
00334         }
00335 
00336         <span class="keyword">private</span> <span class="keywordtype">void</span> TransactionFailed(Exception ex)
00337         {
00338             statusLabel.Text = ex.Message;
00339         }
00340 
00341 <span class="preprocessor">        #region Properties</span>
00342 <span class="preprocessor"></span>        <span class="keyword">public</span> ProjectItemType ItemType
00343         {
00344             get 
00345             {
00346                 <span class="keywordflow">try</span>
00347                 {
00348                     <span class="keywordflow">return</span> (ProjectItemType)Enum.Parse(typeof(ProjectItemType), Request[<span class="stringliteral">"item"</span>]);   
00349                 }
00350                 <span class="keywordflow">catch</span>
00351                 {
00352                     <span class="keywordflow">throw</span> <span class="keyword">new</span> Exception(<span class="stringliteral">"Invalid Item Type"</span>);
00353                 }
00354             }
00355         }
00356         <span class="keyword">public</span> <span class="keywordtype">int</span> ParentID
00357         {
00358             get 
00359             {
00360                 <span class="keywordflow">try</span>
00361                 {
00362                     <span class="keywordflow">return</span> Convert.ToInt32(Request[<span class="stringliteral">"parentID"</span>]);    
00363                 }
00364                 <span class="keywordflow">catch</span>
00365                 {
00366                     <span class="keywordflow">return</span> -1;
00367                 }
00368             }
00369         }
00370         <span class="keyword">public</span> <span class="keywordtype">int</span> UserID
00371         {
00372             get
00373             {
00374                 <span class="keywordflow">try</span>
00375                 {
00376                     <span class="keywordflow">return</span> Convert.ToInt32(Request.Cookies[<span class="stringliteral">"user"</span>][<span class="stringliteral">"id"</span>]);
00377                 }
00378                 <span class="keywordflow">catch</span>
00379                 {
00380                     <span class="keywordflow">return</span> -1;
00381                 }
00382             }
00383 
00384         }
00385 <span class="preprocessor">        #endregion</span>
00386 <span class="preprocessor"></span>    }
00387 }
</pre></div><hr><address style="align: right;"><small>
Generated on Sun Aug 6 23:06:02 2006 for PMT by <a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 width=110 height=53>
</a> 1.3.1 using KingsTools</small></address>
</body>
</html>
