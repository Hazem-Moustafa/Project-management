<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>PMT: Login.aspx.cs Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.1 -->
<h1>Login.aspx.cs</h1><div class="fragment"><pre>00001 <span class="keyword">using</span> System;
00002 <span class="keyword">using</span> System.Collections;
00003 <span class="keyword">using</span> System.ComponentModel;
00004 <span class="keyword">using</span> System.Data;
00005 <span class="keyword">using</span> System.Data.SqlClient;
00006 <span class="keyword">using</span> System.Drawing;
00007 <span class="keyword">using</span> System.Web;
00008 <span class="keyword">using</span> System.Web.SessionState;
00009 <span class="keyword">using</span> System.Web.UI;
00010 <span class="keyword">using</span> System.Web.UI.WebControls;
00011 <span class="keyword">using</span> System.Web.UI.HtmlControls;
00012 <span class="keyword">using</span> System.Web.Security;
00013 <span class="keyword">using</span> MySql;
00014 <span class="keyword">using</span> MySql.Data;
00015 <span class="keyword">using</span> MySql.Data.MySqlClient;
00016 <span class="keyword">using</span> PMTComponents;
00017 <span class="keyword">using</span> PMTDataProvider;
00018 
00019 <span class="keyword">namespace </span>PMT
00020 {
00021     <span class="keyword">public</span> <span class="keyword">class </span>Login : Page
00022     {
00023         <span class="keyword">protected</span> TextBox UserTextBox;
00024         <span class="keyword">protected</span> Button SubmitButton;
00025         <span class="keyword">protected</span> TextBox PasswordTextBox;
00026         <span class="keyword">protected</span> RequiredFieldValidator UserRequiredFieldValidator;
00027         <span class="keyword">protected</span> RequiredFieldValidator PasswordRequiredFieldValidator;
00028         <span class="keyword">protected</span> Label ErrorLabel;
00029 
00030         <span class="keyword">private</span> PMTUser user;
00031     
00032         <span class="keyword">private</span> <span class="keywordtype">void</span> Page_Load(object sender, System.EventArgs e)
00033         {
00034             <span class="comment">// if the user is currently logged in, log them out</span>
00035             <span class="keywordflow">if</span> (User.Identity.IsAuthenticated)
00036             {
00037                 FormsAuthentication.SignOut();
00038             }
00039         }
00040 
00041 <span class="preprocessor">        #region Web Form Designer generated code</span>
00042 <span class="preprocessor"></span>        override <span class="keyword">protected</span> <span class="keywordtype">void</span> OnInit(EventArgs e)
00043         {
00044             <span class="comment">//</span>
00045             <span class="comment">// CODEGEN: This call is required by the ASP.NET Web Form Designer.</span>
00046             <span class="comment">//</span>
00047             InitializeComponent();
00048             base.OnInit(e);
00049         }
00050         
00055         <span class="keyword">private</span> <span class="keywordtype">void</span> InitializeComponent()
00056         {    
00057             <span class="keyword">this</span>.SubmitButton.Click += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.SubmitButton_Click);
00058             <span class="keyword">this</span>.Load += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.Page_Load);
00059 
00060         }
00061 <span class="preprocessor">        #endregion</span>
00062 <span class="preprocessor"></span>
00063         <span class="keyword">private</span> <span class="keywordtype">void</span> SubmitButton_Click(object sender, System.EventArgs e)
00064         {
00065             <span class="keywordflow">if</span> (!<span class="keyword">this</span>.IsValid)
00066                 <span class="keywordflow">return</span>;
00067 
00068             string username = UserTextBox.Text;
00069             string password = Encryption.encrypt(PasswordTextBox.Text);
00070 
00071             <span class="keywordflow">if</span> (CustomAuthenticate(username, password)) 
00072             {
00073                 <span class="comment">// WTF does the first param do ???</span>
00074                 string url = FormsAuthentication.GetRedirectUrl(user.UserName, <span class="keyword">false</span>);
00075                 FormsAuthentication.SetAuthCookie(user.Role.ToString(), <span class="keyword">false</span>);
00076 
00077                 <span class="keywordflow">if</span> (url.Equals(Request.ApplicationPath + <span class="stringliteral">"/default.aspx"</span>))
00078                 {
00079                     <span class="keywordflow">if</span> (user.Role.Equals(PMTUserRole.Manager))
00080                         url = Request.ApplicationPath + <span class="stringliteral">"/PM"</span>;
00081                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (user.Role.Equals(PMTUserRole.Developer))
00082                         url = Request.ApplicationPath + <span class="stringliteral">"/Dev"</span>;
00083                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (user.Role.Equals(PMTUserRole.Administrator))
00084                         url = Request.ApplicationPath + <span class="stringliteral">"/Admin"</span>;
00085                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (user.Role.Equals(PMTUserRole.Client))
00086                        url = Request.ApplicationPath + <span class="stringliteral">"/Client"</span>;
00087                 }
00088             
00089                 Response.Redirect (url);
00090             }
00091         }
00092 
00093         <span class="keywordtype">bool</span> CustomAuthenticate(string username, string password)
00094         {
00095             
00096             IDataProvider conn = DataProvider.CreateInstance();
00097             <span class="keywordflow">if</span> (conn.AuthenticateUser(username, password, <span class="keyword">new</span> TransactionFailedHandler(<span class="keyword">this</span>.TransactionFailed)))
00098                 user = conn.GetPMTUserByUsername(username);
00099             <span class="keywordflow">else</span>
00100                  <span class="keywordflow">return</span> <span class="keyword">false</span>;
00101 
00102             <span class="keywordflow">if</span> (user == null)
00103             {
00104                 <span class="keyword">this</span>.TransactionFailed(<span class="keyword">new</span> NullReferenceException(<span class="stringliteral">"User could not be authenticated"</span>));
00105                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00106             }
00107 
00108             <span class="comment">// create the cookie</span>
00109             Response.Cookies[<span class="stringliteral">"user"</span>].Values.Add(<span class="stringliteral">"role"</span>,  user.Role.ToString());
00110             Response.Cookies[<span class="stringliteral">"user"</span>].Values.Add(<span class="stringliteral">"id"</span>,    user.ID.ToString());
00111             Response.Cookies[<span class="stringliteral">"user"</span>].Values.Add(<span class="stringliteral">"name"</span>,  user.UserName);
00112             Response.Cookies[<span class="stringliteral">"user"</span>].Values.Add(<span class="stringliteral">"fname"</span>, user.FirstName);
00113             Response.Cookies[<span class="stringliteral">"user"</span>].Values.Add(<span class="stringliteral">"lname"</span>, user.LastName);
00114 
00115             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00116         }
00117 
00118         <span class="keyword">private</span> <span class="keywordtype">void</span> TransactionFailed(Exception ex)
00119         {
00120             ErrorLabel.Text = ex.Message;
00121         }
00122     }
00123 }
</pre></div><hr><address style="align: right;"><small>
Generated on Sun Aug 6 23:06:02 2006 for PMT by <a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 width=110 height=53>
</a> 1.3.1 using KingsTools</small></address>
</body>
</html>
