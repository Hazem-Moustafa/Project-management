<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>PMT: D:/My Documents/Visual Studio Projects/projmgtnet2/Login.aspx.cs Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.1 -->
<h1>D:/My Documents/Visual Studio Projects/projmgtnet2/Login.aspx.cs</h1><div class="fragment"><pre>00001 <span class="keyword">using</span> System;
00002 <span class="keyword">using</span> System.Collections;
00003 <span class="keyword">using</span> System.ComponentModel;
00004 <span class="keyword">using</span> System.Data;
00005 <span class="keyword">using</span> System.Data.SqlClient;
00006 <span class="keyword">using</span> System.Drawing;
00007 <span class="keyword">using</span> System.Web;
00008 <span class="keyword">using</span> System.Web.SessionState;
00009 <span class="keyword">using</span> System.Web.UI;
00010 <span class="keyword">using</span> System.Web.UI.WebControls;
00011 <span class="keyword">using</span> System.Web.UI.HtmlControls;
00012 <span class="keyword">using</span> System.Web.Security;
00013 <span class="keyword">using</span> MySql;
00014 <span class="keyword">using</span> MySql.Data;
00015 <span class="keyword">using</span> MySql.Data.MySqlClient;
00016 <span class="keyword">using</span> PMTComponents;
00017 <span class="keyword">using</span> PMTDataProvider;
00018 
00019 <span class="keyword">namespace </span>PMT
00020 {
00021     <span class="keyword">public</span> <span class="keyword">class </span>Login : Page
00022     {
00023         <span class="keyword">protected</span> TextBox UserTextBox;
00024         <span class="keyword">protected</span> Button SubmitButton;
00025         <span class="keyword">protected</span> TextBox PasswordTextBox;
00026         <span class="keyword">protected</span> RequiredFieldValidator UserRequiredFieldValidator;
00027         <span class="keyword">protected</span> RequiredFieldValidator PasswordRequiredFieldValidator;
00028         <span class="keyword">protected</span> Label ErrorLabel;
00029 
00030         <span class="keyword">private</span> PMTUser user;
00031     
00032         <span class="keyword">private</span> <span class="keywordtype">void</span> Page_Load(object sender, System.EventArgs e)
00033         {
00034             <span class="comment">// if the user is currently logged in, log them out</span>
00035             <span class="keywordflow">if</span> (User.Identity.IsAuthenticated)
00036                 FormsAuthentication.SignOut();
00037         }
00038 
00039 <span class="preprocessor">        #region Web Form Designer generated code</span>
00040 <span class="preprocessor"></span>        override <span class="keyword">protected</span> <span class="keywordtype">void</span> OnInit(EventArgs e)
00041         {
00042             <span class="comment">//</span>
00043             <span class="comment">// CODEGEN: This call is required by the ASP.NET Web Form Designer.</span>
00044             <span class="comment">//</span>
00045             InitializeComponent();
00046             base.OnInit(e);
00047         }
00048         
00053         <span class="keyword">private</span> <span class="keywordtype">void</span> InitializeComponent()
00054         {    
00055             <span class="keyword">this</span>.SubmitButton.Click += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.SubmitButton_Click);
00056             <span class="keyword">this</span>.Load += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.Page_Load);
00057 
00058         }
00059 <span class="preprocessor">        #endregion</span>
00060 <span class="preprocessor"></span>
00061         <span class="keyword">private</span> <span class="keywordtype">void</span> SubmitButton_Click(object sender, System.EventArgs e)
00062         {
00063             <span class="keywordflow">if</span> (!<span class="keyword">this</span>.IsValid)
00064                 <span class="keywordflow">return</span>;
00065 
00066             string username = UserTextBox.Text;
00067             string password = Encryption.encrypt(PasswordTextBox.Text);
00068 
00069             <span class="keywordflow">if</span> (CustomAuthenticate(username, password)) 
00070             {
00071                 <span class="comment">// WTF does the first param do ???</span>
00072                 string url = FormsAuthentication.GetRedirectUrl(user.UserName, <span class="keyword">false</span>);
00073                 FormsAuthentication.SetAuthCookie(user.Role.ToString(), <span class="keyword">false</span>);
00074 
00075                 <span class="keywordflow">if</span> (url.Equals(Request.ApplicationPath + <span class="stringliteral">"/default.aspx"</span>))
00076                 {
00077                     <span class="keywordflow">if</span> (user.Role.Equals(PMTUserRole.Manager))
00078                         url = Request.ApplicationPath + <span class="stringliteral">"/PM"</span>;
00079                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (user.Role.Equals(PMTUserRole.Developer))
00080                         url = Request.ApplicationPath + <span class="stringliteral">"/Dev"</span>;
00081                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (user.Role.Equals(PMTUserRole.Administrator))
00082                         url = Request.ApplicationPath + <span class="stringliteral">"/Admin"</span>;
00083                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (user.Role.Equals(PMTUserRole.Client))
00084                        url = Request.ApplicationPath + <span class="stringliteral">"/Client"</span>;
00085                 }
00086             
00087                 Response.Redirect (url);
00088             }
00089         }
00090 
00091         <span class="keywordtype">bool</span> CustomAuthenticate(string username, string password)
00092         {
00093             
00094             IDataProvider conn = DataProvider.CreateInstance();
00095             <span class="keywordflow">if</span> (conn.AuthenticateUser(username, password, <span class="keyword">new</span> TransactionFailedHandler(<span class="keyword">this</span>.TransactionFailed)))
00096                 user = conn.GetPMTUserByUsername(username);
00097             <span class="keywordflow">else</span>
00098                  <span class="keywordflow">return</span> <span class="keyword">false</span>;
00099 
00100             <span class="keywordflow">if</span> (user == null)
00101             {
00102                 <span class="keyword">this</span>.TransactionFailed(<span class="keyword">new</span> NullReferenceException(<span class="stringliteral">"User could not be authenticated"</span>));
00103                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00104             }
00105 
00106             <span class="comment">// create the cookie</span>
00107             Response.Cookies[<span class="stringliteral">"user"</span>].Values.Add(<span class="stringliteral">"role"</span>,  user.Role.ToString());
00108             Response.Cookies[<span class="stringliteral">"user"</span>].Values.Add(<span class="stringliteral">"id"</span>,    user.ID.ToString());
00109             Response.Cookies[<span class="stringliteral">"user"</span>].Values.Add(<span class="stringliteral">"name"</span>,  user.UserName);
00110             Response.Cookies[<span class="stringliteral">"user"</span>].Values.Add(<span class="stringliteral">"fname"</span>, user.FirstName);
00111             Response.Cookies[<span class="stringliteral">"user"</span>].Values.Add(<span class="stringliteral">"lname"</span>, user.LastName);
00112 
00113             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00114         }
00115 
00116         <span class="keyword">private</span> <span class="keywordtype">void</span> TransactionFailed(Exception ex)
00117         {
00118             ErrorLabel.Text = ex.Message;
00119         }
00120     }
00121 }
</pre></div><hr><address style="align: right;"><small>
Generated on Sat Aug 5 14:40:47 2006 for PMT by <a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 width=110 height=53>
</a> 1.3.1 using KingsTools</small></address>
</body>
</html>
