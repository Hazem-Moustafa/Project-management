<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>PMT: D:/My Documents/Visual Studio Projects/projmgt-net/v2/projmgtnet2/PMTDataProvider/MySqlDataProvider.cs Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.1 -->
<h1>D:/My Documents/Visual Studio Projects/projmgt-net/v2/projmgtnet2/PMTDataProvider/MySqlDataProvider.cs</h1><div class="fragment"><pre>00001 <span class="keyword">using</span> System;
00002 <span class="keyword">using</span> System.Data;
00003 <span class="keyword">using</span> System.Text;
00004 <span class="keyword">using</span> MySql;
00005 <span class="keyword">using</span> MySql.Data;
00006 <span class="keyword">using</span> MySql.Data.MySqlClient;
00007 <span class="keyword">using</span> PMTComponents;
00008 
00009 <span class="keyword">namespace </span>PMTDataProvider
00010 {
<a name="l00014"></a><a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html">00014</a>     <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html">MySqlDataProvider</a> : <a class="code" href="interfacePMTDataProvider_1_1IDataProvider.html">IDataProvider</a>
00015     {
00016         <span class="keyword">public</span> <a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html">MySqlDataProvider</a>() {}
00017 
00018 <span class="preprocessor">        #region IDataProvider Members</span>
00019 <span class="preprocessor"></span>
00020 <span class="preprocessor">        #region PMTUser</span>
00021 <span class="preprocessor"></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> AuthenticateUser(string username, string password, TransactionFailedHandler handler)
00022         {
00023             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(<a class="code" href="classPMTDataProvider_1_1Configuration.html">Configuration</a>.ConnectionString))
00024             {
00025                 MySqlCommand command = conn.CreateCommand();
00026                 command.CommandText = <span class="stringliteral">"select count(*) from users where UserName=?user"</span>;
00027                 command.Parameters.Add(<span class="stringliteral">"?user"</span>, username);
00028 
00029                 <span class="keywordtype">int</span> k = Convert.ToInt32(<span class="keyword">this</span>.<a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProviderd2">ExecuteScalar</a>(command));
00030 
00031                 <span class="keywordflow">if</span> (k == 0)
00032                 {
00033                     <span class="comment">//user does not exist in DB</span>
00034                     handler(<span class="keyword">new</span> Exception(<span class="stringliteral">"You have entered an unknown username."</span>));
00035                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00036                 }
00037                 <span class="keywordflow">else</span>
00038                 {
00039                     command = conn.CreateCommand();
00040                     command.CommandText = <span class="stringliteral">"select count(*) from users u where u.UserName=?user and u.Password=?pass"</span>;
00041                     command.Parameters.Add(<span class="stringliteral">"?user"</span>, username);
00042                     command.Parameters.Add(<span class="stringliteral">"?pass"</span>, password);
00043 
00044                     k = Convert.ToInt32(<span class="keyword">this</span>.<a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProviderd2">ExecuteScalar</a>(command));
00045                     <span class="keywordflow">if</span> (k == 0)
00046                     {
00047                         <span class="comment">//password incorrect</span>
00048                         handler(<span class="keyword">new</span> Exception(<span class="stringliteral">"You have entered an incorrect password."</span>));
00049                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00050                     }
00051                     <span class="keywordflow">else</span>
00052                     {
00053                         command = conn.CreateCommand();
00054                         command.CommandText = <span class="stringliteral">"select count(*) from users u where u.UserName=?user and u.Enabled=1"</span>;
00055                         command.Parameters.Add(<span class="stringliteral">"?user"</span>, username);
00056 
00057                         k = Convert.ToInt32(<span class="keyword">this</span>.<a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProviderd2">ExecuteScalar</a>(command));
00058                         <span class="keywordflow">if</span> (k == 0)
00059                         {
00060                             <span class="comment">//user not enabled</span>
00061                             handler(<span class="keyword">new</span> Exception(<span class="stringliteral">"Your account has not been enabled.  Please contact your Administrator."</span>));
00062                             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00063                         }
00064                     }
00065                 }
00066             }
00067             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00068         }
00069 
00070 <span class="preprocessor">        #region PMTUser Management</span>
<a name="l00075"></a><a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera2">00075</a> <span class="preprocessor">        public bool EnablePMTUser(int id, TransactionFailedHandler handler)</span>
00076 <span class="preprocessor"></span>        {
00077             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(<a class="code" href="classPMTDataProvider_1_1Configuration.html">Configuration</a>.ConnectionString))
00078             {
00079                 PMTUser user = <span class="keyword">this</span>.GetPMTUserById(id, conn);
00080 
00081                 <span class="keywordflow">if</span> (user == null)
00082                 {
00083                     handler(<span class="keyword">new</span> NullReferenceException(String.Format(<span class="stringliteral">"User with id {0} does not exist."</span>, id)));
00084                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00085                 }
00086 
00087                 MySqlCommand command = conn.CreateCommand();
00088                 command.CommandText = <span class="stringliteral">"update users set enabled=1 where id=?id"</span>;
00089                 command.Parameters.Add(<span class="stringliteral">"?id"</span>, id);
00090 
00091                 <span class="keywordflow">try</span>
00092                 {
00093                     <span class="keywordtype">int</span> rows = <span class="keyword">this</span>.ExecuteNonQuery(command);
00094                     <span class="keywordflow">if</span> (rows == 0)
00095                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00096                 }
00097                 <span class="keywordflow">catch</span> (MySqlException ex)
00098                 {
00099                     handler(ex);
00100                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00101                 }
00102             }
00103             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00104         }
00105 
<a name="l00110"></a><a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera3">00110</a>         <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera3">DisablePMTUser</a>(<span class="keywordtype">int</span> id, TransactionFailedHandler handler)
00111         {
00112             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(<a class="code" href="classPMTDataProvider_1_1Configuration.html">Configuration</a>.ConnectionString))
00113             {
00114                 PMTUser user = <span class="keyword">this</span>.GetPMTUserById(id, conn);
00115 
00116                 <span class="keywordflow">if</span> (user == null)
00117                 {
00118                     handler(<span class="keyword">new</span> NullReferenceException(String.Format(<span class="stringliteral">"User with id {0} does not exist."</span>, id)));
00119                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00120                 }
00121 
00122                 MySqlCommand command = conn.CreateCommand();
00123                 command.CommandText = <span class="stringliteral">"update users set enabled=0 where id=?id"</span>;
00124                 command.Parameters.Add(<span class="stringliteral">"?id"</span>, id);
00125 
00126                 <span class="keywordflow">try</span>
00127                 {
00128                     <span class="keywordtype">int</span> rows = <span class="keyword">this</span>.ExecuteNonQuery(command);
00129                     <span class="keywordflow">if</span> (rows == 0)
00130                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00131                 }
00132                 <span class="keywordflow">catch</span> (MySqlException ex)
00133                 {
00134                     handler(ex);
00135                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00136                 }
00137             }
00138             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00139         }
00140 
<a name="l00145"></a><a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera4">00145</a>         <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera4">DeletePMTUser</a>(<span class="keywordtype">int</span> id, TransactionFailedHandler handler)
00146         {
00147             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(<a class="code" href="classPMTDataProvider_1_1Configuration.html">Configuration</a>.ConnectionString))
00148             {
00149                 MySqlCommand command = conn.CreateCommand();
00150                 command.CommandText = <span class="stringliteral">"delete from users where id=?id"</span>;
00151 
00152                 <span class="keywordflow">try</span>
00153                 {
00154                     <span class="keyword">this</span>.ExecuteNonQuery(command);
00155                 }
00156                 <span class="keywordflow">catch</span> (MySqlException ex)
00157                 {
00158                     handler(ex);
00159                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00160                 }
00161             }
00162             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00163         }
00164 
00165         <span class="keyword">public</span> <span class="keywordtype">bool</span> InsertPMTUser(PMTUser user, TransactionFailedHandler handler)
00166         {
00167             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(Configuration.ConnectionString))
00168             {
00169                 <span class="comment">// add the user</span>
00170                 StringBuilder sbCommand = <span class="keyword">new</span> StringBuilder();
00171                 sbCommand.Append(<span class="stringliteral">"insert into users (Username, Password, Role, Enabled) \n"</span>);
00172                 sbCommand.Append(<span class="stringliteral">"values (?user, ?password, ?role, ?enabled)"</span>);
00173 
00174                 MySqlCommand command = conn.CreateCommand();
00175                 command.CommandText = sbCommand.ToString();
00176                 command.Parameters.Add(<span class="stringliteral">"?user"</span>, user.UserName);
00177                 command.Parameters.Add(<span class="stringliteral">"?password"</span>, user.Password);
00178                 command.Parameters.Add(<span class="stringliteral">"?role"</span>, (<span class="keywordtype">int</span>)user.Role);
00179                 command.Parameters.Add(<span class="stringliteral">"?enabled"</span>, user.Enabled ? 1 : 0);
00180 
00181                 <span class="keywordflow">try</span>
00182                 {
00183                     <span class="keyword">this</span>.ExecuteNonQuery(command);
00184                 }
00185                 <span class="keywordflow">catch</span> (MySqlException ex)
00186                 {
00187                     handler(ex);
00188                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00189                 }
00190 
00191                 <span class="comment">// get the user we just inserted so we can have its ID</span>
00192                 PMTUser temp = <span class="keyword">this</span>.GetPMTUserByUsername(user.UserName);
00193                 <span class="keywordflow">if</span> (temp == null)
00194                 {
00195                     handler(<span class="keyword">new</span> NullReferenceException(<span class="stringliteral">"User could not be added."</span>));
00196                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00197                 }
00198 
00199                 user.ID = temp.ID;
00200 
00201                 <span class="comment">// add the user's info</span>
00202                 sbCommand = <span class="keyword">new</span> StringBuilder();
00203                 sbCommand.Append(<span class="stringliteral">"insert into userInfo (ID, FirstName, LastName, Address, City, State, Zip, PhoneNumber, Email) \n"</span>);
00204                 sbCommand.Append(<span class="stringliteral">"values (?id, ?firstName, ?lastName, ?address, ?city, ?state, ?zip, ?phone, ?email)"</span>);
00205 
00206                 command = conn.CreateCommand();
00207                 command.CommandText = sbCommand.ToString();
00208                 command.Parameters.Add(<span class="stringliteral">"?id"</span>, user.ID);
00209                 command.Parameters.Add(<span class="stringliteral">"?firstName"</span>, user.FirstName);
00210                 command.Parameters.Add(<span class="stringliteral">"?lastName"</span>, user.LastName);
00211                 command.Parameters.Add(<span class="stringliteral">"?address"</span>, user.Address);
00212                 command.Parameters.Add(<span class="stringliteral">"?city"</span>, user.City);
00213                 command.Parameters.Add(<span class="stringliteral">"?state"</span>, user.State);
00214                 command.Parameters.Add(<span class="stringliteral">"?zip"</span>, user.ZipCode);
00215                 command.Parameters.Add(<span class="stringliteral">"?phone"</span>, user.PhoneNumber);
00216                 command.Parameters.Add(<span class="stringliteral">"?email"</span>, user.Email);
00217 
00218                 <span class="keywordflow">try</span>
00219                 {
00220                     <span class="keyword">this</span>.ExecuteNonQuery(command);
00221                 }
00222                 <span class="keywordflow">catch</span> (MySqlException ex)
00223                 {
00224                     handler(ex);
00225                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00226                 }
00227             }
00228             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00229         }
00230 
<a name="l00234"></a><a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera6">00234</a>         <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera6">UpdatePMTUser</a>(PMTUser user, TransactionFailedHandler handler)
00235         {
00236             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(<a class="code" href="classPMTDataProvider_1_1Configuration.html">Configuration</a>.ConnectionString))
00237             {
00238                 <span class="comment">// update the user</span>
00239                 StringBuilder sbCommand = <span class="keyword">new</span> StringBuilder();
00240                 sbCommand.Append(<span class="stringliteral">"update users  set Username=?user, Password=?password, Role=?role, Enabled=?enabled \n"</span>);
00241                 sbCommand.Append(<span class="stringliteral">"where ID=?id"</span>);
00242 
00243                 MySqlCommand command = conn.CreateCommand();
00244                 command.CommandText = sbCommand.ToString();
00245                 command.Parameters.Add(<span class="stringliteral">"?user"</span>, user.UserName);
00246                 command.Parameters.Add(<span class="stringliteral">"?password"</span>, user.Password);
00247                 command.Parameters.Add(<span class="stringliteral">"?role"</span>, (<span class="keywordtype">int</span>)user.Role);
00248                 command.Parameters.Add(<span class="stringliteral">"?enabled"</span>, user.Enabled ? 1 : 0);
00249                 command.Parameters.Add(<span class="stringliteral">"?id"</span>, user.ID);
00250 
00251                 <span class="keywordflow">try</span>
00252                 {
00253                     <span class="keyword">this</span>.ExecuteNonQuery(command);
00254                 }
00255                 <span class="keywordflow">catch</span> (MySqlException ex)
00256                 {
00257                     handler(ex);
00258                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00259                 }
00260 
00261                 <span class="comment">// update the user's info</span>
00262                 sbCommand = <span class="keyword">new</span> StringBuilder();
00263                 sbCommand.Append(<span class="stringliteral">"update userInfo \n"</span>);
00264                 sbCommand.Append(<span class="stringliteral">"set FirstName=?firstName, LastName=?lastName, Address=?address, City=?city, State=?state, Zip=?zip, PhoneNumber=?phone, Email=?email \n"</span>);
00265                 sbCommand.Append(<span class="stringliteral">"where ID=?id"</span>);
00266 
00267                 command = conn.CreateCommand();
00268                 command.CommandText = sbCommand.ToString();
00269                 command.Parameters.Add(<span class="stringliteral">"?id"</span>, user.ID);
00270                 command.Parameters.Add(<span class="stringliteral">"?firstName"</span>, user.FirstName);
00271                 command.Parameters.Add(<span class="stringliteral">"?lastName"</span>, user.LastName);
00272                 command.Parameters.Add(<span class="stringliteral">"?address"</span>, user.Address);
00273                 command.Parameters.Add(<span class="stringliteral">"?city"</span>, user.City);
00274                 command.Parameters.Add(<span class="stringliteral">"?state"</span>, user.State);
00275                 command.Parameters.Add(<span class="stringliteral">"?zip"</span>, user.ZipCode);
00276                 command.Parameters.Add(<span class="stringliteral">"?phone"</span>, user.PhoneNumber);
00277                 command.Parameters.Add(<span class="stringliteral">"?email"</span>, user.Email);
00278                 command.Parameters.Add(<span class="stringliteral">"?id"</span>, user.ID);
00279 
00280                 <span class="keywordflow">try</span>
00281                 {
00282                     <span class="keyword">this</span>.ExecuteNonQuery(command);
00283                 }
00284                 <span class="keywordflow">catch</span> (MySqlException ex)
00285                 {
00286                     handler(ex);
00287                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00288                 }
00289             }
00290             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00291         }
00292 <span class="preprocessor">        #endregion PMTUser Management</span>
00293 <span class="preprocessor"></span>
00294 <span class="preprocessor">        #region Get Users</span>
<a name="l00298"></a><a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera7">00298</a> <span class="preprocessor">        public DataTable GetPMTUsers()</span>
00299 <span class="preprocessor"></span>        {
00300             DataTable dt = <span class="keyword">new</span> DataTable();
00301             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(<a class="code" href="classPMTDataProvider_1_1Configuration.html">Configuration</a>.ConnectionString))
00302             {
00303                 MySqlCommand command = conn.CreateCommand();
00304                 command.CommandText = <span class="stringliteral">"select * from users u left join userInfo i on u.id=i.id"</span>;
00305 
00306                 MySqlDataAdapter da = <span class="keyword">new</span> MySqlDataAdapter(command);
00307                 <span class="keywordflow">try</span>
00308                 {
00309                     da.Fill(dt);
00310                 }
00311                 finally
00312                 {
00313                 }
00314             }
00315             <span class="keywordflow">return</span> dt;
00316         }
00317 
<a name="l00322"></a><a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera8">00322</a>         <span class="keyword">public</span> DataTable <a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera8">GetEnabledPMTUsers</a>(<span class="keywordtype">bool</span> enabled)
00323         {
00324             DataTable dt = <span class="keyword">new</span> DataTable();
00325             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(<a class="code" href="classPMTDataProvider_1_1Configuration.html">Configuration</a>.ConnectionString))
00326             {
00327                 MySqlCommand command = conn.CreateCommand();
00328                 command.CommandText = <span class="stringliteral">"select * from users u left join userInfo i on u.id=i.id where u.Enabled=?enabled"</span>;
00329                 command.Parameters.Add(<span class="stringliteral">"?enabled"</span>, enabled ? 1 : 0);
00330 
00331                 MySqlDataAdapter da = <span class="keyword">new</span> MySqlDataAdapter(command);
00332                 <span class="keywordflow">try</span>
00333                 {
00334                     da.Fill(dt);
00335                 }
00336                 finally
00337                 {
00338                 }
00339             }
00340             <span class="keywordflow">return</span> dt;
00341         }
00342 <span class="preprocessor">        #endregion Get Users</span>
00343 <span class="preprocessor"></span>
00344 <span class="preprocessor">        #region Get PMTUser</span>
<a name="l00349"></a><a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera9">00349</a> <span class="preprocessor">        public PMTUser GetPMTUserById(int id)</span>
00350 <span class="preprocessor"></span>        {
00351             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(<a class="code" href="classPMTDataProvider_1_1Configuration.html">Configuration</a>.ConnectionString))
00352             {
00353                 <span class="keywordflow">return</span> <span class="keyword">this</span>.GetPMTUserById(id, conn);
00354             }
00355         }                
00356 
<a name="l00361"></a><a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProviderd0">00361</a>         <span class="keyword">private</span> PMTUser <a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera9">GetPMTUserById</a>(<span class="keywordtype">int</span> id, MySqlConnection conn)
00362         {
00363             PMTUser user = null;
00364             MySqlCommand command = conn.CreateCommand();
00365             command.CommandText = <span class="stringliteral">"select * from users u left join userInfo i on u.id=i.id where u.id=?id"</span>;
00366             command.Parameters.Add(<span class="stringliteral">"?id"</span>, id);
00367 
00368             <span class="keywordflow">if</span> (conn.State != ConnectionState.Open)
00369                 conn.Open();
00370             MySqlDataReader dr = command.ExecuteReader();
00371 
00372             <span class="keywordflow">while</span> (dr.Read())
00373             {
00374                 user = <span class="keyword">new</span> PMTUser(
00375                     Convert.ToInt32(dr[<span class="stringliteral">"id"</span>]),
00376                     dr[<span class="stringliteral">"userName"</span>].ToString(),
00377                     dr[<span class="stringliteral">"password"</span>].ToString(),
00378                     (PMTUserRole)Convert.ToInt32(dr[<span class="stringliteral">"role"</span>]),
00379                     dr[<span class="stringliteral">"firstName"</span>].ToString(),
00380                     dr[<span class="stringliteral">"lastName"</span>].ToString(),
00381                     dr[<span class="stringliteral">"email"</span>].ToString(),
00382                     dr[<span class="stringliteral">"phoneNumber"</span>].ToString(),
00383                     dr[<span class="stringliteral">"address"</span>].ToString(),
00384                     dr[<span class="stringliteral">"city"</span>].ToString(),
00385                     dr[<span class="stringliteral">"state"</span>].ToString(),
00386                     dr[<span class="stringliteral">"zip"</span>].ToString(),
00387                     Convert.ToInt32(dr[<span class="stringliteral">"enabled"</span>]) == 1);
00388             }
00389             dr.Close();
00390             <span class="keywordflow">return</span> user;
00391         }
00392 
<a name="l00396"></a><a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera10">00396</a>         <span class="keyword">public</span> PMTUser <a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera10">GetPMTUserByUsername</a>(string username)
00397         {
00398             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(<a class="code" href="classPMTDataProvider_1_1Configuration.html">Configuration</a>.ConnectionString))
00399             {
00400                 MySqlCommand command = conn.CreateCommand();
00401 
00402                 command.CommandText = <span class="stringliteral">"select ID from users where UserName=?user"</span>;
00403                 command.Parameters.Add(<span class="stringliteral">"?user"</span>, username);
00404 
00405                 <span class="keywordtype">int</span> id = Convert.ToInt32(<span class="keyword">this</span>.<a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProviderd2">ExecuteScalar</a>(command));
00406                 <span class="keywordflow">return</span> <span class="keyword">this</span>.GetPMTUserById(id, conn);
00407             }
00408         }
00409 <span class="preprocessor">        #endregion Get PMTUser</span>
00410 <span class="preprocessor"></span>
<a name="l00415"></a><a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera11">00415</a>         <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera11">VerifyEmailExists</a>(string email)
00416         {
00417             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(<a class="code" href="classPMTDataProvider_1_1Configuration.html">Configuration</a>.ConnectionString))
00418             {
00419                 MySqlCommand command = conn.CreateCommand();
00420                 command.CommandText = <span class="stringliteral">"select count(*) from userInfo where email=?email"</span>;
00421                 command.Parameters.Add(<span class="stringliteral">"?email"</span>, email);
00422 
00423                 <span class="keywordtype">int</span> k = Convert.ToInt32(<span class="keyword">this</span>.<a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProviderd2">ExecuteScalar</a>(command));
00424 
00425                 <span class="keywordflow">if</span> (k &gt; 0)
00426                     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00427                 <span class="keywordflow">else</span>
00428                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00429             }
00430         }
00431 
00432         <span class="comment">/*</span>
00433 <span class="comment">         * This isn't needed, we can do a GetPMTUserByUsername(),</span>
00434 <span class="comment">         *  and if the return is null, it does not exist</span>
00435 <span class="comment">         * </span>
00441 <span class="comment">        static public bool verifyUserNameExists(string userName, bool isNew)</span>
00442 <span class="comment">        {</span>
00443 <span class="comment">            DBDriver myDB=new DBDriver();</span>
00444 <span class="comment">            myDB.Query="select count(*) from users where userName=@name;";</span>
00445 <span class="comment">            myDB.addParam("@name", userName);</span>
00446 <span class="comment">            int k=Convert.ToInt32(myDB.scalar());</span>
00447 <span class="comment">            if(k!=1)</span>
00448 <span class="comment">                if(isNew)</span>
00449 <span class="comment">                {</span>
00450 <span class="comment">                    myDB.Query="select count(*) from newUsers where userName=@name;";</span>
00451 <span class="comment">                    myDB.addParam("@name", userName);</span>
00452 <span class="comment">                    k=Convert.ToInt32(myDB.scalar());                                                                  </span>
00453 <span class="comment">                }</span>
00454 <span class="comment">            if(k==1)</span>
00455 <span class="comment">                return true;</span>
00456 <span class="comment"></span>
00457 <span class="comment">            return false;</span>
00458 <span class="comment">        }</span>
00459 <span class="comment">        */</span>
00460 <span class="preprocessor">        #endregion PMTUser</span>
00461 <span class="preprocessor"></span>
00462 <span class="preprocessor">        #region Managed Query Execution</span>
<a name="l00466"></a><a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProviderd1">00466</a> <span class="preprocessor">        private int ExecuteNonQuery(MySqlCommand command)</span>
00467 <span class="preprocessor"></span>        {
00468             <span class="keywordtype">int</span> rows = 0;
00469 
00470             <span class="keywordflow">if</span> (command.Connection.State != ConnectionState.Open)
00471                 command.Connection.Open();
00472 
00473             rows = command.ExecuteNonQuery();
00474 
00475             <span class="keywordflow">return</span> rows;
00476         }
00477 
<a name="l00481"></a><a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProviderd2">00481</a>         <span class="keyword">private</span> object <a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProviderd2">ExecuteScalar</a>(MySqlCommand command)
00482         {
00483             object obj = null;
00484 
00485             <span class="keywordflow">if</span> (command.Connection.State != ConnectionState.Open)
00486                 command.Connection.Open();
00487 
00488             obj = command.ExecuteScalar();
00489             
00490             <span class="keywordflow">return</span> obj;
00491         }
00492 <span class="preprocessor">        #endregion</span>
00493 <span class="preprocessor"></span>
00494 <span class="preprocessor">        #endregion</span>
00495 <span class="preprocessor"></span>    }
00496 }
</pre></div><hr><address style="align: right;"><small>
Generated on Sat Aug 5 14:40:47 2006 for PMT by <a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 width=110 height=53>
</a> 1.3.1 using KingsTools</small></address>
</body>
</html>
