<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>PMT: MySqlDataProvider.cs Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.1 -->
<h1>MySqlDataProvider.cs</h1><div class="fragment"><pre>00001 <span class="keyword">using</span> System;
00002 <span class="keyword">using</span> System.Data;
00003 <span class="keyword">using</span> System.Text;
00004 <span class="keyword">using</span> MySql;
00005 <span class="keyword">using</span> MySql.Data;
00006 <span class="keyword">using</span> MySql.Data.MySqlClient;
00007 <span class="keyword">using</span> PMTComponents;
00008 
00009 <span class="keyword">namespace </span>PMTDataProvider
00010 {
<a name="l00014"></a><a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html">00014</a>     <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html">MySqlDataProvider</a> : <a class="code" href="interfacePMTDataProvider_1_1IDataProvider.html">IDataProvider</a>
00015     {
00016         <span class="keyword">public</span> <a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html">MySqlDataProvider</a>() {}
00017 
00018 <span class="preprocessor">        #region IDataProvider Members</span>
00019 <span class="preprocessor"></span>
00020 <span class="preprocessor">        #region PMTUser</span>
00021 <span class="preprocessor"></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> AuthenticateUser(string username, string password, TransactionFailedHandler handler)
00022         {
00023             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(<a class="code" href="classPMTDataProvider_1_1Configuration.html">Configuration</a>.ConnectionString))
00024             {
00025                 MySqlCommand command = conn.CreateCommand();
00026                 command.CommandText = <span class="stringliteral">"select count(*) from users where UserName=?user"</span>;
00027                 command.Parameters.Add(<span class="stringliteral">"?user"</span>, username);
00028 
00029                 <span class="keywordtype">int</span> k = Convert.ToInt32(<span class="keyword">this</span>.<a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProviderd2">ExecuteScalar</a>(command));
00030 
00031                 <span class="keywordflow">if</span> (k == 0)
00032                 {
00033                     <span class="comment">//user does not exist in DB</span>
00034                     handler(<span class="keyword">new</span> Exception(<span class="stringliteral">"You have entered an unknown username."</span>));
00035                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00036                 }
00037                 <span class="keywordflow">else</span>
00038                 {
00039                     command = conn.CreateCommand();
00040                     command.CommandText = <span class="stringliteral">"select count(*) from users u where u.UserName=?user and u.Password=?pass"</span>;
00041                     command.Parameters.Add(<span class="stringliteral">"?user"</span>, username);
00042                     command.Parameters.Add(<span class="stringliteral">"?pass"</span>, password);
00043 
00044                     k = Convert.ToInt32(<span class="keyword">this</span>.<a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProviderd2">ExecuteScalar</a>(command));
00045                     <span class="keywordflow">if</span> (k == 0)
00046                     {
00047                         <span class="comment">//password incorrect</span>
00048                         handler(<span class="keyword">new</span> Exception(<span class="stringliteral">"You have entered an incorrect password."</span>));
00049                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00050                     }
00051                     <span class="keywordflow">else</span>
00052                     {
00053                         command = conn.CreateCommand();
00054                         command.CommandText = <span class="stringliteral">"select count(*) from users u where u.UserName=?user and u.Enabled=1"</span>;
00055                         command.Parameters.Add(<span class="stringliteral">"?user"</span>, username);
00056 
00057                         k = Convert.ToInt32(<span class="keyword">this</span>.<a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProviderd2">ExecuteScalar</a>(command));
00058                         <span class="keywordflow">if</span> (k == 0)
00059                         {
00060                             <span class="comment">//user not enabled</span>
00061                             handler(<span class="keyword">new</span> Exception(<span class="stringliteral">"Your account has not been enabled.  Please contact your Administrator."</span>));
00062                             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00063                         }
00064                     }
00065                 }
00066             }
00067             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00068         }
00069 
00070 <span class="preprocessor">        #region PMTUser Management</span>
<a name="l00075"></a><a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera2">00075</a> <span class="preprocessor">        public bool EnablePMTUser(int id, TransactionFailedHandler handler)</span>
00076 <span class="preprocessor"></span>        {
00077             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(<a class="code" href="classPMTDataProvider_1_1Configuration.html">Configuration</a>.ConnectionString))
00078             {
00079                 PMTUser user = <span class="keyword">this</span>.GetPMTUserById(id, conn);
00080 
00081                 <span class="keywordflow">if</span> (user == null)
00082                 {
00083                     handler(<span class="keyword">new</span> NullReferenceException(String.Format(<span class="stringliteral">"User with id {0} does not exist."</span>, id)));
00084                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00085                 }
00086 
00087                 MySqlCommand command = conn.CreateCommand();
00088                 command.CommandText = <span class="stringliteral">"update users set enabled=1 where id=?id"</span>;
00089                 command.Parameters.Add(<span class="stringliteral">"?id"</span>, id);
00090 
00091                 <span class="keywordflow">try</span>
00092                 {
00093                     <span class="keywordtype">int</span> rows = <span class="keyword">this</span>.ExecuteNonQuery(command);
00094                     <span class="keywordflow">if</span> (rows == 0)
00095                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00096                 }
00097                 <span class="keywordflow">catch</span> (MySqlException ex)
00098                 {
00099                     handler(ex);
00100                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00101                 }
00102             }
00103             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00104         }
00105 
<a name="l00110"></a><a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera3">00110</a>         <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera3">DisablePMTUser</a>(<span class="keywordtype">int</span> id, TransactionFailedHandler handler)
00111         {
00112             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(<a class="code" href="classPMTDataProvider_1_1Configuration.html">Configuration</a>.ConnectionString))
00113             {
00114                 PMTUser user = <span class="keyword">this</span>.GetPMTUserById(id, conn);
00115 
00116                 <span class="keywordflow">if</span> (user == null)
00117                 {
00118                     handler(<span class="keyword">new</span> NullReferenceException(String.Format(<span class="stringliteral">"User with id {0} does not exist."</span>, id)));
00119                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00120                 }
00121 
00122                 MySqlCommand command = conn.CreateCommand();
00123                 command.CommandText = <span class="stringliteral">"update users set enabled=0 where id=?id"</span>;
00124                 command.Parameters.Add(<span class="stringliteral">"?id"</span>, id);
00125 
00126                 <span class="keywordflow">try</span>
00127                 {
00128                     <span class="keywordtype">int</span> rows = <span class="keyword">this</span>.ExecuteNonQuery(command);
00129                     <span class="keywordflow">if</span> (rows == 0)
00130                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00131                 }
00132                 <span class="keywordflow">catch</span> (MySqlException ex)
00133                 {
00134                     handler(ex);
00135                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00136                 }
00137             }
00138             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00139         }
00140 
<a name="l00145"></a><a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera4">00145</a>         <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera4">DeletePMTUser</a>(<span class="keywordtype">int</span> id, TransactionFailedHandler handler)
00146         {
00147             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(<a class="code" href="classPMTDataProvider_1_1Configuration.html">Configuration</a>.ConnectionString))
00148             {
00149                 MySqlCommand command = conn.CreateCommand();
00150                 command.CommandText = <span class="stringliteral">"delete from users where id=?id"</span>;
00151 
00152                 <span class="keywordflow">try</span>
00153                 {
00154                     <span class="keyword">this</span>.ExecuteNonQuery(command);
00155                 }
00156                 <span class="keywordflow">catch</span> (MySqlException ex)
00157                 {
00158                     handler(ex);
00159                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00160                 }
00161             }
00162             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00163         }
00164 
00165         <span class="keyword">public</span> <span class="keywordtype">bool</span> InsertPMTUser(PMTUser user, TransactionFailedHandler handler)
00166         {
00167             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(Configuration.ConnectionString))
00168             {
00169                 <span class="comment">// add the user</span>
00170                 StringBuilder sbCommand = <span class="keyword">new</span> StringBuilder();
00171                 sbCommand.Append(<span class="stringliteral">"insert into users (Username, Password, Role, Enabled) \n"</span>);
00172                 sbCommand.Append(<span class="stringliteral">"values (?user, ?password, ?role, ?enabled)"</span>);
00173 
00174                 MySqlCommand command = conn.CreateCommand();
00175                 command.CommandText = sbCommand.ToString();
00176                 command.Parameters.Add(<span class="stringliteral">"?user"</span>, user.UserName);
00177                 command.Parameters.Add(<span class="stringliteral">"?password"</span>, user.Password);
00178                 command.Parameters.Add(<span class="stringliteral">"?role"</span>, (<span class="keywordtype">int</span>)user.Role);
00179                 command.Parameters.Add(<span class="stringliteral">"?enabled"</span>, user.Enabled ? 1 : 0);
00180 
00181                 <span class="keywordflow">try</span>
00182                 {
00183                     <span class="keyword">this</span>.ExecuteNonQuery(command);
00184                 }
00185                 <span class="keywordflow">catch</span> (MySqlException ex)
00186                 {
00187                     handler(ex);
00188                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00189                 }
00190 
00191                 <span class="comment">// get the user we just inserted so we can have its ID</span>
00192                 PMTUser temp = <span class="keyword">this</span>.GetPMTUserByUsername(user.UserName);
00193                 <span class="keywordflow">if</span> (temp == null)
00194                 {
00195                     handler(<span class="keyword">new</span> NullReferenceException(<span class="stringliteral">"User could not be added."</span>));
00196                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00197                 }
00198 
00199                 user.ID = temp.ID;
00200 
00201                 <span class="comment">// add the user's info</span>
00202                 sbCommand = <span class="keyword">new</span> StringBuilder();
00203                 sbCommand.Append(<span class="stringliteral">"insert into userInfo (ID, FirstName, LastName, Address, City, State, Zip, PhoneNumber, Email) \n"</span>);
00204                 sbCommand.Append(<span class="stringliteral">"values (?id, ?firstName, ?lastName, ?address, ?city, ?state, ?zip, ?phone, ?email)"</span>);
00205 
00206                 command = conn.CreateCommand();
00207                 command.CommandText = sbCommand.ToString();
00208                 command.Parameters.Add(<span class="stringliteral">"?id"</span>, user.ID);
00209                 command.Parameters.Add(<span class="stringliteral">"?firstName"</span>, user.FirstName);
00210                 command.Parameters.Add(<span class="stringliteral">"?lastName"</span>, user.LastName);
00211                 command.Parameters.Add(<span class="stringliteral">"?address"</span>, user.Address);
00212                 command.Parameters.Add(<span class="stringliteral">"?city"</span>, user.City);
00213                 command.Parameters.Add(<span class="stringliteral">"?state"</span>, user.State);
00214                 command.Parameters.Add(<span class="stringliteral">"?zip"</span>, user.ZipCode);
00215                 command.Parameters.Add(<span class="stringliteral">"?phone"</span>, user.PhoneNumber);
00216                 command.Parameters.Add(<span class="stringliteral">"?email"</span>, user.Email);
00217 
00218                 <span class="keywordflow">try</span>
00219                 {
00220                     <span class="keyword">this</span>.ExecuteNonQuery(command);
00221                 }
00222                 <span class="keywordflow">catch</span> (MySqlException ex)
00223                 {
00224                     handler(ex);
00225                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00226                 }
00227             }
00228             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00229         }
00230 
<a name="l00234"></a><a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera6">00234</a>         <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera6">UpdatePMTUser</a>(PMTUser user, TransactionFailedHandler handler)
00235         {
00236             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(<a class="code" href="classPMTDataProvider_1_1Configuration.html">Configuration</a>.ConnectionString))
00237             {
00238                 <span class="comment">// update the user</span>
00239                 StringBuilder sbCommand = <span class="keyword">new</span> StringBuilder();
00240                 sbCommand.Append(<span class="stringliteral">"update users  set Username=?user, Password=?password, Role=?role, Enabled=?enabled \n"</span>);
00241                 sbCommand.Append(<span class="stringliteral">"where ID=?id"</span>);
00242 
00243                 MySqlCommand command = conn.CreateCommand();
00244                 command.CommandText = sbCommand.ToString();
00245                 command.Parameters.Add(<span class="stringliteral">"?user"</span>, user.UserName);
00246                 command.Parameters.Add(<span class="stringliteral">"?password"</span>, user.Password);
00247                 command.Parameters.Add(<span class="stringliteral">"?role"</span>, (<span class="keywordtype">int</span>)user.Role);
00248                 command.Parameters.Add(<span class="stringliteral">"?enabled"</span>, user.Enabled ? 1 : 0);
00249                 command.Parameters.Add(<span class="stringliteral">"?id"</span>, user.ID);
00250 
00251                 <span class="keywordflow">try</span>
00252                 {
00253                     <span class="keyword">this</span>.ExecuteNonQuery(command);
00254                 }
00255                 <span class="keywordflow">catch</span> (MySqlException ex)
00256                 {
00257                     handler(ex);
00258                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00259                 }
00260 
00261                 <span class="comment">// update the user's info</span>
00262                 sbCommand = <span class="keyword">new</span> StringBuilder();
00263                 sbCommand.Append(<span class="stringliteral">"update userInfo \n"</span>);
00264                 sbCommand.Append(<span class="stringliteral">"set FirstName=?firstName, LastName=?lastName, Address=?address, City=?city, State=?state, Zip=?zip, PhoneNumber=?phone, Email=?email \n"</span>);
00265                 sbCommand.Append(<span class="stringliteral">"where ID=?id"</span>);
00266 
00267                 command = conn.CreateCommand();
00268                 command.CommandText = sbCommand.ToString();
00269                 command.Parameters.Add(<span class="stringliteral">"?id"</span>, user.ID);
00270                 command.Parameters.Add(<span class="stringliteral">"?firstName"</span>, user.FirstName);
00271                 command.Parameters.Add(<span class="stringliteral">"?lastName"</span>, user.LastName);
00272                 command.Parameters.Add(<span class="stringliteral">"?address"</span>, user.Address);
00273                 command.Parameters.Add(<span class="stringliteral">"?city"</span>, user.City);
00274                 command.Parameters.Add(<span class="stringliteral">"?state"</span>, user.State);
00275                 command.Parameters.Add(<span class="stringliteral">"?zip"</span>, user.ZipCode);
00276                 command.Parameters.Add(<span class="stringliteral">"?phone"</span>, user.PhoneNumber);
00277                 command.Parameters.Add(<span class="stringliteral">"?email"</span>, user.Email);
00278                 command.Parameters.Add(<span class="stringliteral">"?id"</span>, user.ID);
00279 
00280                 <span class="keywordflow">try</span>
00281                 {
00282                     <span class="keyword">this</span>.ExecuteNonQuery(command);
00283                 }
00284                 <span class="keywordflow">catch</span> (MySqlException ex)
00285                 {
00286                     handler(ex);
00287                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00288                 }
00289             }
00290             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00291         }
00292 <span class="preprocessor">        #endregion PMTUser Management</span>
00293 <span class="preprocessor"></span>
00294 <span class="preprocessor">        #region Get Users</span>
<a name="l00298"></a><a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera7">00298</a> <span class="preprocessor">        public DataTable GetPMTUsers()</span>
00299 <span class="preprocessor"></span>        {
00300             DataTable dt = <span class="keyword">new</span> DataTable();
00301             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(<a class="code" href="classPMTDataProvider_1_1Configuration.html">Configuration</a>.ConnectionString))
00302             {
00303                 MySqlCommand command = conn.CreateCommand();
00304                 command.CommandText = <span class="stringliteral">"select * from users u left join userInfo i on u.id=i.id"</span>;
00305 
00306                 MySqlDataAdapter da = <span class="keyword">new</span> MySqlDataAdapter(command);
00307                 <span class="keywordflow">try</span>
00308                 {
00309                     da.Fill(dt);
00310                 }
00311                 finally
00312                 {
00313                 }
00314             }
00315             <span class="keywordflow">return</span> dt;
00316         }
00317 
<a name="l00322"></a><a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera8">00322</a>         <span class="keyword">public</span> DataTable <a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera8">GetEnabledPMTUsers</a>(<span class="keywordtype">bool</span> enabled)
00323         {
00324             DataTable dt = <span class="keyword">new</span> DataTable();
00325             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(<a class="code" href="classPMTDataProvider_1_1Configuration.html">Configuration</a>.ConnectionString))
00326             {
00327                 MySqlCommand command = conn.CreateCommand();
00328                 command.CommandText = <span class="stringliteral">"select * from users u left join userInfo i on u.id=i.id where u.Enabled=?enabled"</span>;
00329                 command.Parameters.Add(<span class="stringliteral">"?enabled"</span>, enabled ? 1 : 0);
00330 
00331                 MySqlDataAdapter da = <span class="keyword">new</span> MySqlDataAdapter(command);
00332                 <span class="keywordflow">try</span>
00333                 {
00334                     da.Fill(dt);
00335                 }
00336                 finally
00337                 {
00338                 }
00339             }
00340             <span class="keywordflow">return</span> dt;
00341         }
00342 <span class="preprocessor">        #endregion Get Users</span>
00343 <span class="preprocessor"></span>
00344 <span class="preprocessor">        #region Get PMTUser</span>
<a name="l00349"></a><a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera9">00349</a> <span class="preprocessor">        public PMTUser GetPMTUserById(int id)</span>
00350 <span class="preprocessor"></span>        {
00351             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(<a class="code" href="classPMTDataProvider_1_1Configuration.html">Configuration</a>.ConnectionString))
00352             {
00353                 <span class="keywordflow">return</span> <span class="keyword">this</span>.GetPMTUserById(id, conn);
00354             }
00355         }                
00356 
<a name="l00361"></a><a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProviderd0">00361</a>         <span class="keyword">private</span> PMTUser <a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera9">GetPMTUserById</a>(<span class="keywordtype">int</span> id, MySqlConnection conn)
00362         {
00363             PMTUser user = null;
00364             MySqlCommand command = conn.CreateCommand();
00365             command.CommandText = <span class="stringliteral">"select * from users u left join userInfo i on u.id=i.id where u.id=?id"</span>;
00366             command.Parameters.Add(<span class="stringliteral">"?id"</span>, id);
00367 
00368             <span class="keywordflow">if</span> (conn.State != ConnectionState.Open)
00369                 conn.Open();
00370             MySqlDataReader dr = command.ExecuteReader();
00371 
00372             <span class="keywordflow">while</span> (dr.Read())
00373             {
00374                 user = <span class="keyword">new</span> PMTUser(
00375                     Convert.ToInt32(dr[<span class="stringliteral">"id"</span>]),
00376                     dr[<span class="stringliteral">"userName"</span>].ToString(),
00377                     dr[<span class="stringliteral">"password"</span>].ToString(),
00378                     (PMTUserRole)Convert.ToInt32(dr[<span class="stringliteral">"role"</span>]),
00379                     dr[<span class="stringliteral">"firstName"</span>].ToString(),
00380                     dr[<span class="stringliteral">"lastName"</span>].ToString(),
00381                     dr[<span class="stringliteral">"email"</span>].ToString(),
00382                     dr[<span class="stringliteral">"phoneNumber"</span>].ToString(),
00383                     dr[<span class="stringliteral">"address"</span>].ToString(),
00384                     dr[<span class="stringliteral">"city"</span>].ToString(),
00385                     dr[<span class="stringliteral">"state"</span>].ToString(),
00386                     dr[<span class="stringliteral">"zip"</span>].ToString(),
00387                     Convert.ToInt32(dr[<span class="stringliteral">"enabled"</span>]) == 1);
00388             }
00389             dr.Close();
00390             <span class="keywordflow">return</span> user;
00391         }
00392 
<a name="l00396"></a><a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera10">00396</a>         <span class="keyword">public</span> PMTUser <a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera10">GetPMTUserByUsername</a>(string username)
00397         {
00398             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(<a class="code" href="classPMTDataProvider_1_1Configuration.html">Configuration</a>.ConnectionString))
00399             {
00400                 MySqlCommand command = conn.CreateCommand();
00401 
00402                 command.CommandText = <span class="stringliteral">"select ID from users where UserName=?user"</span>;
00403                 command.Parameters.Add(<span class="stringliteral">"?user"</span>, username);
00404 
00405                 <span class="keywordtype">int</span> id = Convert.ToInt32(<span class="keyword">this</span>.<a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProviderd2">ExecuteScalar</a>(command));
00406                 <span class="keywordflow">return</span> <span class="keyword">this</span>.GetPMTUserById(id, conn);
00407             }
00408         }
00409 <span class="preprocessor">        #endregion Get PMTUser</span>
00410 <span class="preprocessor"></span>
<a name="l00415"></a><a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera11">00415</a>         <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProvidera11">VerifyEmailExists</a>(string email)
00416         {
00417             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(<a class="code" href="classPMTDataProvider_1_1Configuration.html">Configuration</a>.ConnectionString))
00418             {
00419                 MySqlCommand command = conn.CreateCommand();
00420                 command.CommandText = <span class="stringliteral">"select count(*) from userInfo where email=?email"</span>;
00421                 command.Parameters.Add(<span class="stringliteral">"?email"</span>, email);
00422 
00423                 <span class="keywordtype">int</span> k = Convert.ToInt32(<span class="keyword">this</span>.<a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProviderd2">ExecuteScalar</a>(command));
00424 
00425                 <span class="keywordflow">if</span> (k &gt; 0)
00426                     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00427                 <span class="keywordflow">else</span>
00428                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00429             }
00430         }
00431 
00432         <span class="comment">/*</span>
00433 <span class="comment">         * This isn't needed, we can do a GetPMTUserByUsername(),</span>
00434 <span class="comment">         *  and if the return is null, it does not exist</span>
00435 <span class="comment">         * </span>
00441 <span class="comment">        static public bool verifyUserNameExists(string userName, bool isNew)</span>
00442 <span class="comment">        {</span>
00443 <span class="comment">            DBDriver myDB=new DBDriver();</span>
00444 <span class="comment">            myDB.Query="select count(*) from users where userName=@name;";</span>
00445 <span class="comment">            myDB.addParam("@name", userName);</span>
00446 <span class="comment">            int k=Convert.ToInt32(myDB.scalar());</span>
00447 <span class="comment">            if(k!=1)</span>
00448 <span class="comment">                if(isNew)</span>
00449 <span class="comment">                {</span>
00450 <span class="comment">                    myDB.Query="select count(*) from newUsers where userName=@name;";</span>
00451 <span class="comment">                    myDB.addParam("@name", userName);</span>
00452 <span class="comment">                    k=Convert.ToInt32(myDB.scalar());                                                                  </span>
00453 <span class="comment">                }</span>
00454 <span class="comment">            if(k==1)</span>
00455 <span class="comment">                return true;</span>
00456 <span class="comment"></span>
00457 <span class="comment">            return false;</span>
00458 <span class="comment">        }</span>
00459 <span class="comment">        */</span>
00460 <span class="preprocessor">        #endregion PMTUser</span>
00461 <span class="preprocessor"></span>
00462 <span class="preprocessor">        #region C vs C Matrix</span>
00463 <span class="preprocessor"></span>        <span class="keyword">public</span> DataTable GetCompMatrix()
00464         {
00465             DataTable dt = <span class="keyword">new</span> DataTable();
00466             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(Configuration.ConnectionString))
00467             {
00468                 MySqlCommand command = conn.CreateCommand();
00469                 command.CommandText = <span class="stringliteral">"select * from compMatrix"</span>;
00470                 
00471                 MySqlDataAdapter da = <span class="keyword">new</span> MySqlDataAdapter(command);
00472                 <span class="keywordflow">try</span>
00473                 {
00474                     da.Fill(dt);
00475                 }
00476                 finally{}
00477             }
00478             <span class="keywordflow">return</span> dt;
00479         }
00480 
00481         <span class="keyword">public</span> <span class="keywordtype">bool</span> UpdateCompMatrix(CompLevel level, <span class="keywordtype">double</span> low, <span class="keywordtype">double</span> med, <span class="keywordtype">double</span> high, TransactionFailedHandler handler)
00482         {
00483             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(Configuration.ConnectionString))
00484             {
00485                 MySqlCommand command = conn.CreateCommand();
00486                 command.CommandText = <span class="stringliteral">"update compMatrix set lowComplexity=?low, medComplexity=?med, highComplexity=?high where compLevel=?level"</span>;
00487                 command.Parameters.Add(<span class="stringliteral">"?low"</span>, low);
00488                 command.Parameters.Add(<span class="stringliteral">"?med"</span>, med);
00489                 command.Parameters.Add(<span class="stringliteral">"?high"</span>, high);
00490                 command.Parameters.Add(<span class="stringliteral">"?level"</span>, (<span class="keywordtype">int</span>)level);
00491                 
00492                 <span class="keywordflow">try</span>
00493                 {
00494                     <span class="keyword">this</span>.ExecuteNonQuery(command);
00495                 }
00496                 <span class="keywordflow">catch</span> (MySqlException ex)
00497                 {
00498                     handler(ex);
00499                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00500                 }
00501             }
00502             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00503         }
00504 <span class="preprocessor">        #endregion</span>
00505 <span class="preprocessor"></span>
00506 <span class="preprocessor">        #region Projects</span>
00507 <span class="preprocessor"></span>        <span class="keyword">public</span> DataTable GetProjects()
00508         {
00509             DataTable dt = <span class="keyword">new</span> DataTable();
00510             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(Configuration.ConnectionString))
00511             {
00512                 MySqlCommand command = conn.CreateCommand();
00513                 command.CommandText = <span class="stringliteral">"select * from projects"</span>;
00514                 
00515                 MySqlDataAdapter da = <span class="keyword">new</span> MySqlDataAdapter(command);
00516                 <span class="keywordflow">try</span>
00517                 {
00518                     da.Fill(dt);
00519                 }
00520                 finally{}
00521             }
00522             <span class="keywordflow">return</span> dt;
00523         }
00524 
00525         <span class="keyword">public</span> Project GetProject(<span class="keywordtype">int</span> id)
00526         {
00527             Project project = null;
00528             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(Configuration.ConnectionString))
00529             {
00530                 MySqlCommand command = conn.CreateCommand();
00531                 command.CommandText = <span class="stringliteral">"select * from projects where id=?id"</span>;
00532                 command.Parameters.Add(<span class="stringliteral">"?id"</span>, id);
00533                 
00534                 MySqlDataReader dr = command.ExecuteReader();
00535                 <span class="keywordflow">try</span>
00536                 {
00537                     <span class="keywordflow">while</span> (dr.Read())
00538                     {
00539                         project = <span class="keyword">new</span> Project(
00540                             Convert.ToInt32(dr[<span class="stringliteral">"id"</span>]),
00541                             Convert.ToInt32(dr[<span class="stringliteral">"managerID"</span>]),
00542                             dr[<span class="stringliteral">"name"</span>].ToString(),
00543                             dr[<span class="stringliteral">"description"</span>].ToString(),
00544                             Convert.ToDateTime(dr[<span class="stringliteral">"startDate"</span>]),
00545                             Convert.ToDateTime(dr[<span class="stringliteral">"expEndDate"</span>]),
00546                             Convert.ToDateTime(dr[<span class="stringliteral">"actEndDate"</span>]));
00547                     }
00548                 }
00549                 finally{}
00550             }
00551             <span class="keywordflow">return</span> project;
00552         }
00553 
00554         <span class="keyword">public</span> DataTable GetManagerProjects(<span class="keywordtype">int</span> mgrID)
00555         {
00556             DataTable dt = <span class="keyword">new</span> DataTable();
00557             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(Configuration.ConnectionString))
00558             {
00559                 StringBuilder sbCommand = <span class="keyword">new</span> StringBuilder();
00560                 sbCommand.Append(<span class="stringliteral">"select * from projects p left join userReference u on p.ID=u.projectID \n"</span>);
00561                 sbCommand.Append(<span class="stringliteral">"where u.managerID=?id"</span>);
00562 
00563                 MySqlCommand command = conn.CreateCommand();
00564                 command.CommandText = sbCommand.ToString();
00565                 command.Parameters.Add(<span class="stringliteral">"?id"</span>, mgrID);
00566                 
00567                 MySqlDataAdapter da = <span class="keyword">new</span> MySqlDataAdapter(command);
00568                 <span class="keywordflow">try</span>
00569                 {
00570                     da.Fill(dt);
00571                 }
00572                 finally{}
00573             }
00574             <span class="keywordflow">return</span> dt;
00575         }
00576 
00577         <span class="keyword">public</span> DataTable GetProjectModules(<span class="keywordtype">int</span> projID)
00578         {
00579             DataTable dt = <span class="keyword">new</span> DataTable();
00580             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(Configuration.ConnectionString))
00581             {
00582                 MySqlCommand command = conn.CreateCommand();
00583                 command.CommandText = <span class="stringliteral">"select * from modules where projectID=?id"</span>;
00584                 command.Parameters.Add(<span class="stringliteral">"?id"</span>, projID);
00585 
00586                 MySqlDataAdapter da = <span class="keyword">new</span> MySqlDataAdapter(command);
00587 
00588                 <span class="keywordflow">try</span>
00589                 {
00590                     da.Fill(dt);
00591                 }
00592                 finally{}
00593             }
00594             <span class="keywordflow">return</span> dt;
00595         }
00596 
00597         <span class="keyword">public</span> <span class="keywordtype">int</span> InsertProject(Project project, TransactionFailedHandler handler)
00598         {
00599             <span class="keywordtype">int</span> id = -1;
00600             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(Configuration.ConnectionString))
00601             {
00602                 <span class="comment">// insert the project</span>
00603                 StringBuilder sbCommand = <span class="keyword">new</span> StringBuilder();
00604                 sbCommand.Append(<span class="stringliteral">"insert into projects (name, description, startDate, expEndDate) \n"</span>);
00605                 sbCommand.Append(<span class="stringliteral">"values (?name, ?desc, ?start, ?expEnd)"</span>);
00606 
00607                 MySqlCommand command = conn.CreateCommand();
00608                 command.CommandText = sbCommand.ToString();
00609                 command.Parameters.Add(<span class="stringliteral">"?name"</span>, project.Name);
00610                 command.Parameters.Add(<span class="stringliteral">"?desc"</span>, project.Description);
00611                 command.Parameters.Add(<span class="stringliteral">"?start"</span>, project.StartDate);
00612                 command.Parameters.Add(<span class="stringliteral">"?expEnd"</span>, project.ExpEndDate);
00613                 
00614                 <span class="keywordflow">try</span>
00615                 {
00616                     <span class="keyword">this</span>.ExecuteNonQuery(command);
00617                 }
00618                 <span class="keywordflow">catch</span> (MySqlException ex)
00619                 {
00620                     handler(ex);
00621                     <span class="keywordflow">return</span> id;
00622                 }
00623 
00624                 <span class="comment">// get its id</span>
00625                 command = conn.CreateCommand();
00626                 command.CommandText = <span class="stringliteral">"select LAST_INSERT_ID()"</span>;
00627 
00628                 <span class="keywordflow">try</span>
00629                 {
00630                     id = Convert.ToInt32(<span class="keyword">this</span>.<a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProviderd2">ExecuteScalar</a>(command));
00631                 }
00632                 <span class="keywordflow">catch</span> (MySqlException ex)
00633                 {
00634                     handler(ex);
00635                     <span class="keywordflow">return</span> id;
00636                 }
00637 
00638                 <span class="comment">// tie the project to its manager</span>
00639                 command = conn.CreateCommand();
00640                 command.CommandText = <span class="stringliteral">"insert into userReference (userID, projectID, managerID) values (?uID, ?pID, ?mID)"</span>;
00641                 command.Parameters.Add(<span class="stringliteral">"?uID"</span>, project.ManagerID);
00642                 command.Parameters.Add(<span class="stringliteral">"?pID"</span>, id);
00643                 command.Parameters.Add(<span class="stringliteral">"?mID"</span>, project.ManagerID);
00644 
00645                 <span class="keywordflow">try</span>
00646                 {
00647                     <span class="keyword">this</span>.ExecuteNonQuery(command);
00648                 }
00649                 <span class="keywordflow">catch</span> (MySqlException ex)
00650                 {
00651                     handler(ex);
00652                     <span class="keywordflow">return</span> id;
00653                 }
00654             }
00655             <span class="keywordflow">return</span> id;
00656         }
00657 
00658         <span class="keyword">public</span> <span class="keywordtype">bool</span> UpdateProject(Project project, TransactionFailedHandler handler)
00659         {
00660             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(Configuration.ConnectionString))
00661             {
00662                 StringBuilder sbCommand = <span class="keyword">new</span> StringBuilder();
00663                 sbCommand.Append(<span class="stringliteral">"update projects set name=?name, description=?desc, startDate=?start, expEndDate=?expEnd, actEndDate=?actEnd \n"</span>);
00664                 sbCommand.Append(<span class="stringliteral">"where id=?id"</span>);
00665 
00666                 MySqlCommand command = conn.CreateCommand();
00667                 command.CommandText = sbCommand.ToString();
00668                 command.Parameters.Add(<span class="stringliteral">"?id"</span>, project.ID);
00669                 command.Parameters.Add(<span class="stringliteral">"?name"</span>, project.Name);
00670                 command.Parameters.Add(<span class="stringliteral">"?desc"</span>, project.Description);
00671                 command.Parameters.Add(<span class="stringliteral">"?start"</span>, project.StartDate);
00672                 command.Parameters.Add(<span class="stringliteral">"?expEnd"</span>, project.ExpEndDate);
00673                 command.Parameters.Add(<span class="stringliteral">"?actEnd"</span>, project.ActEndDate);
00674                 
00675                 MySqlDataAdapter da = <span class="keyword">new</span> MySqlDataAdapter(command);
00676                 <span class="keywordflow">try</span>
00677                 {
00678                     <span class="keyword">this</span>.ExecuteNonQuery(command);
00679                 }
00680                 <span class="keywordflow">catch</span> (MySqlException ex)
00681                 {
00682                     handler(ex);
00683                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00684                 }
00685             }
00686             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00687         }
00688 
00689         <span class="keyword">public</span> <span class="keywordtype">bool</span> DeleteProject(<span class="keywordtype">int</span> projID, TransactionFailedHandler handler)
00690         {
00691             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(Configuration.ConnectionString))
00692             {
00693                 StringBuilder sbCommand = <span class="keyword">new</span> StringBuilder();
00694                 sbCommand.Append(<span class="stringliteral">"delete from projects where id=?id"</span>);
00695 
00696                 MySqlCommand command = conn.CreateCommand();
00697                 command.CommandText = sbCommand.ToString();
00698                 command.Parameters.Add(<span class="stringliteral">"?id"</span>, projID);
00699                 
00700                 <span class="keywordflow">try</span>
00701                 {
00702                     <span class="keyword">this</span>.ExecuteNonQuery(command);
00703                 }
00704                 <span class="keywordflow">catch</span> (MySqlException ex)
00705                 {
00706                     handler(ex);
00707                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00708                 }
00709             }
00710             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00711         }
00712 <span class="preprocessor">        #endregion Projects</span>
00713 <span class="preprocessor"></span>
00714 <span class="preprocessor">        #region Modules</span>
00715 <span class="preprocessor"></span>        <span class="keyword">public</span> DataTable GetModules()
00716         {
00717             DataTable dt = <span class="keyword">new</span> DataTable();
00718             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(Configuration.ConnectionString))
00719             {
00720                 MySqlCommand command = conn.CreateCommand();
00721                 command.CommandText = <span class="stringliteral">"select * from modules"</span>;
00722                 
00723                 MySqlDataAdapter da = <span class="keyword">new</span> MySqlDataAdapter(command);
00724                 <span class="keywordflow">try</span>
00725                 {
00726                     da.Fill(dt);
00727                 }
00728                 finally{}
00729             }
00730             <span class="keywordflow">return</span> dt;
00731         }
00732 
00733         <span class="keyword">public</span> PMTComponents.Module GetModule(<span class="keywordtype">int</span> id)
00734         {
00735             PMTComponents.Module module = null;
00736             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(Configuration.ConnectionString))
00737             {
00738                 MySqlCommand command = conn.CreateCommand();
00739                 command.CommandText = <span class="stringliteral">"select * from modules where id=?id"</span>;
00740                 command.Parameters.Add(<span class="stringliteral">"?id"</span>, id);
00741                 
00742                 MySqlDataReader dr = command.ExecuteReader();
00743                 <span class="keywordflow">try</span>
00744                 {
00745                     <span class="keywordflow">while</span> (dr.Read())
00746                     {
00747                         module = <span class="keyword">new</span> PMTComponents.Module(
00748                             Convert.ToInt32(dr[<span class="stringliteral">"id"</span>]),
00749                             Convert.ToInt32(dr[<span class="stringliteral">"projectID"</span>]),
00750                             dr[<span class="stringliteral">"name"</span>].ToString(),
00751                             dr[<span class="stringliteral">"description"</span>].ToString(),
00752                             Convert.ToDateTime(dr[<span class="stringliteral">"startDate"</span>]),
00753                             Convert.ToDateTime(dr[<span class="stringliteral">"expEndDate"</span>]),
00754                             Convert.ToDateTime(dr[<span class="stringliteral">"actEndDate"</span>]));
00755                     }
00756                 }
00757                 finally{}
00758             }
00759             <span class="keywordflow">return</span> module;
00760         }
00761 
00762         <span class="keyword">public</span> DataTable GetModuleTasks(<span class="keywordtype">int</span> modID)
00763         {
00764             DataTable dt = <span class="keyword">new</span> DataTable();
00765             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(Configuration.ConnectionString))
00766             {
00767                 MySqlCommand command = conn.CreateCommand();
00768                 command.CommandText = <span class="stringliteral">"select * from tasks where moduleID=?id"</span>;
00769                 command.Parameters.Add(<span class="stringliteral">"?id"</span>, modID);
00770 
00771                 MySqlDataAdapter da = <span class="keyword">new</span> MySqlDataAdapter(command);
00772 
00773                 <span class="keywordflow">try</span>
00774                 {
00775                     da.Fill(dt);
00776                 }
00777                 finally{}
00778             }
00779             <span class="keywordflow">return</span> dt;
00780         }
00781 
00782         <span class="keyword">public</span> <span class="keywordtype">int</span> InsertModule(PMTComponents.Module module, TransactionFailedHandler handler)
00783         {
00784             <span class="keywordtype">int</span> id = -1;
00785             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(Configuration.ConnectionString))
00786             {
00787                 StringBuilder sbCommand = <span class="keyword">new</span> StringBuilder();
00788                 sbCommand.Append(<span class="stringliteral">"insert into modules (projectID, name, description, startDate, expEndDate) \n"</span>);
00789                 sbCommand.Append(<span class="stringliteral">"values (?projID, ?name, ?desc, ?start, ?expEnd)"</span>);
00790 
00791                 MySqlCommand command = conn.CreateCommand();
00792                 command.CommandText = sbCommand.ToString();
00793                 command.Parameters.Add(<span class="stringliteral">"?projID"</span>, module.ProjectID);
00794                 command.Parameters.Add(<span class="stringliteral">"?name"</span>, module.Name);
00795                 command.Parameters.Add(<span class="stringliteral">"?desc"</span>, module.Description);
00796                 command.Parameters.Add(<span class="stringliteral">"?start"</span>, module.StartDate);
00797                 command.Parameters.Add(<span class="stringliteral">"?expEnd"</span>, module.ExpEndDate);
00798                 
00799                 MySqlDataAdapter da = <span class="keyword">new</span> MySqlDataAdapter(command);
00800                 <span class="keywordflow">try</span>
00801                 {
00802                     <span class="keyword">this</span>.ExecuteNonQuery(command);
00803                 }
00804                 <span class="keywordflow">catch</span> (MySqlException ex)
00805                 {
00806                     handler(ex);
00807                     <span class="keywordflow">return</span> id;
00808                 }
00809 
00810                 command = conn.CreateCommand();
00811                 command.CommandText = <span class="stringliteral">"select LAST_INSERT_ID()"</span>;
00812 
00813                 <span class="keywordflow">try</span>
00814                 {
00815                     id = Convert.ToInt32(<span class="keyword">this</span>.<a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProviderd2">ExecuteScalar</a>(command));
00816                 }
00817                 <span class="keywordflow">catch</span> (MySqlException ex)
00818                 {
00819                     handler(ex);
00820                     <span class="keywordflow">return</span> id;
00821                 }
00822             }
00823             <span class="keywordflow">return</span> id;
00824         }
00825 
00826         <span class="keyword">public</span> <span class="keywordtype">bool</span> UpdateModule(PMTComponents.Module module, TransactionFailedHandler handler)
00827         {
00828             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(Configuration.ConnectionString))
00829             {
00830                 StringBuilder sbCommand = <span class="keyword">new</span> StringBuilder();
00831                 sbCommand.Append(<span class="stringliteral">"update modules set projectID=?projID, name=?name, description=?desc, startDate=?start, expEndDate=?expEnd, actEndDate=?actEnd \n"</span>);
00832                 sbCommand.Append(<span class="stringliteral">"where id=?id"</span>);
00833 
00834                 MySqlCommand command = conn.CreateCommand();
00835                 command.CommandText = sbCommand.ToString();
00836                 command.Parameters.Add(<span class="stringliteral">"?id"</span>, module.ID);
00837                 command.Parameters.Add(<span class="stringliteral">"?projID"</span>, module.ProjectID);
00838                 command.Parameters.Add(<span class="stringliteral">"?name"</span>, module.Name);
00839                 command.Parameters.Add(<span class="stringliteral">"?desc"</span>, module.Description);
00840                 command.Parameters.Add(<span class="stringliteral">"?start"</span>, module.StartDate);
00841                 command.Parameters.Add(<span class="stringliteral">"?expEnd"</span>, module.ExpEndDate);
00842                 command.Parameters.Add(<span class="stringliteral">"?actEnd"</span>, module.ActEndDate);
00843                 
00844                 MySqlDataAdapter da = <span class="keyword">new</span> MySqlDataAdapter(command);
00845                 <span class="keywordflow">try</span>
00846                 {
00847                     <span class="keyword">this</span>.ExecuteNonQuery(command);
00848                 }
00849                 <span class="keywordflow">catch</span> (MySqlException ex)
00850                 {
00851                     handler(ex);
00852                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00853                 }
00854             }
00855             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00856         }
00857 
00858         <span class="keyword">public</span> <span class="keywordtype">bool</span> DeleteModule(<span class="keywordtype">int</span> modID, TransactionFailedHandler handler)
00859         {
00860             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(Configuration.ConnectionString))
00861             {
00862                 StringBuilder sbCommand = <span class="keyword">new</span> StringBuilder();
00863                 sbCommand.Append(<span class="stringliteral">"delete from modules where id=?id"</span>);
00864 
00865                 MySqlCommand command = conn.CreateCommand();
00866                 command.CommandText = sbCommand.ToString();
00867                 command.Parameters.Add(<span class="stringliteral">"?id"</span>, modID);
00868                 
00869                 <span class="keywordflow">try</span>
00870                 {
00871                     <span class="keyword">this</span>.ExecuteNonQuery(command);
00872                 }
00873                 <span class="keywordflow">catch</span> (MySqlException ex)
00874                 {
00875                     handler(ex);
00876                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00877                 }
00878             }
00879             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00880         }
00881 <span class="preprocessor">        #endregion Modules</span>
00882 <span class="preprocessor"></span>
00883 <span class="preprocessor">        #region Tasks</span>
00884 <span class="preprocessor"></span>        <span class="keyword">public</span> DataTable GetTasks()
00885         {
00886             DataTable dt = <span class="keyword">new</span> DataTable();
00887             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(Configuration.ConnectionString))
00888             {
00889                 MySqlCommand command = conn.CreateCommand();
00890                 command.CommandText = <span class="stringliteral">"select * from tasks"</span>;
00891                 
00892                 MySqlDataAdapter da = <span class="keyword">new</span> MySqlDataAdapter(command);
00893                 <span class="keywordflow">try</span>
00894                 {
00895                     da.Fill(dt);
00896                 }
00897                 finally{}
00898             }
00899             <span class="keywordflow">return</span> dt;
00900         }
00901 
00902         <span class="keyword">public</span> Task GetTask(<span class="keywordtype">int</span> id)
00903         {
00904             Task task = null;
00905             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(Configuration.ConnectionString))
00906             {
00907                 MySqlCommand command = conn.CreateCommand();
00908                 command.CommandText = <span class="stringliteral">"select * from tasks where id=?id"</span>;
00909                 command.Parameters.Add(<span class="stringliteral">"?id"</span>, id);
00910                 
00911                 MySqlDataReader dr = command.ExecuteReader();
00912                 <span class="keywordflow">try</span>
00913                 {
00914                     <span class="keywordflow">while</span> (dr.Read())
00915                     {
00916                         task = <span class="keyword">new</span> Task(
00917                             Convert.ToInt32(dr[<span class="stringliteral">"id"</span>]),
00918                             Convert.ToInt32(dr[<span class="stringliteral">"moduleID"</span>]),
00919                             Convert.ToInt32(dr[<span class="stringliteral">"projectID"</span>]),
00920                             dr[<span class="stringliteral">"name"</span>].ToString(),
00921                             dr[<span class="stringliteral">"description"</span>].ToString(),
00922                             (TaskComplexity)Convert.ToInt32(dr[<span class="stringliteral">"complexity"</span>]),
00923                             Convert.ToDateTime(dr[<span class="stringliteral">"startDate"</span>]),
00924                             Convert.ToDateTime(dr[<span class="stringliteral">"expEndDate"</span>]),
00925                             Convert.ToDateTime(dr[<span class="stringliteral">"actEndDate"</span>]));
00926                     }
00927                 }
00928                 finally{}
00929             }
00930             <span class="keywordflow">return</span> task;
00931         }
00932 
00933         <span class="keyword">public</span> DataTable GetDeveloperTasks(<span class="keywordtype">int</span> devID)
00934         {
00935             DataTable dt = <span class="keyword">new</span> DataTable();
00936             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(Configuration.ConnectionString))
00937             {
00938                 StringBuilder sbCommand = <span class="keyword">new</span> StringBuilder();
00939                 sbCommand.Append(<span class="stringliteral">"select * from tasks t left join taskAssignments a on t.ID=t.taskID \n"</span>);
00940                 sbCommand.Append(<span class="stringliteral">"where u.devID=?id"</span>);
00941 
00942                 MySqlCommand command = conn.CreateCommand();
00943                 command.CommandText = sbCommand.ToString();
00944                 command.Parameters.Add(<span class="stringliteral">"?id"</span>, devID);
00945                 
00946                 MySqlDataAdapter da = <span class="keyword">new</span> MySqlDataAdapter(command);
00947                 <span class="keywordflow">try</span>
00948                 {
00949                     da.Fill(dt);
00950                 }
00951                 finally{}
00952             }
00953             <span class="keywordflow">return</span> dt;
00954         }
00955 
00956         <span class="keyword">public</span> <span class="keywordtype">int</span> InsertTask(Task task, TransactionFailedHandler handler)
00957         {
00958             <span class="keywordtype">int</span> id = -1;
00959             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(Configuration.ConnectionString))
00960             {
00961                 StringBuilder sbCommand = <span class="keyword">new</span> StringBuilder();
00962                 sbCommand.Append(<span class="stringliteral">"insert into tasks (moduleID, projectID, name, description, startDate, expEndDate) \n"</span>);
00963                 sbCommand.Append(<span class="stringliteral">"values (?modID, ?projID, ?name, ?desc, ?start, ?expEnd)"</span>);
00964 
00965                 MySqlCommand command = conn.CreateCommand();
00966                 command.CommandText = sbCommand.ToString();
00967                 command.Parameters.Add(<span class="stringliteral">"?modID"</span>, task.ModuleID);
00968                 command.Parameters.Add(<span class="stringliteral">"?projID"</span>, task.ProjectID);
00969                 command.Parameters.Add(<span class="stringliteral">"?name"</span>, task.Name);
00970                 command.Parameters.Add(<span class="stringliteral">"?desc"</span>, task.Description);
00971                 command.Parameters.Add(<span class="stringliteral">"?start"</span>, task.StartDate);
00972                 command.Parameters.Add(<span class="stringliteral">"?expEnd"</span>, task.ExpEndDate);
00973                 
00974                 MySqlDataAdapter da = <span class="keyword">new</span> MySqlDataAdapter(command);
00975                 <span class="keywordflow">try</span>
00976                 {
00977                     <span class="keyword">this</span>.ExecuteNonQuery(command);
00978                 }
00979                 <span class="keywordflow">catch</span> (MySqlException ex)
00980                 {
00981                     handler(ex);
00982                     <span class="keywordflow">return</span> id;
00983                 }
00984 
00985                 <span class="keywordflow">try</span>
00986                 {
00987                     id = Convert.ToInt32(<span class="keyword">this</span>.<a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProviderd2">ExecuteScalar</a>(command));
00988                 }
00989                 <span class="keywordflow">catch</span> (MySqlException ex)
00990                 {
00991                     handler(ex);
00992                     <span class="keywordflow">return</span> id;
00993                 }
00994 
00995             }
00996             <span class="keywordflow">return</span> id;
00997         }
00998 
00999         <span class="keyword">public</span> <span class="keywordtype">bool</span> UpdateTask(Task task, TransactionFailedHandler handler)
01000         {
01001             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(Configuration.ConnectionString))
01002             {
01003                 StringBuilder sbCommand = <span class="keyword">new</span> StringBuilder();
01004                 sbCommand.Append(<span class="stringliteral">"update tasks set moduleID=?modID, projectID=?projID, name=?name, description=?desc, startDate=?start, expEndDate=?expEnd, actEndDate=?actEnd \n"</span>);
01005                 sbCommand.Append(<span class="stringliteral">"where id=?id"</span>);
01006 
01007                 MySqlCommand command = conn.CreateCommand();
01008                 command.CommandText = sbCommand.ToString();
01009                 command.Parameters.Add(<span class="stringliteral">"?modID"</span>, task.ModuleID);
01010                 command.Parameters.Add(<span class="stringliteral">"?projID"</span>, task.ProjectID);
01011                 command.Parameters.Add(<span class="stringliteral">"?id"</span>, task.ID);
01012                 command.Parameters.Add(<span class="stringliteral">"?name"</span>, task.Name);
01013                 command.Parameters.Add(<span class="stringliteral">"?desc"</span>, task.Description);
01014                 command.Parameters.Add(<span class="stringliteral">"?start"</span>, task.StartDate);
01015                 command.Parameters.Add(<span class="stringliteral">"?expEnd"</span>, task.ExpEndDate);
01016                 command.Parameters.Add(<span class="stringliteral">"?actEnd"</span>, task.ActEndDate);
01017                 
01018                 MySqlDataAdapter da = <span class="keyword">new</span> MySqlDataAdapter(command);
01019                 <span class="keywordflow">try</span>
01020                 {
01021                     <span class="keyword">this</span>.ExecuteNonQuery(command);
01022                 }
01023                 <span class="keywordflow">catch</span> (MySqlException ex)
01024                 {
01025                     handler(ex);
01026                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
01027                 }
01028             }
01029             <span class="keywordflow">return</span> <span class="keyword">true</span>;
01030         }
01031 
01032         <span class="keyword">public</span> <span class="keywordtype">bool</span> DeleteTask(<span class="keywordtype">int</span> taskID, TransactionFailedHandler handler)
01033         {
01034             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(Configuration.ConnectionString))
01035             {
01036                 MySqlCommand command = conn.CreateCommand();
01037                 command.CommandText = <span class="stringliteral">"delete from tasks where id=?id"</span>;
01038                 command.Parameters.Add(<span class="stringliteral">"?id"</span>, taskID);
01039                 
01040                 <span class="keywordflow">try</span>
01041                 {
01042                     <span class="keyword">this</span>.ExecuteNonQuery(command);
01043                 }
01044                 <span class="keywordflow">catch</span> (MySqlException ex)
01045                 {
01046                     handler(ex);
01047                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
01048                 }
01049             }
01050             <span class="keywordflow">return</span> <span class="keyword">true</span>;
01051         }
01052 
01053         <span class="keyword">public</span> <span class="keywordtype">bool</span> AssignDeveloper(<span class="keywordtype">int</span> devID, <span class="keywordtype">int</span> taskID, TransactionFailedHandler handler)
01054         {
01055             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(Configuration.ConnectionString))
01056             {
01057                 MySqlCommand command = conn.CreateCommand();
01058                 command.CommandText = <span class="stringliteral">"insert into taskAssignments (devID, taskID) values (?devID, ?taskID)"</span>;
01059                 command.Parameters.Add(<span class="stringliteral">"?devID"</span>, devID);
01060                 command.Parameters.Add(<span class="stringliteral">"?taskID"</span>, taskID);
01061 
01062                 <span class="keywordflow">try</span>
01063                 {
01064                     <span class="keyword">this</span>.ExecuteNonQuery(command);
01065                 }
01066                 <span class="keywordflow">catch</span> (MySqlException ex)
01067                 {
01068                     handler(ex);
01069                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
01070                 }
01071             }
01072             <span class="keywordflow">return</span> <span class="keyword">false</span>;
01073         }
01074 
01075 <span class="preprocessor">        #endregion Tasks</span>
01076 <span class="preprocessor"></span>
01077         <span class="keyword">public</span> DataTable GetDeveloperAssignments()
01078         {
01079             DataTable dt = <span class="keyword">new</span> DataTable();
01080             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(Configuration.ConnectionString))
01081             {
01082                 StringBuilder sbCommand = <span class="keyword">new</span> StringBuilder();
01083                 sbCommand.Append(<span class="stringliteral">"select * from (users u left join taskAssignments a on u.id=a.devID) \n"</span>);
01084                 sbCommand.Append(<span class="stringliteral">"left join tasks t on a.taskID=t.ID where u.Role=?role \n"</span>);
01085                 sbCommand.Append(<span class="stringliteral">"order by u.UserName"</span>);
01086 
01087                 MySqlCommand command = conn.CreateCommand();
01088                 command.CommandText = sbCommand.ToString();
01089                 command.Parameters.Add(<span class="stringliteral">"?role"</span>, (<span class="keywordtype">int</span>)PMTUserRole.Developer);
01090 
01091                 MySqlDataAdapter da = <span class="keyword">new</span> MySqlDataAdapter(command);
01092 
01093                 <span class="keywordflow">try</span>
01094                 {
01095                     da.Fill(dt);
01096                 }
01097                 finally{}
01098             }
01099             <span class="keywordflow">return</span> dt;
01100         }
01101 
01102         <span class="keyword">public</span> <span class="keywordtype">bool</span> ApproveTask(<span class="keywordtype">int</span> taskID, TransactionFailedHandler handler)
01103         {
01104             <span class="keyword">using</span> (MySqlConnection conn = <span class="keyword">new</span> MySqlConnection(Configuration.ConnectionString))
01105             {
01106                 MySqlCommand command = conn.CreateCommand();
01107                 command.CommandText = <span class="stringliteral">"update tasks set Status=?status, actEndDate=?date \n"</span>;
01108                 command.Parameters.Add(<span class="stringliteral">"?status"</span>, (<span class="keywordtype">int</span>)TaskStatus.Approved);
01109                 command.Parameters.Add(<span class="stringliteral">"?date"</span>, DateTime.Now);
01110 
01111                 <span class="keywordflow">try</span>
01112                 {
01113                     <span class="keyword">this</span>.ExecuteNonQuery(command);
01114                 }
01115                 <span class="keywordflow">catch</span> (MySqlException ex)
01116                 {
01117                     handler(ex);
01118                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
01119                 }
01120             }
01121             <span class="keywordflow">return</span> <span class="keyword">true</span>;
01122         }
01123 
01124         <span class="keyword">public</span> <span class="keywordtype">double</span> ResolvePercentComplete(ProjectItem item)
01125         {
01126             <span class="comment">/*</span>
01127 <span class="comment">                int count = 0;</span>
01128 <span class="comment">                int approved = 0;</span>
01129 <span class="comment"></span>
01130 <span class="comment">                DataTable modsTable = this.getModulesDataSet().Tables[0];</span>
01131 <span class="comment">                foreach (DataRow modRow in modsTable.Rows)</span>
01132 <span class="comment">                {</span>
01133 <span class="comment">                    DataTable tasksTable = new Module(modRow["id"].ToString()).getTasksDataSet().Tables[0];</span>
01134 <span class="comment">                    foreach (DataRow taskRow in tasksTable.Rows)</span>
01135 <span class="comment">                    {</span>
01136 <span class="comment">                        if (taskRow["complete"].ToString().Equals(TaskStatus.APPROVED))</span>
01137 <span class="comment">                            approved++;</span>
01138 <span class="comment">                        count++;</span>
01139 <span class="comment">                    }</span>
01140 <span class="comment">                }</span>
01141 <span class="comment">                double pct = (double)approved/(double)count;</span>
01142 <span class="comment">                if (Double.IsNaN(pct))</span>
01143 <span class="comment">                    pct = 0;</span>
01144 <span class="comment">                return Convert.ToString(pct.ToString(percentFormatter));</span>
01145 <span class="comment">            */</span>
01146 
01147             <span class="comment">/*</span>
01148 <span class="comment">                int count = 0;</span>
01149 <span class="comment">                int approved = 0;</span>
01150 <span class="comment"></span>
01151 <span class="comment">                DataTable dt = this.getTasksDataSet().Tables[0];</span>
01152 <span class="comment">                foreach (DataRow row in dt.Rows)</span>
01153 <span class="comment">                {</span>
01154 <span class="comment">                    if (row["complete"].ToString().Equals(TaskStatus.APPROVED))</span>
01155 <span class="comment">                        approved++;</span>
01156 <span class="comment">                    count++;</span>
01157 <span class="comment">                }</span>
01158 <span class="comment">                double pct = (double)approved/(double)count;</span>
01159 <span class="comment">                if (Double.IsNaN(pct))</span>
01160 <span class="comment">                    pct = 0;</span>
01161 <span class="comment">                return Convert.ToString(pct.ToString(percentFormatter));</span>
01162 <span class="comment">            */</span>
01163             <span class="keywordflow">return</span> 0;
01164         }
01165 
01166         <span class="keyword">public</span> DateTime ResolveExpectedEndDate(ProjectItem item)
01167         {
01168             <span class="keywordflow">return</span> DateTime.Now;
01169         }
01170 
01171 <span class="preprocessor">        #region Managed Query Execution</span>
<a name="l01175"></a><a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProviderd1">01175</a> <span class="preprocessor">        private int ExecuteNonQuery(MySqlCommand command)</span>
01176 <span class="preprocessor"></span>        {
01177             <span class="keywordtype">int</span> rows = 0;
01178 
01179             <span class="keywordflow">if</span> (command.Connection.State != ConnectionState.Open)
01180                 command.Connection.Open();
01181 
01182             rows = command.ExecuteNonQuery();
01183 
01184             <span class="keywordflow">return</span> rows;
01185         }
01186 
<a name="l01190"></a><a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProviderd2">01190</a>         <span class="keyword">private</span> object <a class="code" href="classPMTDataProvider_1_1MySqlDataProvider.html#PMTDataProvider_1_1MySqlDataProviderd2">ExecuteScalar</a>(MySqlCommand command)
01191         {
01192             object obj = null;
01193 
01194             <span class="keywordflow">if</span> (command.Connection.State != ConnectionState.Open)
01195                 command.Connection.Open();
01196 
01197             obj = command.ExecuteScalar();
01198             
01199             <span class="keywordflow">return</span> obj;
01200         }
01201 <span class="preprocessor">        #endregion</span>
01202 <span class="preprocessor"></span>
01203 <span class="preprocessor">        #endregion</span>
01204 <span class="preprocessor"></span>    }
01205 }
</pre></div><hr><address style="align: right;"><small>
Generated on Sun Aug 6 23:06:02 2006 for PMT by <a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 width=110 height=53>
</a> 1.3.1 using KingsTools</small></address>
</body>
</html>
