<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>PMT: Projects.aspx.cs Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.1 -->
<h1>Projects.aspx.cs</h1><div class="fragment"><pre>00001 <span class="keyword">using</span> System;
00002 <span class="keyword">using</span> System.Collections;
00003 <span class="keyword">using</span> System.ComponentModel;
00004 <span class="keyword">using</span> System.Data;
00005 <span class="keyword">using</span> System.Data.SqlClient;
00006 <span class="keyword">using</span> System.Drawing;
00007 <span class="keyword">using</span> System.Web;
00008 <span class="keyword">using</span> System.Web.SessionState;
00009 <span class="keyword">using</span> System.Web.UI;
00010 <span class="keyword">using</span> System.Web.UI.WebControls;
00011 <span class="keyword">using</span> System.Web.UI.HtmlControls;
00012 <span class="keyword">using</span> PMTComponents;
00013 <span class="keyword">using</span> PMTDataProvider;
00014 
00015 <span class="keyword">namespace </span>PMT.PM
00016 {
00017     <span class="keyword">public</span> <span class="keyword">class </span>Projects : Page
00018     {
00019         <span class="keyword">protected</span> HyperLink newProjectLink;
00020         <span class="keyword">protected</span> Label lblResult;
00021         <span class="keyword">protected</span> Panel projectPanel;
00022         <span class="keyword">protected</span> HyperLink AddItemHyperLink;
00023         <span class="keyword">protected</span> DataGrid DataGrid1;
00024         <span class="keyword">protected</span> Label ItemLabel;
00025         <span class="keyword">protected</span> string id;
00026     
00027         <span class="keyword">private</span> <span class="keywordtype">void</span> Page_Load(object sender, System.EventArgs e)
00028         {
00029             <span class="keywordflow">if</span> (!Page.IsPostBack)
00030             {
00031                 BindData();
00032             }
00033         }
00034 
00035         <span class="keyword">private</span> <span class="keywordtype">void</span> BindData()
00036         {
00037             IDataProvider data = DataProvider.CreateInstance();
00038             <span class="comment">// the project item to display</span>
00039             ProjectItem item;
00040             
00041             <span class="comment">//create a data set</span>
00042             DataTable dt = <span class="keyword">new</span> DataTable();
00043 
00044             <span class="comment">// list all projects assigned to logged in PM</span>
00045             <span class="keywordflow">if</span> (ItemType.Equals(ProjectItemType.Project))
00046             {
00047                 dt = data.GetManagerProjects(UserID);
00048                 item = null;
00049             }
00050                 <span class="comment">// list all modules in specified project</span>
00051             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ItemType.Equals(ProjectItemType.Module))
00052             {
00053                 item = data.GetProject(ItemID);
00054                 dt = data.GetProjectModules(item.ID);
00055             }
00056                 <span class="comment">// list all tasks in specified module</span>
00057             <span class="keywordflow">else</span> <span class="comment">//if (itemType.Equals(ProjectItemType.TASK))</span>
00058             {
00059                 item = data.GetModule(ItemID);
00060                 dt = data.GetModuleTasks(item.ID);
00061                 BoundColumn ComplexityColumn = <span class="keyword">new</span> BoundColumn();
00062                 ComplexityColumn.HeaderText = <span class="stringliteral">"Complexity"</span>;
00063                 ComplexityColumn.DataField = <span class="stringliteral">"complexity"</span>;
00064                 ComplexityColumn.ReadOnly = <span class="keyword">true</span>;
00065                 DataGrid1.Columns.AddAt(3, ComplexityColumn);
00066             }
00067 
00068             <span class="comment">// set the display grid data source</span>
00069             setDisplayItemType();
00070             DataGrid1.DataSource = dt;
00071             DataGrid1.DataBind();
00072 
00073             <span class="comment">// set the create/add new item link and item label</span>
00074             <span class="keywordflow">if</span> (item != null)
00075             {
00076                 AddItemHyperLink.NavigateUrl 
00077                     = <span class="stringliteral">"NewItem.aspx?item="</span> + ItemType + <span class="stringliteral">"&amp;parentID="</span> + item.ID;
00078                 AddItemHyperLink.Text = <span class="stringliteral">"Add a "</span> + ItemType.ToString() + <span class="stringliteral">" to "</span> + item.Name;
00079                 ItemLabel.Text = ItemType +<span class="stringliteral">"s in "</span> + item.Name;
00080             }
00081             <span class="keywordflow">else</span>
00082             {
00083                 AddItemHyperLink.NavigateUrl = String.Format(<span class="stringliteral">"NewItem.aspx?item={0}"</span>, ProjectItemType.Project);
00084                 AddItemHyperLink.Text = <span class="stringliteral">"Create a new project"</span>;
00085                 ItemLabel.Text = <span class="stringliteral">"Your projects"</span>;
00086             }
00087         }
00088 
00089 <span class="preprocessor">        #region Web Form Designer generated code</span>
00090 <span class="preprocessor"></span>        override <span class="keyword">protected</span> <span class="keywordtype">void</span> OnInit(EventArgs e)
00091         {
00092             <span class="comment">//</span>
00093             <span class="comment">// CODEGEN: This call is required by the ASP.NET Web Form Designer.</span>
00094             <span class="comment">//</span>
00095             InitializeComponent();
00096             base.OnInit(e);
00097         }
00098         
00103         <span class="keyword">private</span> <span class="keywordtype">void</span> InitializeComponent()
00104         {    
00105             <span class="keyword">this</span>.DataGrid1.CancelCommand += <span class="keyword">new</span> System.Web.UI.WebControls.DataGridCommandEventHandler(<span class="keyword">this</span>.CancelCommand_Clicked);
00106             <span class="keyword">this</span>.DataGrid1.EditCommand += <span class="keyword">new</span> System.Web.UI.WebControls.DataGridCommandEventHandler(<span class="keyword">this</span>.EditButton_Pushed);
00107             <span class="keyword">this</span>.DataGrid1.UpdateCommand += <span class="keyword">new</span> System.Web.UI.WebControls.DataGridCommandEventHandler(<span class="keyword">this</span>.UpdateCommand_Pushed);
00108             <span class="keyword">this</span>.DataGrid1.DeleteCommand += <span class="keyword">new</span> System.Web.UI.WebControls.DataGridCommandEventHandler(<span class="keyword">this</span>.DeleteButton_Pushed);
00109             <span class="keyword">this</span>.Load += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.Page_Load);
00110 
00111         }
00112 <span class="preprocessor">        #endregion</span>
00113 <span class="preprocessor"></span>
00117         <span class="keyword">private</span> <span class="keywordtype">void</span> DeleteButton_Pushed(object source, DataGridCommandEventArgs e)
00118         {
00119             <span class="keywordtype">int</span> delID = Convert.ToInt32(DataGrid1.Items[e.Item.ItemIndex].Cells[0].Text);
00120             IDataProvider data = DataProvider.CreateInstance();
00121 
00122             <span class="keywordflow">if</span> (ItemType.Equals(ProjectItemType.Project))
00123                 data.DeleteProject(delID, <span class="keyword">new</span> TransactionFailedHandler(<span class="keyword">this</span>.TransactionFailed));
00124             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ItemType.Equals(ProjectItemType.Module))
00125                 data.DeleteModule(delID, <span class="keyword">new</span> TransactionFailedHandler(<span class="keyword">this</span>.TransactionFailed));
00126             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ItemType.Equals(ProjectItemType.Task))
00127                 data.DeleteTask(delID, <span class="keyword">new</span> TransactionFailedHandler(<span class="keyword">this</span>.TransactionFailed));
00128 
00129             BindData();
00130         }
00131 
00135         <span class="keyword">private</span> <span class="keywordtype">void</span> setDisplayItemType()
00136         {
00137             <span class="comment">// change the name column to a BoundColumn instead of a HypLinkColumn</span>
00138             <span class="keywordflow">if</span> (ItemType.Equals(ProjectItemType.Task))
00139             {
00140                 <span class="comment">// set the link url for the name column</span>
00141                 ((HyperLinkColumn)DataGrid1.Columns[1]).DataNavigateUrlFormatString = <span class="stringliteral">"Assign.aspx?taskID={0}"</span>;
00142                 DataGrid1.Columns[1].HeaderText = ItemType + <span class="stringliteral">" Name (Click to assign)"</span>;
00143 
00144                 <span class="keywordflow">return</span>;
00145             }
00146 
00147             <span class="comment">// set the link url for the name column</span>
00148             ((HyperLinkColumn)DataGrid1.Columns[1]).DataNavigateUrlFormatString = <span class="stringliteral">"Projects.aspx?item="</span>+ItemType+<span class="stringliteral">"&amp;id={0}"</span>;
00149             DataGrid1.Columns[1].HeaderText = ItemType + <span class="stringliteral">" Name"</span>;
00150         }
00151 
00155         <span class="keyword">private</span> <span class="keywordtype">void</span> EditButton_Pushed(object source, DataGridCommandEventArgs e)
00156         {
00157             DataGrid1.EditItemIndex = e.Item.ItemIndex;
00158             BindData();
00159         }
00160 
00161         <span class="keyword">private</span> <span class="keywordtype">void</span> UpdateCommand_Pushed(object source, DataGridCommandEventArgs e)
00162         {
00163             TextBox tb;
00164             string name = ((HyperLink)e.Item.Cells[1].Controls[0]).Text;
00165             tb = (TextBox)e.Item.Cells[2].Controls[0];
00166             string desc = tb.Text;
00167             tb = (TextBox)e.Item.Cells[3].Controls[0];
00168             DateTime start = Convert.ToDateTime(tb.Text);
00169 
00170             <span class="keywordtype">int</span> id = Convert.ToInt32(DataGrid1.Items[e.Item.ItemIndex].Cells[0].Text);
00171 
00172             IDataProvider data = DataProvider.CreateInstance();
00173             
00174             ProjectItem item;
00175 
00176             <span class="keywordflow">if</span>(ItemType.Equals(ProjectItemType.Project))
00177             {
00178                 item = data.GetProject(id);
00179                 item.Name = name;
00180                 item.Description = desc;
00181                 item.StartDate = start;
00182                 data.UpdateProject(item as Project, <span class="keyword">new</span> TransactionFailedHandler(<span class="keyword">this</span>.TransactionFailed));
00183             }
00184             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ItemType.Equals(ProjectItemType.Module))
00185             {
00186                 item = data.GetModule(id);
00187                 item.Name = name;
00188                 item.Description = desc;
00189                 item.StartDate = start;
00190                 data.UpdateModule(item as Module, <span class="keyword">new</span> TransactionFailedHandler(<span class="keyword">this</span>.TransactionFailed));
00191             }
00192             <span class="keywordflow">else</span> <span class="comment">//if (itemType.Equals(ProjectItemType.Task))</span>
00193             {
00194                 item = data.GetTask(id);
00195                 item.Name = name;
00196                 item.Description = desc;
00197                 item.StartDate = start;
00198                 data.UpdateTask(item as Task, <span class="keyword">new</span> TransactionFailedHandler(<span class="keyword">this</span>.TransactionFailed));
00199             }
00200 
00201             DataGrid1.EditItemIndex = -1;
00202             DataGrid1.DataBind();
00203         }
00204 
00205         <span class="keyword">private</span> <span class="keywordtype">void</span> CancelCommand_Clicked(object source, DataGridCommandEventArgs e)
00206         {
00207             DataGrid1.EditItemIndex = -1;
00208             BindData();
00209         }
00210 
00211         <span class="keyword">private</span> <span class="keywordtype">void</span> TransactionFailed(Exception ex)
00212         {
00213             lblResult.Text = ex.Message;
00214         }
00215 
00216         <span class="keyword">public</span> ProjectItemType ItemType
00217         {
00218             get 
00219             {
00220                 <span class="keywordflow">try</span>
00221                 {
00222                     <span class="keywordflow">return</span> (ProjectItemType)Enum.Parse(typeof(ProjectItemType), Request[<span class="stringliteral">"item"</span>]);     
00223                 }
00224                 <span class="keywordflow">catch</span>
00225                 {
00226                     <span class="comment">//throw new Exception("Invalid Item Type");</span>
00227                     <span class="comment">// default to project</span>
00228                     <span class="keywordflow">return</span> ProjectItemType.Project;
00229                 }
00230             }
00231         }
00232         <span class="keyword">public</span> <span class="keywordtype">int</span> ItemID
00233         {
00234             get
00235             {
00236                 <span class="keywordflow">try</span>
00237                 {
00238                     <span class="keywordflow">return</span> Convert.ToInt32(Request[<span class="stringliteral">"id"</span>]);   
00239                 }
00240                 <span class="keywordflow">catch</span>
00241                 {
00242                     <span class="keywordflow">throw</span> <span class="keyword">new</span> Exception(<span class="stringliteral">"Invalid Item ID"</span>);
00243                 }
00244             }
00245         }
00246         <span class="keyword">public</span> <span class="keywordtype">int</span> UserID
00247         {
00248             get
00249             {
00250                 <span class="keywordflow">try</span>
00251                 {
00252                     <span class="keywordflow">return</span> Convert.ToInt32(Request.Cookies[<span class="stringliteral">"user"</span>][<span class="stringliteral">"id"</span>]);   
00253                 }
00254                 <span class="keywordflow">catch</span>
00255                 {
00256                     <span class="keywordflow">throw</span> <span class="keyword">new</span> Exception(<span class="stringliteral">"Invalid Cookie"</span>);
00257                 }
00258             }
00259         }
00260     }
00261 }
</pre></div><hr><address style="align: right;"><small>
Generated on Sun Aug 6 23:06:03 2006 for PMT by <a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 width=110 height=53>
</a> 1.3.1 using KingsTools</small></address>
</body>
</html>
