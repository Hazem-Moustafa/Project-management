<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>PMT: D:/My Documents/Visual Studio Projects/projmgtnet2/AllUsers/Reports.aspx.cs Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.1 -->
<h1>D:/My Documents/Visual Studio Projects/projmgtnet2/AllUsers/Reports.aspx.cs</h1><div class="fragment"><pre>00001 <span class="keyword">using</span> System;
00002 <span class="keyword">using</span> System.Collections;
00003 <span class="keyword">using</span> System.ComponentModel;
00004 <span class="keyword">using</span> System.Data;
00005 <span class="keyword">using</span> System.Data.SqlClient;
00006 <span class="keyword">using</span> System.Drawing;
00007 <span class="keyword">using</span> System.Web;
00008 <span class="keyword">using</span> System.Web.SessionState;
00009 <span class="keyword">using</span> System.Web.UI;
00010 <span class="keyword">using</span> System.Web.UI.WebControls;
00011 <span class="keyword">using</span> System.Web.UI.HtmlControls;
00012 <span class="keyword">using</span> PMTComponents;
00013 
00014 <span class="keyword">namespace </span>PMT.AllUsers
00015 {
<a name="l00019"></a><a class="code" href="classPMT_1_1AllUsers_1_1Reports.html">00019</a>     <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="classPMT_1_1AllUsers_1_1Reports.html">Reports</a> : System.Web.UI.Page
00020     {
00021         <span class="keyword">protected</span> System.Web.UI.WebControls.DropDownList ProjectDropDownList;
00022         <span class="keyword">protected</span> System.Web.UI.WebControls.Button ViewProjectButton;
00023         <span class="keyword">protected</span> System.Web.UI.WebControls.DropDownList ModuleDropDownList;
00024         <span class="keyword">protected</span> System.Web.UI.WebControls.Button ViewModuleButton;
00025         <span class="keyword">protected</span> System.Web.UI.WebControls.DropDownList TaskDropDownList;
00026         <span class="keyword">protected</span> System.Web.UI.WebControls.Button ViewTaskButton;
00027         <span class="keyword">protected</span> System.Web.UI.WebControls.Label ModuleLabel;
00028         <span class="keyword">protected</span> System.Web.UI.WebControls.Label TaskLabel;
00029         <span class="keyword">protected</span> System.Web.UI.WebControls.Panel ReportPanel;
00030         <span class="keyword">protected</span> System.Web.UI.WebControls.Label ProjectLabel;
00031         <span class="keyword">protected</span> string role;
00032         <span class="keyword">protected</span> System.Web.UI.WebControls.DataGrid DisplayGrid;
00033         <span class="keyword">protected</span> string userID;
00034 
00035         <span class="keyword">private</span> <span class="keywordtype">void</span> Page_Load(object sender, System.EventArgs e)
00036         {
00037             <span class="comment">// Put user code to initialize the page here</span>
00038 
00039             <span class="keywordflow">if</span> (!<span class="keyword">this</span>.IsPostBack)
00040             {
00041                 role = Request.Cookies[<span class="stringliteral">"user"</span>][<span class="stringliteral">"role"</span>];
00042                 userID = Request.Cookies[<span class="stringliteral">"user"</span>][<span class="stringliteral">"id"</span>];
00043 
00044                 <span class="keywordflow">if</span> (role.Equals(PMTUserRole.Manager))
00045                 {
00046                     <span class="comment">// get all projectes assigned to a project manager</span>
00047                     DataSet ds = Project.getProjectsDataSet(userID);
00048 
00049                     <span class="comment">//create a datatable to fill the dropdown list from</span>
00050                     DataTable dt=<span class="keyword">new</span> DataTable();
00051                     dt=ds.Tables[0];
00052                     <span class="comment">//fill the dropdown list</span>
00053                     ProjectDropDownList.DataSource=dt.DefaultView;
00054                     ProjectDropDownList.DataTextField=<span class="stringliteral">"name"</span>;
00055                     ProjectDropDownList.DataValueField=<span class="stringliteral">"ID"</span>;
00056                     ProjectDropDownList.DataBind();
00057                     ProjectDropDownList.Items.Insert(0,<span class="stringliteral">""</span>);
00058 
00059                     enableModuleControls(<span class="keyword">false</span>);
00060                     enableTaskControls(<span class="keyword">false</span>);
00061                 }
00062                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (role.Equals(PMTUserRole.Developer))
00063                 {
00064                     <span class="comment">// get all tasks assigned to a developer</span>
00065                     DBDriver db = <span class="keyword">new</span> DBDriver();
00066                     db.Query = <span class="stringliteral">"select t.id, t.name from assignments a, tasks t \n"</span>
00067                         +<span class="stringliteral">"where a.devID = @devID and t.id = a.taskID"</span>;
00068                     db.addParam(<span class="stringliteral">"@devID"</span>, userID);
00069                     
00070                     DataSet ds = <span class="keyword">new</span> DataSet();
00071                     db.createAdapter().Fill(ds);
00072 
00073                     DataTable dt = <span class="keyword">new</span> DataTable();
00074                     dt = ds.Tables[0];
00075 
00076                     <span class="comment">// display tasks in the drop down list</span>
00077                     TaskDropDownList.DataSource=dt.DefaultView;
00078                     TaskDropDownList.DataTextField=<span class="stringliteral">"name"</span>;
00079                     TaskDropDownList.DataValueField=<span class="stringliteral">"id"</span>;
00080                     TaskDropDownList.DataBind();
00081                     TaskDropDownList.Items.Insert(0,<span class="stringliteral">""</span>);
00082 
00083                     enableModuleControls(<span class="keyword">false</span>);
00084                     enableProjectControls(<span class="keyword">false</span>);
00085                 }
00086                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (role.Equals(PMTUserRole.Client))
00087                 {
00088                     <span class="comment">// get all projectes assigned to a client</span>
00089                     DBDriver db = <span class="keyword">new</span> DBDriver();
00090                     db.Query = 
00091                         <span class="stringliteral">"select * from projects p, clients c\n"</span>
00092                         + <span class="stringliteral">"where p.id = c.projectID\n"</span>
00093                         + <span class="stringliteral">"and c.clientID = @id;"</span>;
00094                     db.addParam(<span class="stringliteral">"@id"</span>, userID);
00095 
00096                     DataSet ds = <span class="keyword">new</span> DataSet();
00097                     db.createAdapter().Fill(ds); 
00098 
00099                     <span class="comment">//create a datatable to fill the dropdown list from</span>
00100                     DataTable dt=<span class="keyword">new</span> DataTable();
00101                     dt=ds.Tables[0];
00102                     <span class="comment">//fill the dropdown list</span>
00103                     ProjectDropDownList.DataSource=dt.DefaultView;
00104                     ProjectDropDownList.DataTextField=<span class="stringliteral">"name"</span>;
00105                     ProjectDropDownList.DataValueField=<span class="stringliteral">"ID"</span>;
00106                     ProjectDropDownList.DataBind();
00107                     ProjectDropDownList.Items.Insert(0,<span class="stringliteral">""</span>);
00108 
00109                     enableModuleControls(<span class="keyword">false</span>);
00110                     enableTaskControls(<span class="keyword">false</span>);
00111                 }
00112             }
00113 
00114             ReportPanel.Visible = <span class="keyword">false</span>;
00115         }
00116 
00117 <span class="preprocessor">        #region Web Form Designer generated code</span>
00118 <span class="preprocessor"></span>        override <span class="keyword">protected</span> <span class="keywordtype">void</span> OnInit(EventArgs e)
00119         {
00120             <span class="comment">//</span>
00121             <span class="comment">// CODEGEN: This call is required by the ASP.NET Web Form Designer.</span>
00122             <span class="comment">//</span>
00123             InitializeComponent();
00124             base.OnInit(e);
00125         }
00126         
<a name="l00131"></a><a class="code" href="classPMT_1_1AllUsers_1_1Reports.html#PMT_1_1AllUsers_1_1Reportsd1">00131</a>         <span class="keyword">private</span> <span class="keywordtype">void</span> InitializeComponent()
00132         {    
00133             <span class="keyword">this</span>.ProjectDropDownList.SelectedIndexChanged += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.ProjectDropDownList_SelectedIndexChanged);
00134             <span class="keyword">this</span>.ViewProjectButton.Click += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.ViewReportButton_Click);
00135             <span class="keyword">this</span>.ModuleDropDownList.SelectedIndexChanged += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.ModuleDropDownList_SelectedIndexChanged);
00136             <span class="keyword">this</span>.ViewModuleButton.Click += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.ViewReportButton_Click);
00137             <span class="keyword">this</span>.TaskDropDownList.SelectedIndexChanged += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.TaskDropDownList_SelectedIndexChanged);
00138             <span class="keyword">this</span>.ViewTaskButton.Click += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.ViewReportButton_Click);
00139             <span class="keyword">this</span>.Load += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.Page_Load);
00140 
00141         }
00142 <span class="preprocessor">        #endregion</span>
00143 <span class="preprocessor"></span>
<a name="l00149"></a><a class="code" href="classPMT_1_1AllUsers_1_1Reports.html#PMT_1_1AllUsers_1_1Reportsd2">00149</a>         <span class="keyword">private</span> <span class="keywordtype">void</span> ViewReportButton_Click(object sender, System.EventArgs e)
00150         {
00151             string buttonID = ((Button)sender).ID;
00152 
00153             <span class="keywordflow">if</span> (!Page.IsValid)
00154                 <span class="keywordflow">return</span>;
00155 
00156             DataSet ds = <span class="keyword">new</span> DataSet();
00157             string role = Request.Cookies[<span class="stringliteral">"user"</span>][<span class="stringliteral">"role"</span>];
00158 
00159             <span class="keywordflow">if</span> ( buttonID.Equals( <span class="stringliteral">"ViewProjectButton"</span> ) )
00160             {
00161                 ds = Project.getByID(ProjectDropDownList.SelectedValue);
00162 
00163                 ModuleLabel.Visible = <span class="keyword">false</span>;
00164                 TaskLabel.Visible = <span class="keyword">false</span>;
00165 
00166                 DisplayGrid.DataSource = ds;
00167                 DisplayGrid.DataBind();
00168 
00169                 <span class="comment">// find percent complete</span>
00170                 Project p = <span class="keyword">new</span> Project(DisplayGrid.Items[0].Cells[0].Text);
00171                 DisplayGrid.Items[0].Cells[7].Text = p.PercentComplete;
00172 
00173                 setReportType(ProjectItem.ItemType.PROJECT);
00174             }
00175             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( buttonID.Equals( <span class="stringliteral">"ViewModuleButton"</span> ) )
00176             {
00177                 ds = Module.getByID(ModuleDropDownList.SelectedValue);
00178 
00179                 ModuleLabel.Text = ModuleDropDownList.SelectedItem.Text;
00180                 ModuleLabel.Visible = <span class="keyword">true</span>;
00181                 TaskLabel.Visible = <span class="keyword">false</span>;
00182 
00183                 DisplayGrid.DataSource = ds;
00184                 DisplayGrid.DataBind();
00185 
00186                 <span class="comment">// find percent complete</span>
00187                 Module m = <span class="keyword">new</span> Module(DisplayGrid.Items[0].Cells[0].Text);
00188                 DisplayGrid.Items[0].Cells[7].Text = m.PercentComplete;
00189 
00190                 setReportType(ProjectItem.ItemType.MODULE);
00191             }
00192             <span class="keywordflow">else</span> <span class="comment">//( buttonID.Equals( "ViewTaskButton" ) )</span>
00193             {
00194                 ds = Task.getByID(TaskDropDownList.SelectedValue);
00195 
00196                 <span class="keywordflow">if</span> (!role.Equals(PMTUserRole.Developer))
00197                 {
00198                     ModuleLabel.Visible = <span class="keyword">true</span>;
00199                     ModuleLabel.Text = ModuleDropDownList.SelectedItem.Text;
00200                 }
00201                 TaskLabel.Visible = <span class="keyword">true</span>;
00202                 TaskLabel.Text = TaskDropDownList.SelectedItem.Text;
00203 
00204                 DisplayGrid.DataSource = ds;
00205                 DisplayGrid.DataBind();
00206 
00207                 <span class="comment">// find percent complete</span>
00208                 Task t = <span class="keyword">new</span> Task(DisplayGrid.Items[0].Cells[0].Text);
00209                 DisplayGrid.Items[0].Cells[7].Text = t.PercentComplete;
00210 
00211                 setReportType(ProjectItem.ItemType.TASK);
00212             }
00213             <span class="keywordflow">if</span> (!role.Equals(PMTUserRole.Developer))
00214             {
00215                 ProjectLabel.Text = ProjectDropDownList.SelectedItem.Text;
00216             }
00217 
00218             ReportPanel.Visible = <span class="keyword">true</span>;
00219             DisplayGrid.Visible = <span class="keyword">true</span>;
00220         }
00221 
00222 
00223         <span class="keyword">private</span> <span class="keywordtype">void</span> ProjectDropDownList_SelectedIndexChanged(object sender, System.EventArgs e)
00224         {
00225             <span class="comment">//create a data set</span>
00226             DataSet ds = Module.getModulesDataSet(ProjectDropDownList.SelectedValue);
00227 
00228             DataTable dt=<span class="keyword">new</span> DataTable();
00229             dt=ds.Tables[0];
00230 
00231             enableProjectControls(<span class="keyword">true</span>);
00232             enableModuleControls(<span class="keyword">true</span>);
00233 
00234             <span class="comment">//fill the dropdown list</span>
00235             ModuleDropDownList.DataSource=dt.DefaultView;
00236             ModuleDropDownList.DataTextField=<span class="stringliteral">"name"</span>;
00237             ModuleDropDownList.DataValueField=<span class="stringliteral">"ID"</span>;
00238             ModuleDropDownList.DataBind();
00239             ModuleDropDownList.Items.Insert(0,<span class="stringliteral">""</span>);
00240 
00241             <span class="comment">// disable and clear the task drop down</span>
00242             enableTaskControls(<span class="keyword">false</span>);
00243             <span class="keywordflow">if</span> (TaskDropDownList.Items.Count &gt; 0)
00244                 TaskDropDownList.Items.Clear();
00245         }
00246 
00247         <span class="keyword">private</span> <span class="keywordtype">void</span> ModuleDropDownList_SelectedIndexChanged(object sender, System.EventArgs e)
00248         {
00249             DataSet ds = Task.getTasksDataSet(ModuleDropDownList.SelectedValue);
00250 
00251             <span class="comment">//create a datatable to fill the dropdown list from</span>
00252             DataTable dt = <span class="keyword">new</span> DataTable();
00253             dt=ds.Tables[0];
00254 
00255             enableModuleControls(<span class="keyword">true</span>);
00256             enableTaskControls(<span class="keyword">true</span>);
00257 
00258             <span class="comment">//fill the dropdown list</span>
00259             TaskDropDownList.Enabled = <span class="keyword">true</span>;
00260             TaskDropDownList.DataSource=dt.DefaultView;
00261             TaskDropDownList.DataTextField=<span class="stringliteral">"name"</span>;
00262             TaskDropDownList.DataValueField=<span class="stringliteral">"ID"</span>;
00263             TaskDropDownList.DataBind();
00264             TaskDropDownList.Items.Insert(0,<span class="stringliteral">""</span>);
00265         }
00266 
00267         <span class="keyword">private</span> <span class="keywordtype">void</span> TaskDropDownList_SelectedIndexChanged(object sender, System.EventArgs e)
00268         {
00269             enableTaskControls(<span class="keyword">true</span>);
00270         }
00271 
00272         <span class="keyword">private</span> <span class="keywordtype">void</span> setReportType(string type)
00273         {
00274             <span class="keywordflow">if</span> (type.Equals(ProjectItem.ItemType.TASK))
00275                 <span class="keywordflow">return</span>;
00276 
00277             HyperLinkColumn col = <span class="keyword">new</span> HyperLinkColumn();
00278             col.DataTextField = <span class="stringliteral">"name"</span>;
00279             col.DataNavigateUrlField = <span class="stringliteral">"id"</span>;
00280 
00281             <span class="comment">// set item type to be displayed</span>
00282             string item = <span class="stringliteral">""</span>;
00283 
00284             <span class="keywordflow">if</span> (type.Equals(ProjectItem.ItemType.PROJECT))
00285                 item = ProjectItem.ItemType.MODULE;
00286             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(type.Equals(ProjectItem.ItemType.MODULE))
00287                 item = ProjectItem.ItemType.TASK;                
00288 
00289             col.DataNavigateUrlFormatString = Request.ApplicationPath + <span class="stringliteral">"/PM/Projects.aspx?item="</span>+item+<span class="stringliteral">"&amp;id={0}"</span>;
00290             DisplayGrid.Columns.Remove(DisplayGrid.Columns[1]);
00291             DisplayGrid.Columns.AddAt(1, col);
00292         }
00293 
00294         <span class="keyword">private</span> <span class="keywordtype">void</span> enableTaskControls(<span class="keywordtype">bool</span> val)
00295         {
00296             TaskDropDownList.Enabled = val;
00297 
00298             <span class="keywordflow">if</span> (TaskDropDownList.SelectedIndex &gt; 0)
00299             {
00300                 ViewTaskButton.Enabled = val;
00301             }
00302             <span class="keywordflow">else</span>
00303             {
00304                 ViewTaskButton.Enabled = <span class="keyword">false</span>;
00305             }
00306         }
00307 
00308         <span class="keyword">private</span> <span class="keywordtype">void</span> enableModuleControls(<span class="keywordtype">bool</span> val)
00309         {
00310             ModuleDropDownList.Enabled = val;
00311 
00312             <span class="keywordflow">if</span> (ModuleDropDownList.SelectedIndex &gt; 0)
00313             {
00314                 ViewModuleButton.Enabled = val;
00315             }
00316             <span class="keywordflow">else</span>
00317             {
00318                 ViewModuleButton.Enabled = <span class="keyword">false</span>;
00319             }
00320         }
00321 
00322         <span class="keyword">private</span> <span class="keywordtype">void</span> enableProjectControls(<span class="keywordtype">bool</span> val)
00323         {
00324             ProjectDropDownList.Enabled = val;
00325 
00326             <span class="keywordflow">if</span>(ProjectDropDownList.SelectedIndex &gt; 0)
00327             {
00328                 ViewProjectButton.Enabled = val;
00329             }
00330             <span class="keywordflow">else</span>
00331             {
00332                 ViewProjectButton.Enabled = <span class="keyword">false</span>;
00333             }
00334         }
00335 
00336         
00337     }
00338 }
</pre></div><hr><address style="align: right;"><small>
Generated on Sat Aug 5 14:40:47 2006 for PMT by <a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 width=110 height=53>
</a> 1.3.1 using KingsTools</small></address>
</body>
</html>
