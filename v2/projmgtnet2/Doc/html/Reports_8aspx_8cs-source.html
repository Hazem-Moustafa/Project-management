<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>PMT: Reports.aspx.cs Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.1 -->
<h1>Reports.aspx.cs</h1><div class="fragment"><pre>00001 <span class="keyword">using</span> System;
00002 <span class="keyword">using</span> System.Collections;
00003 <span class="keyword">using</span> System.ComponentModel;
00004 <span class="keyword">using</span> System.Data;
00005 <span class="keyword">using</span> System.Data.SqlClient;
00006 <span class="keyword">using</span> System.Drawing;
00007 <span class="keyword">using</span> System.Web;
00008 <span class="keyword">using</span> System.Web.SessionState;
00009 <span class="keyword">using</span> System.Web.UI;
00010 <span class="keyword">using</span> System.Web.UI.WebControls;
00011 <span class="keyword">using</span> System.Web.UI.HtmlControls;
00012 <span class="keyword">using</span> PMTComponents;
00013 <span class="keyword">using</span> PMTDataProvider;
00014 
00015 <span class="keyword">namespace </span>PMT.AllUsers
00016 {
00017     <span class="keyword">public</span> <span class="keyword">class </span>Reports : Page
00018     {
00019         <span class="keyword">protected</span> DropDownList ProjectDropDownList;
00020         <span class="keyword">protected</span> Button ViewProjectButton;
00021         <span class="keyword">protected</span> DropDownList ModuleDropDownList;
00022         <span class="keyword">protected</span> Button ViewModuleButton;
00023         <span class="keyword">protected</span> DropDownList TaskDropDownList;
00024         <span class="keyword">protected</span> Button ViewTaskButton;
00025         <span class="keyword">protected</span> Label ModuleLabel;
00026         <span class="keyword">protected</span> Label TaskLabel;
00027         <span class="keyword">protected</span> Panel ReportPanel;
00028         <span class="keyword">protected</span> Label ProjectLabel;
00029         <span class="keyword">protected</span> string role;
00030         <span class="keyword">protected</span> DataGrid DisplayGrid;
00031         <span class="keyword">protected</span> PlaceHolder phReport;
00032 
00033         <span class="keyword">private</span> <span class="keywordtype">void</span> Page_Load(object sender, System.EventArgs e)
00034         {
00035             <span class="comment">// Put user code to initialize the page here</span>
00036 
00037             <span class="keywordflow">if</span> (!<span class="keyword">this</span>.IsPostBack)
00038             {
00039                 <span class="keywordflow">if</span> (UserRole.Equals(PMTUserRole.Manager))
00040                 {
00041                     IDataProvider data = DataProvider.CreateInstance();
00042                     <span class="comment">//fill the dropdown list</span>
00043                     ProjectDropDownList.DataSource = data.GetProjects();
00044                     ProjectDropDownList.DataTextField=<span class="stringliteral">"name"</span>;
00045                     ProjectDropDownList.DataValueField=<span class="stringliteral">"ID"</span>;
00046                     ProjectDropDownList.DataBind();
00047                     ProjectDropDownList.Items.Insert(0,<span class="stringliteral">""</span>);
00048 
00049                     enableModuleControls(<span class="keyword">false</span>);
00050                     enableTaskControls(<span class="keyword">false</span>);
00051                 }
00052                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (UserRole.Equals(PMTUserRole.Developer))
00053                 {
00054                     <span class="comment">// get all tasks assigned to a developer</span>
00055                     DBDriver db = <span class="keyword">new</span> DBDriver();
00056                     db.Query = <span class="stringliteral">"select t.id, t.name from assignments a, tasks t \n"</span>
00057                         +<span class="stringliteral">"where a.devID = @devID and t.id = a.taskID"</span>;
00058                     db.addParam(<span class="stringliteral">"@devID"</span>, UserID);
00059                     
00060                     DataSet ds = <span class="keyword">new</span> DataSet();
00061                     db.createAdapter().Fill(ds);
00062 
00063                     DataTable dt = <span class="keyword">new</span> DataTable();
00064                     dt = ds.Tables[0];
00065 
00066                     <span class="comment">// display tasks in the drop down list</span>
00067                     TaskDropDownList.DataSource=dt.DefaultView;
00068                     TaskDropDownList.DataTextField=<span class="stringliteral">"name"</span>;
00069                     TaskDropDownList.DataValueField=<span class="stringliteral">"id"</span>;
00070                     TaskDropDownList.DataBind();
00071                     TaskDropDownList.Items.Insert(0,<span class="stringliteral">""</span>);
00072 
00073                     enableModuleControls(<span class="keyword">false</span>);
00074                     enableProjectControls(<span class="keyword">false</span>);
00075                 }
00076                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (UserRole.Equals(PMTUserRole.Client))
00077                 {
00078                     <span class="comment">// get all projectes assigned to a client</span>
00079                     DBDriver db = <span class="keyword">new</span> DBDriver();
00080                     db.Query = 
00081                         <span class="stringliteral">"select * from projects p, clients c\n"</span>
00082                         + <span class="stringliteral">"where p.id = c.projectID\n"</span>
00083                         + <span class="stringliteral">"and c.clientID = @id;"</span>;
00084                     db.addParam(<span class="stringliteral">"@id"</span>, UserID);
00085 
00086                     DataSet ds = <span class="keyword">new</span> DataSet();
00087                     db.createAdapter().Fill(ds); 
00088 
00089                     <span class="comment">//create a datatable to fill the dropdown list from</span>
00090                     DataTable dt=<span class="keyword">new</span> DataTable();
00091                     dt=ds.Tables[0];
00092                     <span class="comment">//fill the dropdown list</span>
00093                     ProjectDropDownList.DataSource=dt.DefaultView;
00094                     ProjectDropDownList.DataTextField=<span class="stringliteral">"name"</span>;
00095                     ProjectDropDownList.DataValueField=<span class="stringliteral">"ID"</span>;
00096                     ProjectDropDownList.DataBind();
00097                     ProjectDropDownList.Items.Insert(0,<span class="stringliteral">""</span>);
00098 
00099                     enableModuleControls(<span class="keyword">false</span>);
00100                     enableTaskControls(<span class="keyword">false</span>);
00101                 }
00102             }
00103 
00104             ReportPanel.Visible = <span class="keyword">false</span>;
00105         }
00106 
00107 <span class="preprocessor">        #region Web Form Designer generated code</span>
00108 <span class="preprocessor"></span>        override <span class="keyword">protected</span> <span class="keywordtype">void</span> OnInit(EventArgs e)
00109         {
00110             <span class="comment">//</span>
00111             <span class="comment">// CODEGEN: This call is required by the ASP.NET Web Form Designer.</span>
00112             <span class="comment">//</span>
00113             InitializeComponent();
00114             base.OnInit(e);
00115         }
00116         
00121         <span class="keyword">private</span> <span class="keywordtype">void</span> InitializeComponent()
00122         {    
00123             <span class="keyword">this</span>.ProjectDropDownList.SelectedIndexChanged += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.ProjectDropDownList_SelectedIndexChanged);
00124             <span class="keyword">this</span>.ViewProjectButton.Click += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.ViewReportButton_Click);
00125             <span class="keyword">this</span>.ModuleDropDownList.SelectedIndexChanged += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.ModuleDropDownList_SelectedIndexChanged);
00126             <span class="keyword">this</span>.ViewModuleButton.Click += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.ViewReportButton_Click);
00127             <span class="keyword">this</span>.TaskDropDownList.SelectedIndexChanged += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.TaskDropDownList_SelectedIndexChanged);
00128             <span class="keyword">this</span>.ViewTaskButton.Click += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.ViewReportButton_Click);
00129             <span class="keyword">this</span>.Load += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.Page_Load);
00130 
00131         }
00132 <span class="preprocessor">        #endregion</span>
00133 <span class="preprocessor"></span>
00137         <span class="keyword">private</span> <span class="keywordtype">void</span> ViewReportButton_Click(object sender, System.EventArgs e)
00138         {
00139             string buttonID = ((Button)sender).ID;
00140 
00141             <span class="keywordflow">if</span> (!Page.IsValid)
00142                 <span class="keywordflow">return</span>;
00143 
00144             IDataProvider data = DataProvider.CreateInstance();
00145             <span class="comment">//DataTable dt = new DataTable();</span>
00146 
00147             <span class="keywordflow">if</span> ( buttonID.Equals( <span class="stringliteral">"ViewProjectButton"</span> ) )
00148             {
00149                 Project project = data.GetProject(Convert.ToInt32(ProjectDropDownList.SelectedValue));
00150 
00151                 ModuleLabel.Visible = <span class="keyword">false</span>;
00152                 TaskLabel.Visible = <span class="keyword">false</span>;
00153 
00154                 Label lbl = <span class="keyword">new</span> Label();
00155                 lbl.Text = project.Name + <span class="stringliteral">" "</span> + project.Description;
00156                 phReport.Controls.Add(lbl);
00157             }
00158             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( buttonID.Equals( <span class="stringliteral">"ViewModuleButton"</span> ) )
00159             {
00160                 <span class="comment">/*</span>
00161 <span class="comment">                dt = Module.getByID(ModuleDropDownList.SelectedValue);</span>
00162 <span class="comment"></span>
00163 <span class="comment">                ModuleLabel.Text = ModuleDropDownList.SelectedItem.Text;</span>
00164 <span class="comment">                ModuleLabel.Visible = true;</span>
00165 <span class="comment">                TaskLabel.Visible = false;</span>
00166 <span class="comment"></span>
00167 <span class="comment">                DisplayGrid.DataSource = ds;</span>
00168 <span class="comment">                DisplayGrid.DataBind();</span>
00169 <span class="comment"></span>
00170 <span class="comment">                // find percent complete</span>
00171 <span class="comment">                Module m = new Module(DisplayGrid.Items[0].Cells[0].Text);</span>
00172 <span class="comment">                DisplayGrid.Items[0].Cells[7].Text = m.PercentComplete;</span>
00173 <span class="comment"></span>
00174 <span class="comment">                setReportType(ProjectItem.ItemType.MODULE);</span>
00175 <span class="comment">                */</span>
00176             }
00177             <span class="keywordflow">else</span> <span class="comment">//( buttonID.Equals( "ViewTaskButton" ) )</span>
00178             {
00179                 <span class="comment">/*</span>
00180 <span class="comment">                dt = Task.getByID(TaskDropDownList.SelectedValue);</span>
00181 <span class="comment"></span>
00182 <span class="comment">                if (!role.Equals(PMTUserRole.Developer))</span>
00183 <span class="comment">                {</span>
00184 <span class="comment">                    ModuleLabel.Visible = true;</span>
00185 <span class="comment">                    ModuleLabel.Text = ModuleDropDownList.SelectedItem.Text;</span>
00186 <span class="comment">                }</span>
00187 <span class="comment">                TaskLabel.Visible = true;</span>
00188 <span class="comment">                TaskLabel.Text = TaskDropDownList.SelectedItem.Text;</span>
00189 <span class="comment"></span>
00190 <span class="comment">                DisplayGrid.DataSource = ds;</span>
00191 <span class="comment">                DisplayGrid.DataBind();</span>
00192 <span class="comment"></span>
00193 <span class="comment">                // find percent complete</span>
00194 <span class="comment">                Task t = new Task(DisplayGrid.Items[0].Cells[0].Text);</span>
00195 <span class="comment">                DisplayGrid.Items[0].Cells[7].Text = t.PercentComplete;</span>
00196 <span class="comment"></span>
00197 <span class="comment">                setReportType(ProjectItem.ItemType.TASK);</span>
00198 <span class="comment">                */</span>
00199             }
00200             <span class="keywordflow">if</span> (!UserRole.Equals(PMTUserRole.Developer))
00201             {
00202                 ProjectLabel.Text = ProjectDropDownList.SelectedItem.Text;
00203             }
00204 
00205             ReportPanel.Visible = <span class="keyword">true</span>;
00206             DisplayGrid.Visible = <span class="keyword">true</span>;
00207         }
00208 
00209 
00210         <span class="keyword">private</span> <span class="keywordtype">void</span> ProjectDropDownList_SelectedIndexChanged(object sender, System.EventArgs e)
00211         {
00212             <span class="comment">/*</span>
00213 <span class="comment">            //create a data set</span>
00214 <span class="comment">            DataSet ds = Module.getModulesDataSet(ProjectDropDownList.SelectedValue);</span>
00215 <span class="comment"></span>
00216 <span class="comment">            DataTable dt=new DataTable();</span>
00217 <span class="comment">            dt=ds.Tables[0];</span>
00218 <span class="comment"></span>
00219 <span class="comment">            enableProjectControls(true);</span>
00220 <span class="comment">            enableModuleControls(true);</span>
00221 <span class="comment"></span>
00222 <span class="comment">            //fill the dropdown list</span>
00223 <span class="comment">            ModuleDropDownList.DataSource=dt.DefaultView;</span>
00224 <span class="comment">            ModuleDropDownList.DataTextField="name";</span>
00225 <span class="comment">            ModuleDropDownList.DataValueField="ID";</span>
00226 <span class="comment">            ModuleDropDownList.DataBind();</span>
00227 <span class="comment">            ModuleDropDownList.Items.Insert(0,"");</span>
00228 <span class="comment"></span>
00229 <span class="comment">            // disable and clear the task drop down</span>
00230 <span class="comment">            enableTaskControls(false);</span>
00231 <span class="comment">            if (TaskDropDownList.Items.Count &gt; 0)</span>
00232 <span class="comment">                TaskDropDownList.Items.Clear();</span>
00233 <span class="comment">                */</span>
00234         }
00235 
00236         <span class="keyword">private</span> <span class="keywordtype">void</span> ModuleDropDownList_SelectedIndexChanged(object sender, System.EventArgs e)
00237         {
00238             <span class="comment">/*</span>
00239 <span class="comment">            DataSet ds = Task.getTasksDataSet(ModuleDropDownList.SelectedValue);</span>
00240 <span class="comment"></span>
00241 <span class="comment">            //create a datatable to fill the dropdown list from</span>
00242 <span class="comment">            DataTable dt = new DataTable();</span>
00243 <span class="comment">            dt=ds.Tables[0];</span>
00244 <span class="comment"></span>
00245 <span class="comment">            enableModuleControls(true);</span>
00246 <span class="comment">            enableTaskControls(true);</span>
00247 <span class="comment"></span>
00248 <span class="comment">            //fill the dropdown list</span>
00249 <span class="comment">            TaskDropDownList.Enabled = true;</span>
00250 <span class="comment">            TaskDropDownList.DataSource=dt.DefaultView;</span>
00251 <span class="comment">            TaskDropDownList.DataTextField="name";</span>
00252 <span class="comment">            TaskDropDownList.DataValueField="ID";</span>
00253 <span class="comment">            TaskDropDownList.DataBind();</span>
00254 <span class="comment">            TaskDropDownList.Items.Insert(0,"");</span>
00255 <span class="comment">            */</span>
00256         }
00257 
00258         <span class="keyword">private</span> <span class="keywordtype">void</span> TaskDropDownList_SelectedIndexChanged(object sender, System.EventArgs e)
00259         {
00260             enableTaskControls(<span class="keyword">true</span>);
00261         }
00262 
00263         <span class="keyword">private</span> <span class="keywordtype">void</span> setReportType(string type)
00264         {
00265             <span class="comment">/*</span>
00266 <span class="comment">            if (type.Equals(ProjectItem.ItemType.TASK))</span>
00267 <span class="comment">                return;</span>
00268 <span class="comment"></span>
00269 <span class="comment">            HyperLinkColumn col = new HyperLinkColumn();</span>
00270 <span class="comment">            col.DataTextField = "name";</span>
00271 <span class="comment">            col.DataNavigateUrlField = "id";</span>
00272 <span class="comment"></span>
00273 <span class="comment">            // set item type to be displayed</span>
00274 <span class="comment">            string item = "";</span>
00275 <span class="comment"></span>
00276 <span class="comment">            if (type.Equals(ProjectItem.ItemType.PROJECT))</span>
00277 <span class="comment">                item = ProjectItem.ItemType.MODULE;</span>
00278 <span class="comment">            else if(type.Equals(ProjectItem.ItemType.MODULE))</span>
00279 <span class="comment">                item = ProjectItem.ItemType.TASK;                </span>
00280 <span class="comment"></span>
00281 <span class="comment">            col.DataNavigateUrlFormatString = Request.ApplicationPath + "/PM/Projects.aspx?item="+item+"&amp;id={0}";</span>
00282 <span class="comment">            DisplayGrid.Columns.Remove(DisplayGrid.Columns[1]);</span>
00283 <span class="comment">            DisplayGrid.Columns.AddAt(1, col);</span>
00284 <span class="comment">            */</span>
00285         }
00286 
00287         <span class="keyword">private</span> <span class="keywordtype">void</span> enableTaskControls(<span class="keywordtype">bool</span> val)
00288         {
00289             TaskDropDownList.Enabled = val;
00290 
00291             <span class="keywordflow">if</span> (TaskDropDownList.SelectedIndex &gt; 0)
00292             {
00293                 ViewTaskButton.Enabled = val;
00294             }
00295             <span class="keywordflow">else</span>
00296             {
00297                 ViewTaskButton.Enabled = <span class="keyword">false</span>;
00298             }
00299         }
00300 
00301         <span class="keyword">private</span> <span class="keywordtype">void</span> enableModuleControls(<span class="keywordtype">bool</span> val)
00302         {
00303             ModuleDropDownList.Enabled = val;
00304 
00305             <span class="keywordflow">if</span> (ModuleDropDownList.SelectedIndex &gt; 0)
00306             {
00307                 ViewModuleButton.Enabled = val;
00308             }
00309             <span class="keywordflow">else</span>
00310             {
00311                 ViewModuleButton.Enabled = <span class="keyword">false</span>;
00312             }
00313         }
00314 
00315         <span class="keyword">private</span> <span class="keywordtype">void</span> enableProjectControls(<span class="keywordtype">bool</span> val)
00316         {
00317             ProjectDropDownList.Enabled = val;
00318 
00319             <span class="keywordflow">if</span>(ProjectDropDownList.SelectedIndex &gt; 0)
00320             {
00321                 ViewProjectButton.Enabled = val;
00322             }
00323             <span class="keywordflow">else</span>
00324             {
00325                 ViewProjectButton.Enabled = <span class="keyword">false</span>;
00326             }
00327         }
00328 
00329 <span class="preprocessor">        #region Properties</span>
00330 <span class="preprocessor"></span>        <span class="keyword">public</span> <span class="keywordtype">int</span> UserID
00331         {
00332             get {   <span class="keywordflow">return</span> Convert.ToInt32(Request.Cookies[<span class="stringliteral">"user"</span>][<span class="stringliteral">"id"</span>]);   }
00333         }
00334         <span class="keyword">public</span> PMTUserRole UserRole
00335         {
00336             get {   <span class="keywordflow">return</span> (PMTUserRole)Enum.Parse(typeof(PMTUserRole), Request.Cookies[<span class="stringliteral">"user"</span>][<span class="stringliteral">"role"</span>]);   }
00337         }
00338 <span class="preprocessor">        #endregion</span>
00339 <span class="preprocessor"></span>    }
00340 }
</pre></div><hr><address style="align: right;"><small>
Generated on Sun Aug 6 23:06:03 2006 for PMT by <a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 width=110 height=53>
</a> 1.3.1 using KingsTools</small></address>
</body>
</html>
