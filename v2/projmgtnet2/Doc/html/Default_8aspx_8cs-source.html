<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>PMT: D:/My Documents/Visual Studio Projects/projmgtnet2/AllUsers/Msg/Default.aspx.cs Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.1 -->
<h1>D:/My Documents/Visual Studio Projects/projmgtnet2/AllUsers/Msg/Default.aspx.cs</h1><div class="fragment"><pre>00001 <span class="keyword">using</span> System;
00002 <span class="keyword">using</span> System.Collections;
00003 <span class="keyword">using</span> System.ComponentModel;
00004 <span class="keyword">using</span> System.Data;
00005 <span class="keyword">using</span> System.Drawing;
00006 <span class="keyword">using</span> System.Web;
00007 <span class="keyword">using</span> System.Web.SessionState;
00008 <span class="keyword">using</span> System.Web.UI;
00009 <span class="keyword">using</span> System.Web.UI.WebControls;
00010 <span class="keyword">using</span> System.Web.UI.HtmlControls;
00011 <span class="keyword">using</span> PMTComponents;
00012 
00013 <span class="keyword">namespace </span>PMT.AllUsers.Msg
00014 {
<a name="l00018"></a><a class="code" href="classPMT_1_1AllUsers_1_1Msg_1_1Messages.html">00018</a>     <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="classPMT_1_1AllUsers_1_1Msg_1_1Messages.html">Messages</a> : System.Web.UI.Page
00019     {
00020         <span class="keyword">protected</span> System.Web.UI.WebControls.Panel ComposePanel;
00021         <span class="keyword">protected</span> System.Web.UI.HtmlControls.HtmlTextArea MessageTextBox;
00022         <span class="keyword">protected</span> System.Web.UI.WebControls.ListBox ToListBox;
00023         <span class="keyword">protected</span> System.Web.UI.WebControls.ListBox ContactsListBox;
00024         <span class="keyword">protected</span> System.Web.UI.WebControls.TextBox SubjectTextBox;
00025         <span class="keyword">protected</span> System.Web.UI.WebControls.RequiredFieldValidator SubjectRequiredFieldValidator;
00026         <span class="keyword">protected</span> System.Web.UI.WebControls.RequiredFieldValidator MessageRequiredFieldValidator;
00027         <span class="keyword">protected</span> System.Web.UI.WebControls.Button SendButton;
00028         <span class="keyword">protected</span> System.Web.UI.WebControls.ValidationSummary ComposeValidationSummary;
00029         <span class="keyword">protected</span> System.Web.UI.WebControls.Panel MessagesPanel;
00030         <span class="keyword">protected</span> System.Web.UI.WebControls.DataGrid MessagesDataGrid;
00031         <span class="keyword">protected</span> System.Web.UI.WebControls.CustomValidator ToCustomValidator;
00032         <span class="keyword">protected</span> System.Web.UI.WebControls.LinkButton UpdateLinkButton;
00033         <span class="keyword">protected</span> System.Web.UI.WebControls.LinkButton ComposeLinkButton;
00034     
00035         <span class="keyword">private</span> <span class="keywordtype">void</span> Page_Load(object sender, System.EventArgs e)
00036         {
00037             DBDriver myDB=<span class="keyword">new</span> DBDriver();
00038             <span class="comment">// Put user code to initialize the page here</span>
00039 
00040             string role = Request.Cookies[<span class="stringliteral">"user"</span>][<span class="stringliteral">"role"</span>];
00041             string userID = Request.Cookies[<span class="stringliteral">"user"</span>][<span class="stringliteral">"id"</span>];
00042 
00043             <span class="comment">// fill the contact list</span>
00044             <span class="keywordflow">if</span> (!<span class="keyword">this</span>.IsPostBack)
00045             {
00046                 <span class="keywordflow">if</span> (role.Equals(User))
00047                 {
00048                     myDB.Query=
00049                         <span class="stringliteral">"select u.userName as userName, u.id as ID\n"</span>
00050                         + <span class="stringliteral">"from users u, clients c\n"</span>
00051                         + <span class="stringliteral">"where u.id = c.managerID\n"</span>
00052                         + <span class="stringliteral">"and c.clientID = @clientID;"</span>;
00053                     myDB.addParam(<span class="stringliteral">"@clientID"</span>, userID);
00054                 }
00055                 <span class="keywordflow">else</span>
00056                 {
00057                     myDB.Query=<span class="stringliteral">"select userName, id from users;"</span>;
00058                 }
00059                 DataSet ds2=<span class="keyword">new</span> DataSet();
00060                 myDB.createAdapter().Fill(ds2);
00061                 <span class="comment">//create a datatable to fill the dropdown list from</span>
00062                 DataTable dt=ds2.Tables[0];
00063                 <span class="comment">//fill the Contacts list box</span>
00064                 ContactsListBox.DataSource=dt.DefaultView;
00065                 ContactsListBox.DataTextField=<span class="stringliteral">"userName"</span>;
00066                 ContactsListBox.DataValueField=<span class="stringliteral">"id"</span>;
00067                 ContactsListBox.DataBind();
00068 
00069                 <span class="comment">// fill the inbox</span>
00070                 myDB.Query=<span class="stringliteral">"select m.ID messID, u.userName sender, m.subject subject, m.timestamp date, m.ID id from users u, messages m, recipients r"</span>
00071                     +<span class="stringliteral">" where r.recipientID=@me and m.ID=r.messageID and u.ID=m.senderID;"</span>;
00072                 myDB.addParam(<span class="stringliteral">"@me"</span>, Request.Cookies[<span class="stringliteral">"user"</span>][<span class="stringliteral">"id"</span>]);
00073 
00074                 DataSet ds=<span class="keyword">new</span> DataSet();
00075                 <span class="comment">//initialize the data adapter</span>
00076                 <span class="comment">//fill the dataset</span>
00077                 myDB.createAdapter().Fill(ds);
00078                 <span class="comment">//fill the display grid</span>
00079                 <span class="keyword">this</span>.MessagesDataGrid.DataSource=ds;
00080                 <span class="keyword">this</span>.MessagesDataGrid.DataBind();
00081             }
00082         }
00083 
00084 <span class="preprocessor">        #region Web Form Designer generated code</span>
00085 <span class="preprocessor"></span>        override <span class="keyword">protected</span> <span class="keywordtype">void</span> OnInit(EventArgs e)
00086         {
00087             <span class="comment">//</span>
00088             <span class="comment">// CODEGEN: This call is required by the ASP.NET Web Form Designer.</span>
00089             <span class="comment">//</span>
00090             InitializeComponent();
00091             base.OnInit(e);
00092         }
00093         
<a name="l00098"></a><a class="code" href="classPMT_1_1AllUsers_1_1Msg_1_1Messages.html#PMT_1_1AllUsers_1_1Msg_1_1Messagesd1">00098</a>         <span class="keyword">private</span> <span class="keywordtype">void</span> InitializeComponent()
00099         {    
00100             <span class="keyword">this</span>.ComposeLinkButton.Click += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.ComposeLinkButton_Click);
00101             <span class="keyword">this</span>.UpdateLinkButton.Click += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.UpdateLinkButton_Click);
00102             <span class="keyword">this</span>.ToListBox.SelectedIndexChanged += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.ToListBox_SelectedIndexChanged);
00103             <span class="keyword">this</span>.ContactsListBox.SelectedIndexChanged += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.ContactsListBox_SelectedIndexChanged);
00104             <span class="keyword">this</span>.ToCustomValidator.ServerValidate += <span class="keyword">new</span> System.Web.UI.WebControls.ServerValidateEventHandler(<span class="keyword">this</span>.ToCustomValidate);
00105             <span class="keyword">this</span>.SendButton.Click += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.SendButton_Click);
00106             <span class="keyword">this</span>.MessagesDataGrid.DeleteCommand += <span class="keyword">new</span> System.Web.UI.WebControls.DataGridCommandEventHandler(<span class="keyword">this</span>.MessagesDataGrid_DeleteCommand);
00107             <span class="keyword">this</span>.Load += <span class="keyword">new</span> System.EventHandler(<span class="keyword">this</span>.Page_Load);
00108 
00109         }
00110 <span class="preprocessor">        #endregion</span>
00111 <span class="preprocessor"></span>
<a name="l00115"></a><a class="code" href="classPMT_1_1AllUsers_1_1Msg_1_1Messages.html#PMT_1_1AllUsers_1_1Msg_1_1Messagesd2">00115</a>         <span class="keyword">private</span> <span class="keywordtype">void</span> ContactsListBox_SelectedIndexChanged(object sender, System.EventArgs e)
00116         {
00117             ListItem li = ContactsListBox.SelectedItem;
00118             ToListBox.Items.Add(li);
00119             li.Selected = <span class="keyword">false</span>;
00120             ContactsListBox.Items.Remove(li);
00121         }
00122 
<a name="l00126"></a><a class="code" href="classPMT_1_1AllUsers_1_1Msg_1_1Messages.html#PMT_1_1AllUsers_1_1Msg_1_1Messagesd3">00126</a>         <span class="keyword">private</span> <span class="keywordtype">void</span> ToListBox_SelectedIndexChanged(object sender, System.EventArgs e)
00127         {
00128             ListItem li = ToListBox.SelectedItem;
00129             ContactsListBox.Items.Add(li);
00130             li.Selected = <span class="keyword">false</span>;
00131             ToListBox.Items.Remove(li);
00132         }
00133 
<a name="l00137"></a><a class="code" href="classPMT_1_1AllUsers_1_1Msg_1_1Messages.html#PMT_1_1AllUsers_1_1Msg_1_1Messagesd4">00137</a>         <span class="keyword">private</span> <span class="keywordtype">void</span> ComposeLinkButton_Click(object sender, System.EventArgs e)
00138         {
00139             ComposePanel.Visible = <span class="keyword">true</span>;
00140             MessagesPanel.Visible = <span class="keyword">false</span>;
00141             ComposeLinkButton.Visible = <span class="keyword">false</span>;
00142             UpdateLinkButton.Visible = <span class="keyword">false</span>;
00143         }
00144 
<a name="l00148"></a><a class="code" href="classPMT_1_1AllUsers_1_1Msg_1_1Messages.html#PMT_1_1AllUsers_1_1Msg_1_1Messagesd5">00148</a>         <span class="keyword">private</span> <span class="keywordtype">void</span> SendButton_Click(object sender, System.EventArgs e)
00149         {
00150             <span class="keywordflow">if</span> (!Page.IsValid)
00151                 <span class="keywordflow">return</span>;
00152 
00153             <span class="comment">//string from = user.Name;</span>
00154 
00155             ArrayList toList = <span class="keyword">new</span> ArrayList();
00156             foreach (ListItem item in ToListBox.Items)
00157             {
00158                 toList.Add(item.Value);
00159             }
00160 
00161             <span class="comment">//Message msg = new Message(from, toList, message);</span>
00162 
00163             string time=DateTime.Now.ToString(<span class="stringliteral">"MM/dd/yyyy hh:mm:ss"</span>);
00164             <span class="comment">// insert into database</span>
00165             DBDriver myDB=<span class="keyword">new</span> DBDriver();
00166             myDB.Query=
00167                 <span class="stringliteral">"insert into messages (SenderID, Subject, Body, timestamp)\n"</span>
00168                 + <span class="stringliteral">"values (@sender, @subject, @body, @time);"</span>;
00169             myDB.addParam(<span class="stringliteral">"@sender"</span>, Request.Cookies[<span class="stringliteral">"user"</span>][<span class="stringliteral">"id"</span>]);
00170             myDB.addParam(<span class="stringliteral">"@subject"</span>, <span class="keyword">this</span>.SubjectTextBox.Text);
00171             myDB.addParam(<span class="stringliteral">"@body"</span>, <span class="keyword">this</span>.MessageTextBox.InnerText);
00172             myDB.addParam(<span class="stringliteral">"@time"</span>, time);
00173             myDB.nonQuery();
00174             
00175             myDB.Query=<span class="stringliteral">"select id from messages where timestamp=@time;"</span>;
00176             myDB.addParam(<span class="stringliteral">"@time"</span>, time);
00177             <span class="keywordtype">int</span> mID=Convert.ToInt32(myDB.scalar());
00178 
00179             <span class="comment">//insert into the recipients table as well</span>
00180             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;<span class="keyword">this</span>.ToListBox.Items.Count;i++)
00181             {
00182                 myDB.Query=<span class="stringliteral">"insert into recipients (MessageID, RecipientID, Timestamp) values (@id, @recipient, @time);"</span>;
00183                 myDB.addParam(<span class="stringliteral">"@id"</span>, mID);
00184                 myDB.addParam(<span class="stringliteral">"@recipient"</span>, <span class="keyword">this</span>.ToListBox.Items[i].Value);
00185                 myDB.addParam(<span class="stringliteral">"@time"</span>, time);
00186                 myDB.nonQuery();
00187             }
00188 
00189             Server.Transfer(Request.Url.AbsolutePath);
00190         }
00191 
00192         <span class="keyword">private</span> <span class="keywordtype">void</span> ToCustomValidate(object source, System.Web.UI.WebControls.ServerValidateEventArgs args)
00193         {
00194             <span class="keywordflow">if</span> (ToListBox.Items.Count &gt; 0)
00195                 args.IsValid = <span class="keyword">true</span>;
00196             <span class="keywordflow">else</span>
00197                 args.IsValid = <span class="keyword">false</span>;
00198         }
00199 
00200         <span class="keyword">private</span> <span class="keywordtype">void</span> MessagesDataGrid_DeleteCommand(object source, System.Web.UI.WebControls.DataGridCommandEventArgs e)
00201         {
00202             <span class="comment">//add appropriate warning popup and Database delete statement here</span>
00203           string delID=<span class="keyword">this</span>.MessagesDataGrid.Items[e.Item.ItemIndex].Cells[0].Text;
00204           DBDriver myDB=<span class="keyword">new</span> DBDriver();
00205           myDB.Query=<span class="stringliteral">"delete from recipients where recipientID=@rID and MessageID=@mID;"</span>;
00206           myDB.addParam(<span class="stringliteral">"@rID"</span>, Request.Cookies[<span class="stringliteral">"user"</span>][<span class="stringliteral">"id"</span>]);
00207           myDB.addParam(<span class="stringliteral">"@mID"</span>, delID);
00208           myDB.nonQuery();
00209           Response.Redirect(Request.Url.AbsolutePath);
00210         }
00211 
<a name="l00215"></a><a class="code" href="classPMT_1_1AllUsers_1_1Msg_1_1Messages.html#PMT_1_1AllUsers_1_1Msg_1_1Messagesd8">00215</a>         <span class="keyword">private</span> <span class="keywordtype">void</span> UpdateLinkButton_Click(object sender, System.EventArgs e)
00216         {
00217             Server.Transfer(Request.Url.AbsolutePath);
00218         }
00219     }
00220 }
</pre></div><hr><address style="align: right;"><small>
Generated on Sat Aug 5 14:40:47 2006 for PMT by <a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 width=110 height=53>
</a> 1.3.1 using KingsTools</small></address>
</body>
</html>
